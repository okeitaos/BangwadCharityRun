<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ThaiRun Face Sync ‚Äì Realtime</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">

<div class="max-w-6xl mx-auto space-y-6">

  <!-- HEADER -->
  <h1 class="text-4xl font-bold text-yellow-400 text-center">
    üß† ThaiRun Face Sync ‚Äì Realtime
  </h1>

  <!-- STATS -->
  <div class="bg-slate-800 rounded-xl p-6 grid md:grid-cols-4 gap-4 text-center">
    <div>
      <div class="text-gray-400 text-sm">Total</div>
      <div id="total" class="text-3xl font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Synced</div>
      <div id="synced" class="text-3xl font-bold text-green-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Remaining</div>
      <div id="remaining" class="text-3xl font-bold text-red-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Rate</div>
      <div id="rate" class="text-3xl font-bold">0 / min</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div class="flex justify-between text-sm text-gray-300">
      <div id="statusText">Idle</div>
      <div id="percentText">0%</div>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-4">
      <div id="progressBar"
        class="bg-green-400 h-4 rounded-full transition-all duration-300"
        style="width:0%">
      </div>
    </div>
    <div class="text-sm text-gray-400">
      Elapsed: <span id="elapsed">0s</span>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="flex flex-wrap gap-3 justify-center">
    <button id="startBtn" class="bg-green-600 px-5 py-2 rounded">‚ñ∂ Start</button>
    <button id="pauseBtn" class="bg-yellow-500 px-5 py-2 rounded">‚è∏ Pause</button>
    <button id="resumeBtn" class="bg-green-500 px-5 py-2 rounded">‚ñ∂ Resume</button>
    <button id="stopBtn" class="bg-red-600 px-5 py-2 rounded">‚èπ Stop</button>
    <button id="refreshBtn" class="bg-blue-600 px-5 py-2 rounded">üîÑ Refresh</button>
    <button id="bigBtn" class="bg-purple-600 px-5 py-2 rounded">üñ• Big Screen</button>
  </div>

  <!-- LOG -->
  <div class="bg-slate-800 rounded-xl p-4 h-64 overflow-auto text-sm" id="logBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://localhost:3000";
const SYNC_INTERVAL = 1000;   // sync ‡∏ä‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå
const STATUS_INTERVAL = 500;  // üî• realtime
/* ========================================= */

// DOM refs
const totalEl = document.getElementById("total");
const syncedEl = document.getElementById("synced");
const remainingEl = document.getElementById("remaining");
const rateEl = document.getElementById("rate");
const elapsedEl = document.getElementById("elapsed");
const statusText = document.getElementById("statusText");
const percentText = document.getElementById("percentText");
const progressBar = document.getElementById("progressBar");
const logBox = document.getElementById("logBox");

// state
let syncing = false;
let paused = false;
let startTime = null;
let lastSynced = 0;
let syncTimer = null;
let statusTimer = null;

// buttons
document.getElementById("startBtn").onclick = startSync;
document.getElementById("pauseBtn").onclick = pauseSync;
document.getElementById("resumeBtn").onclick = resumeSync;
document.getElementById("stopBtn").onclick = stopSync;
document.getElementById("refreshBtn").onclick = refreshOnce;
document.getElementById("bigBtn").onclick = toggleBig;

/* ================= LOG ================= */
function log(msg) {
  const el = document.createElement("div");
  el.innerText = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CONTROL ================= */
function startSync() {
  if (syncing) return;
  syncing = true;
  paused = false;
  startTime = Date.now();
  lastSynced = 0;
  statusText.innerText = "Syncing‚Ä¶";
  log("üöÄ Start Sync");

  runSyncLoop();
  startStatusLoop();
}

function pauseSync() {
  paused = true;
  statusText.innerText = "Paused";
  log("‚è∏ Paused");
}

function resumeSync() {
  if (!syncing) return;
  paused = false;
  statusText.innerText = "Syncing‚Ä¶";
  log("‚ñ∂ Resume");
}

function stopSync() {
  syncing = false;
  paused = false;

  if (syncTimer) clearTimeout(syncTimer);
  stopStatusLoop();

  statusText.innerText = "Stopped";
  log("‚èπ Stopped");
}

/* ================= SYNC LOOP ================= */
function runSyncLoop() {
  if (!syncing) return;

  if (!paused) {
    fetch(`${API_BASE}/sync`, { method: "POST" })
      .catch(() => {
        log("‚ùå Sync error");
        stopSync();
      });
  }

  syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
}

/* ================= REALTIME STATUS LOOP ================= */
function startStatusLoop() {
  stopStatusLoop(); // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô

  statusTimer = setInterval(async () => {
    try {
      const res = await fetch(`${API_BASE}/sync/status`);
      const d = await res.json();

      totalEl.innerText = d.total;
      syncedEl.innerText = d.synced;
      remainingEl.innerText = d.remaining;

      const percent = d.total
        ? Math.round((d.synced / d.total) * 100)
        : 0;

      progressBar.style.width = percent + "%";
      percentText.innerText = percent + "%";

      if (startTime) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        elapsedEl.innerText = elapsed + "s";
      }

      const rate = d.synced - lastSynced;
      rateEl.innerText = rate * 120 + " / min"; // 500ms ‚Üí x120
      lastSynced = d.synced;

      if (d.done && syncing) {
        log("üéâ Completed");
        statusText.innerText = "Completed";
        syncing = false;
        stopStatusLoop();
      }

    } catch {
      log("‚ö†Ô∏è Status fetch failed");
    }
  }, STATUS_INTERVAL);
}

function stopStatusLoop() {
  if (statusTimer) {
    clearInterval(statusTimer);
    statusTimer = null;
  }
}

/* ================= EXTRA ================= */
function refreshOnce() {
  log("üîÑ Manual refresh");
  startStatusLoop();
}

function toggleBig() {
  document.body.classList.toggle("text-2xl");
  log("üñ• Big Screen toggle");
}
</script>

</body>
</html>
