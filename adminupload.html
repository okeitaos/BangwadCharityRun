<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõ†Ô∏è Admin Upload Manager</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Prompt, sans-serif;
  background:#0f172a;
  color:#fff;
  padding:20px;
  text-align:center;
}
h1 { color:#facc15; }
table {
  width:95%;
  max-width:900px;
  margin:auto;
  border-collapse:collapse;
  background:rgba(255,255,255,.05);
}
th,td {
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
}
th { background:rgba(255,255,255,.1); }
tr:hover { background:rgba(255,255,255,.08); }

button {
  padding:6px 12px;
  border-radius:20px;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
.btn-view { background:#2563eb;color:#fff; }
.btn-delete { background:#dc2626;color:#fff; }
.btn-back { background:#475569;color:#fff;margin-top:20px; }

#gallery { display:none; margin-top:20px; }
.thumb {
  width:150px;height:150px;
  object-fit:cover;
  margin:6px;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body>
<h1>üõ†Ô∏è Admin Upload Manager</h1>

<div id="userTableSection">
<table>
<thead>
<tr>
<th>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
<th>‡∏ä‡∏∑‡πà‡∏≠</th>
<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ</th>
<th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="userList">
<tr><td colspan="4">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
</tbody>
</table>
</div>

<div id="gallery">
<h2 id="userHeader"></h2>
<div id="imageGrid"></div>
<br>
<button class="btn-delete" onclick="deleteAllFromUser()">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<br><br>
<button class="btn-back" onclick="backToUserList()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // ‚ö†Ô∏è admin only
const BUCKET = "gallery";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

let allUsers = [];
let currentUserId = "";
let currentUserName = "";

/* =====================================
   ‚úÖ LOAD USERS (‡πÅ‡∏Å‡πâ LIMIT 1000 ‡πÅ‡∏•‡πâ‡∏ß)
   ===================================== */
async function loadUsers() {
  let page = 0;
  let pageSize = 1000;
  let rows = [];
  let hasMore = true;

  while (hasMore) {
    const { data, error } = await sb
      .from("file_hashes")
      .select("user_id, profile_name, profile_pic")
      .range(page * pageSize, (page + 1) * pageSize - 1);

    if (error) {
      alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      console.error(error);
      return;
    }

    rows.push(...data);
    hasMore = data.length === pageSize;
    page++;
  }

  // ‡∏£‡∏ß‡∏° user ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
  const userMap = new Map();
  rows.forEach(r => {
    if (!userMap.has(r.user_id)) {
      userMap.set(r.user_id, {
        profile_name: r.profile_name || r.user_id,
        profile_pic: r.profile_pic || "",
        files_count: 0
      });
    }
  });

  // ‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å storage
  await Promise.all(
    [...userMap.keys()].map(async uid => {
      const { data } = await sb.storage
        .from(BUCKET)
        .list(`${uid}/`, { limit: 10000 });

      userMap.get(uid).files_count = data?.length || 0;
    })
  );

  allUsers = [...userMap.entries()];
  renderUserTable();
}

/* =====================================
   TABLE
   ===================================== */
function renderUserTable() {
  const tbody = document.getElementById("userList");
  tbody.innerHTML = "";

  allUsers.forEach(([uid, info]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <img src="${info.profile_pic}" width="40" height="40"
             style="border-radius:50%" 
             onerror="this.src='https://via.placeholder.com/40'">
      </td>
      <td>${info.profile_name}</td>
      <td>${info.files_count}</td>
      <td>
        <button class="btn-view"
          onclick="viewUser('${uid}','${info.profile_name}')">
          ‡∏î‡∏π‡∏£‡∏π‡∏õ
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =====================================
   VIEW USER
   ===================================== */
async function viewUser(uid, name) {
  currentUserId = uid;
  currentUserName = name;

  document.getElementById("userTableSection").style.display = "none";
  document.getElementById("gallery").style.display = "block";
  document.getElementById("userHeader").innerText = `üì∏ ${name}`;

  const { data } = await sb.storage
    .from(BUCKET)
    .list(`${uid}/`, { limit: 10000 });

  const grid = document.getElementById("imageGrid");
  grid.innerHTML = "";

  if (!data || !data.length) {
    grid.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</p>";
    return;
  }

  data.forEach(f => {
    const img = document.createElement("img");
    img.src = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${uid}/${f.name}`;
    img.className = "thumb";
    img.onclick = () => deleteSingle(uid, f.name);
    grid.appendChild(img);
  });
}

/* =====================================
   DELETE
   ===================================== */
async function deleteSingle(uid, name) {
  if (!confirm(`‡∏•‡∏ö ${name}?`)) return;
  const path = `${uid}/${name}`;
  await sb.storage.from(BUCKET).remove([path]);
  await sb.from("file_hashes").delete().eq("file_path", path);
  viewUser(uid, currentUserName);
}

async function deleteAllFromUser() {
  if (prompt("‡∏û‡∏¥‡∏°‡∏û‡πå CONFIRM") !== "CONFIRM") return;
  const { data } = await sb.storage.from(BUCKET).list(`${currentUserId}/`);
  await sb.storage.from(BUCKET)
    .remove(data.map(f => `${currentUserId}/${f.name}`));
  await sb.from("file_hashes").delete().eq("user_id", currentUserId);
  backToUserList();
}

function backToUserList() {
  document.getElementById("gallery").style.display = "none";
  document.getElementById("userTableSection").style.display = "block";
  loadUsers();
}

loadUsers();
</script>
</body>
</html>
