<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ThaiRun Face Sync ‚Äì PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">

<div id="app" class="max-w-6xl mx-auto space-y-6">

  <!-- HEADER -->
  <h1 class="text-4xl font-bold text-yellow-400 text-center">
    üß† ThaiRun Face Sync ‚Äì PRO
  </h1>

  <!-- STATS -->
  <div class="bg-slate-800 rounded-xl p-6 grid md:grid-cols-4 gap-4 text-center">
    <div>
      <div class="text-gray-400 text-sm">Total</div>
      <div id="total" class="text-3xl font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Synced</div>
      <div id="synced" class="text-3xl font-bold text-green-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Remaining</div>
      <div id="remaining" class="text-3xl font-bold text-red-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Rate</div>
      <div id="rate" class="text-3xl font-bold">0 / min</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div class="flex justify-between text-sm text-gray-300">
      <div id="statusText">Idle</div>
      <div id="percentText">0%</div>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-4">
      <div id="progressBar"
        class="bg-green-400 h-4 rounded-full transition-all duration-300"
        style="width:0%">
      </div>
    </div>
    <div class="text-sm text-gray-400">
      Elapsed: <span id="elapsed">0s</span>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="flex flex-wrap gap-3 justify-center">
    <button id="startBtn" class="bg-green-600 px-5 py-2 rounded">‚ñ∂ Start</button>
    <button id="pauseBtn" class="bg-yellow-500 px-5 py-2 rounded">‚è∏ Pause</button>
    <button id="resumeBtn" class="bg-green-500 px-5 py-2 rounded">‚ñ∂ Resume</button>
    <button id="stopBtn" class="bg-red-600 px-5 py-2 rounded">‚èπ Stop</button>
    <button id="refreshBtn" class="bg-blue-600 px-5 py-2 rounded">üîÑ Refresh</button>
    <button id="bigBtn" class="bg-purple-600 px-5 py-2 rounded">üñ• Big Screen</button>
  </div>

  <!-- LOG -->
  <div class="bg-slate-800 rounded-xl p-4 h-64 overflow-auto text-sm" id="logBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://localhost:3000";
const SYNC_INTERVAL = 800;
const STATUS_INTERVAL = 1200;
/* ========================================= */

// DOM refs (üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
const totalEl = document.getElementById("total");
const syncedEl = document.getElementById("synced");
const remainingEl = document.getElementById("remaining");
const rateEl = document.getElementById("rate");
const elapsedEl = document.getElementById("elapsed");
const statusText = document.getElementById("statusText");
const percentText = document.getElementById("percentText");
const progressBar = document.getElementById("progressBar");
const logBox = document.getElementById("logBox");

// state
let syncing = false;
let paused = false;
let startTime = null;
let lastSynced = 0;
let syncTimer = null;
let statusTimer = null;

// buttons
document.getElementById("startBtn").onclick = startSync;
document.getElementById("pauseBtn").onclick = pauseSync;
document.getElementById("resumeBtn").onclick = resumeSync;
document.getElementById("stopBtn").onclick = stopSync;
document.getElementById("refreshBtn").onclick = refreshStatus;
document.getElementById("bigBtn").onclick = toggleBig;

/* ================= LOG ================= */
function log(msg) {
  const el = document.createElement("div");
  el.innerText = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CONTROL ================= */
function startSync() {
  if (syncing) return;
  syncing = true;
  paused = false;
  startTime = Date.now();
  lastSynced = 0;
  statusText.innerText = "Syncing‚Ä¶";
  log("üöÄ Start Sync");
  loopSync();
  pollStatus();
}

function pauseSync() {
  paused = true;
  statusText.innerText = "Paused";
  log("‚è∏ Paused");
}

function resumeSync() {
  if (!syncing) return;
  paused = false;
  statusText.innerText = "Syncing‚Ä¶";
  log("‚ñ∂ Resume");
}

function stopSync() {
  syncing = false;
  paused = false;
  clearTimeout(syncTimer);
  clearTimeout(statusTimer);
  statusText.innerText = "Stopped";
  log("‚èπ Stopped");
}

/* ================= LOOP ================= */
async function loopSync() {
  if (!syncing) return;

  if (!paused) {
    try {
      await fetch(`${API_BASE}/sync`, { method: "POST" });
    } catch {
      log("‚ùå Sync request failed");
      stopSync();
      return;
    }
  }

  syncTimer = setTimeout(loopSync, SYNC_INTERVAL);
}

/* ================= STATUS ================= */
async function pollStatus() {
  if (!syncing) return;

  try {
    const res = await fetch(`${API_BASE}/sync/status`);
    const d = await res.json();

    totalEl.innerText = d.total;
    syncedEl.innerText = d.synced;
    remainingEl.innerText = d.remaining;

    const percent = d.total
      ? Math.round((d.synced / d.total) * 100)
      : 0;

    progressBar.style.width = percent + "%";
    percentText.innerText = percent + "%";

    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    elapsedEl.innerText = elapsed + "s";

    const rate = d.synced - lastSynced;
    rateEl.innerText = rate * 60 + " / min";
    lastSynced = d.synced;

    if (d.done) {
      syncing = false;
      statusText.innerText = "Completed";
      progressBar.style.width = "100%";
      percentText.innerText = "100%";
      log("üéâ Completed");
      return;
    }

  } catch {
    log("‚ùå Status fetch failed");
  }

  statusTimer = setTimeout(pollStatus, STATUS_INTERVAL);
}

/* ================= EXTRA ================= */
function refreshStatus() {
  log("üîÑ Refresh Status");
  pollStatus();
}

function toggleBig() {
  document.body.classList.toggle("text-2xl");
  log("üñ• Toggle Big Screen");
}
</script>

</body>
</html>
