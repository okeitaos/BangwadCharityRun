<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõ†Ô∏è Admin Upload Manager</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0f172a;
    color: #fff;
    margin: 0;
    padding: 20px;
    text-align: center;
  }
  h1 {
    color: #facc15;
    text-shadow: 0 0 10px rgba(250,204,21,0.4);
  }
  table {
    width: 95%;
    max-width: 900px;
    margin: 20px auto;
    border-collapse: collapse;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  th {
    background: rgba(255,255,255,0.1);
    color: #facc15;
  }
  tr:hover { background: rgba(255,255,255,0.1); }

  button {
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    transition: 0.2s;
  }
  .btn-view { background: #2563eb; }
  .btn-delete { background: #dc2626; }
  .btn-back { background: #475569; margin-top: 20px; }
  .btn-delete:hover { background: #b91c1c; }
  .btn-view:hover { background: #1e3a8a; }

  #gallery {
    display: none;
    margin-top: 30px;
  }
  .thumb {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 10px;
    margin: 5px;
    cursor: pointer;
    transition: 0.2s;
  }
  .thumb:hover { transform: scale(1.05); }
  #userHeader { margin: 20px 0; font-size: 1.2rem; color: #facc15; }
</style>
</head>

<body>
<h1>üõ†Ô∏è Admin Upload Manager</h1>

<div id="userTableSection">
  <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
  <table id="userTable">
    <thead>
      <tr>
        <th>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="userList">
      <tr><td colspan="4">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody>
  </table>
</div>

<div id="gallery">
  <h2 id="userHeader">üì∏ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
  <div id="imageGrid"></div>
  <button class="btn-delete" onclick="deleteAllFromUser()">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</button>
  <button class="btn-back" onclick="backToUserList()">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</button>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // ‡πÉ‡∏ä‡πâ Service Role ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!
const BUCKET = "gallery";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

let currentUserId = "";
let currentUserName = "";
let allUsers = [];

/* ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
// async function loadUsers() {
//   const { data, error } = await sb.from("file_hashes")
//     .select("user_id, profile_name, profile_pic, file_path")
//     .order("user_id");

//   if (error) {
//     alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
//     console.error(error);
//     return;
//   }

//   // ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° user
//   const users = {};
//   data.forEach(row => {
//     if (!users[row.user_id]) {
//       users[row.user_id] = {
//         profile_name: row.profile_name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠",
//         profile_pic: row.profile_pic || "",
//         files: []
//       };
//     }
//     users[row.user_id].files.push(row.file_path);
//   });

//   allUsers = Object.entries(users);
//   renderUserTable();
// }

/* ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
// function renderUserTable() {
//   const tbody = document.getElementById("userList");
//   tbody.innerHTML = "";
//   allUsers.forEach(([uid, info]) => {
//     const tr = document.createElement("tr");
//     tr.innerHTML = `
//       <td><img src="${info.profile_pic}" width="50" height="50" style="border-radius:50%;"></td>
//       <td>${info.profile_name}</td>
//       <td>${info.files.length}</td>
//       <td>
//         <button class="btn-view" onclick="viewUser('${uid}','${info.profile_name}')">‡∏î‡∏π‡∏£‡∏π‡∏õ</button>
//       </td>
//     `;
//     tbody.appendChild(tr);
//   });
// }


async function loadUsers() {
  // ‡∏î‡∏∂‡∏á user_id ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å DB
  const { data: dbUsers } = await sb
    .from("file_hashes")
    .select("user_id");

  const usersFromDB = [...new Set(dbUsers.map(u => u.user_id))];

  // list root folders
  const { data: folders, error } = await sb.storage.from(BUCKET).list("", {
    limit: 10000
  });

  if (error) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
    return;
  }

  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ user ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô DB ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const realFolders = folders.filter(f => usersFromDB.includes(f.name));

  // ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  const userArray = await Promise.all(
    realFolders.map(async folder => {
      const uid = folder.name;

      // ‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô storage
      const { data: files } = await sb.storage.from(BUCKET).list(`${uid}/`, {
        limit: 10000
      });

      const count = files?.length || 0;

      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      const { data: info } = await sb
        .from("file_hashes")
        .select("profile_name, profile_pic")
        .eq("user_id", uid)
        .limit(1)
        .maybeSingle();

      return [
        uid,
        {
          profile_name: info?.profile_name || uid,
          profile_pic: info?.profile_pic || "",
          files_count: count
        }
      ];
    })
  );

  allUsers = userArray;

  renderUserTable();
}


/* ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
function renderUserTable() {
  const tbody = document.getElementById("userList");
  tbody.innerHTML = "";

  allUsers.forEach(([uid, info]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><img src="${info.profile_pic}" width="50" height="50" style="border-radius:50%"></td>
      <td>${info.profile_name}</td>
      <td>${info.files_count}</td>
      <td>
        <button class="btn-view" onclick="viewUser('${uid}','${info.profile_name}')">‡∏î‡∏π‡∏£‡∏π‡∏õ</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

  
/* ‚úÖ ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á user */
async function viewUser(uid, name) {
  currentUserId = uid;
  currentUserName = name;
  document.getElementById("userTableSection").style.display = "none";
  document.getElementById("gallery").style.display = "block";
  document.getElementById("userHeader").innerText = `üì∏ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á: ${name}`;

  const { data, error } = await sb.storage.from(BUCKET).list(`${uid}/`, { limit: 10000 });
  if (error) return alert("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  
  const grid = document.getElementById("imageGrid");
  grid.innerHTML = "";
  if (!data.length) {
    grid.innerHTML = "<p>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</p>";
    return;
  }

  data.forEach(f => {
    const url = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${uid}/${f.name}`;
    const img = document.createElement("img");
    img.src = url;
    img.className = "thumb";
    img.title = f.name;
    img.onclick = () => deleteSingle(uid, f.name);
    grid.appendChild(img);
  });
}

/* üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß */
async function deleteSingle(uid, name) {
  if (!confirm(`‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n${name}`)) return;
  const path = `${uid}/${name}`;
  await sb.storage.from(BUCKET).remove([path]);
  await sb.from("file_hashes").delete().eq("file_path", path);
  alert(`‚úÖ ‡∏•‡∏ö‡∏£‡∏π‡∏õ ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
  await viewUser(uid, currentUserName);
}

/* üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á user */
async function deleteAllFromUser() {
  const confirmText = prompt(`‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á "${currentUserName}"?\n‡∏û‡∏¥‡∏°‡∏û‡πå CONFIRM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:`);
  if (confirmText !== "CONFIRM") return alert("‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");

  const { data } = await sb.storage.from(BUCKET).list(`${currentUserId}/`, { limit: 10000 });
  const files = data.map(f => `${currentUserId}/${f.name}`);

  if (files.length) {
    await sb.storage.from(BUCKET).remove(files);
    await sb.from("file_hashes").delete().eq("user_id", currentUserId);
  }

  alert(`‚úÖ ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á ${currentUserName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
  backToUserList();
}

/* üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å */
function backToUserList() {
  document.getElementById("gallery").style.display = "none";
  document.getElementById("userTableSection").style.display = "block";
  loadUsers();
}

loadUsers();
</script>
</body>
</html>
