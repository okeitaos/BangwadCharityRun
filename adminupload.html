<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõ†Ô∏è Admin Upload Manager</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0f172a;
    color: #fff;
    margin: 0;
    padding: 20px;
    text-align: center;
  }
  h1 {
    color: #facc15;
    text-shadow: 0 0 10px rgba(250,204,21,0.4);
  }
  table {
    width: 95%;
    max-width: 900px;
    margin: 20px auto;
    border-collapse: collapse;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  th {
    background: rgba(255,255,255,0.1);
    color: #facc15;
  }
  tr:hover { background: rgba(255,255,255,0.1); }

  button {
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    transition: 0.2s;
  }
  .btn-view { background: #2563eb; }
  .btn-delete { background: #dc2626; }
  .btn-back { background: #475569; margin-top: 20px; }
  .btn-delete:hover { background: #b91c1c; }
  .btn-view:hover { background: #1e3a8a; }

  #gallery {
    display: none;
    margin-top: 30px;
  }
  .thumb {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 10px;
    margin: 5px;
    cursor: pointer;
    transition: 0.2s;
  }
  .thumb:hover { transform: scale(1.05); }
  #userHeader { margin: 20px 0; font-size: 1.2rem; color: #facc15; }
</style>
</head>

<body>
<h1>üõ†Ô∏è Admin Upload Manager</h1>

<div id="userTableSection">
  <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
  <table>
    <thead>
      <tr>
        <th>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="userList">
      <tr><td colspan="4">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody>
  </table>
</div>

<div id="gallery">
  <h2 id="userHeader">üì∏ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
  <div id="imageGrid"></div>
  <br>
  <button class="btn-delete" onclick="deleteAllFromUser()">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</button>
  <br><br>
  <button class="btn-back" onclick="backToUserList()">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</button>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

let currentUserId = "";
let currentUserName = "";
let allUsers = [];

/* ===========================
   ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
   =========================== */
async function loadUsers() {
  const { data, error } = await sb
    .from("file_hashes")
    .select("user_id, profile_name, profile_pic");

  if (error) {
    alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
    return;
  }

  // ‡∏£‡∏ß‡∏° user ‡∏ã‡πâ‡∏≥
  const userMap = {};
  data.forEach(u => {
    if (!userMap[u.user_id]) {
      userMap[u.user_id] = {
        profile_name: u.profile_name || u.user_id,
        profile_pic: u.profile_pic || "",
        files_count: 0
      };
    }
  });

  // ‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Storage
  await Promise.all(
    Object.keys(userMap).map(async uid => {
      const { data: files } = await sb.storage
        .from(BUCKET)
        .list(`${uid}/`, { limit: 10000 });

      userMap[uid].files_count = files?.length || 0;
    })
  );

  allUsers = Object.entries(userMap);
  renderUserTable();
}

/* ===========================
   üìã ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
   =========================== */
function renderUserTable() {
  const tbody = document.getElementById("userList");
  tbody.innerHTML = "";

  allUsers.forEach(([uid, info]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <img src="${info.profile_pic}" width="50" height="50"
             style="border-radius:50%" onerror="this.src='https://via.placeholder.com/50'">
      </td>
      <td>${info.profile_name}</td>
      <td>${info.files_count}</td>
      <td>
        <button class="btn-view" onclick="viewUser('${uid}','${info.profile_name}')">
          ‡∏î‡∏π‡∏£‡∏π‡∏õ
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===========================
   üñºÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á user
   =========================== */
async function viewUser(uid, name) {
  currentUserId = uid;
  currentUserName = name;

  document.getElementById("userTableSection").style.display = "none";
  document.getElementById("gallery").style.display = "block";
  document.getElementById("userHeader").innerText = `üì∏ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á: ${name}`;

  const { data, error } = await sb.storage
    .from(BUCKET)
    .list(`${uid}/`, { limit: 10000 });

  if (error) return alert("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

  const grid = document.getElementById("imageGrid");
  grid.innerHTML = "";

  if (!data.length) {
    grid.innerHTML = "<p>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</p>";
    return;
  }

  data.forEach(f => {
    const img = document.createElement("img");
    img.src = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${uid}/${f.name}`;
    img.className = "thumb";
    img.title = f.name;
    img.onclick = () => deleteSingle(uid, f.name);
    grid.appendChild(img);
  });
}

/* ===========================
   üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
   =========================== */
async function deleteSingle(uid, name) {
  if (!confirm(`‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå ${name} ?`)) return;

  const path = `${uid}/${name}`;
  await sb.storage.from(BUCKET).remove([path]);
  await sb.from("file_hashes").delete().eq("file_path", path);

  alert("‚úÖ ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  viewUser(uid, currentUserName);
}

/* ===========================
   üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á user
   =========================== */
async function deleteAllFromUser() {
  const confirmText = prompt(`‡∏û‡∏¥‡∏°‡∏û‡πå CONFIRM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á ${currentUserName}`);
  if (confirmText !== "CONFIRM") return;

  const { data } = await sb.storage.from(BUCKET).list(`${currentUserId}/`, { limit: 10000 });
  const files = data.map(f => `${currentUserId}/${f.name}`);

  if (files.length) {
    await sb.storage.from(BUCKET).remove(files);
    await sb.from("file_hashes").delete().eq("user_id", currentUserId);
  }

  alert("‚úÖ ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  backToUserList();
}

/* ===========================
   üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
   =========================== */
function backToUserList() {
  document.getElementById("gallery").style.display = "none";
  document.getElementById("userTableSection").style.display = "block";
  loadUsers();
}

loadUsers();
</script>
</body>
</html>
