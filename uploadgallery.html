<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Photographer Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-2xl space-y-6">

  <h1 class="text-2xl font-bold text-center text-yellow-400">
    Photographer Upload
  </h1>

  <!-- LOGIN -->
  <div id="loginBox" class="bg-slate-800 rounded-xl p-6 text-center">
    <button id="loginBtn"
      class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-xl">
      Login with LINE
    </button>
    <div id="loginError" class="text-red-400 text-sm mt-3 hidden"></div>
  </div>

  <!-- UPLOAD -->
  <div id="uploadBox" class="hidden space-y-4">

    <!-- Profile -->
    <div class="bg-slate-800 rounded-xl p-4 text-center">
      <img id="avatar" class="w-16 h-16 rounded-full mx-auto mb-2">
      <div id="welcome" class="text-sm"></div>
    </div>

    <!-- Overall progress -->
    <div class="bg-slate-800 rounded-xl p-4">
      <div class="flex justify-between text-sm mb-1">
        <span id="overallText">Waiting</span>
        <span id="overallPercent">0%</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-3">
        <div id="overallBar"
          class="bg-yellow-400 h-3 rounded-full transition-all"
          style="width:0%"></div>
      </div>
    </div>

    <!-- Dropzone -->
    <div id="dropzone"
      class="border-2 border-dashed border-gray-500 rounded-xl p-10
             text-center cursor-pointer hover:border-yellow-400">
      Click or Drop Images<br>
      <span class="text-xs text-gray-400">
        Max 5000 files • Max 5MB / file
      </span>
      <input id="fileInput" type="file" multiple accept="image/*" class="hidden">
    </div>

    <!-- Queue -->
    <div id="queue" class="space-y-2"></div>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2001781240-k2PJ3Ap2";
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";

const MAX_FILES = 5000;
const MAX_SIZE_MB = 5;
/* ========================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let userId = null;
let photographer = null;
let queue = [];
let uploaded = 0;
let uploading = false;

/* ================= LOGIN ================= */
document.getElementById("loginBtn").onclick = loginLine;

async function loginLine() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) return liff.login();

    const profile = await liff.getProfile();
    userId = profile.userId;

    await checkPermission();
  } catch (e) {
    showLoginError("LINE login failed");
  }
}

async function checkPermission() {
  const { data, error } = await sb
    .from("photographer_registration")
    .select(`
      user_id,
      display_name,
      picture_url,
      status,
      is_blocked,
      is_deleted,
      is_upload_blocked
    `)
    .eq("user_id", userId)
    .maybeSingle();

  if (error || !data) {
    return showLoginError("ไม่พบรายชื่อช่างภาพในระบบ");
  }

  if (data.status !== "approved") {
    return showLoginError("บัญชีนี้ยังไม่ได้รับการอนุมัติ");
  }

  if (data.is_blocked || data.is_deleted || data.is_upload_blocked) {
    return showLoginError("บัญชีนี้ถูกระงับการอัปโหลด");
  }

  photographer = data;

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("uploadBox").classList.remove("hidden");
  document.getElementById("welcome").innerText =
    "Welcome " + data.display_name;
  document.getElementById("avatar").src = data.picture_url;
}

function showLoginError(msg) {
  const el = document.getElementById("loginError");
  el.innerText = "❌ " + msg;
  el.classList.remove("hidden");
}

/* ================= FILE FILTER ================= */
function filterFiles(files) {
  const valid = [];
  const skipped = [];

  for (const file of files) {
    if (valid.length >= MAX_FILES) {
      skipped.push(file.name + " (over 5000 files)");
      continue;
    }
    if (file.size > MAX_SIZE_MB * 1024 * 1024) {
      skipped.push(file.name + " (over 10MB)");
      continue;
    }
    valid.push(file);
  }

  if (skipped.length) {
    alert(
      "Skipped " + skipped.length + " files\n" +
      skipped.slice(0, 10).join("\n")
    );
  }

  return valid;
}

/* ================= DROPZONE ================= */
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const queueEl = document.getElementById("queue");

dropzone.onclick = () => fileInput.click();
fileInput.onchange = e => enqueue(filterFiles(e.target.files));

/* ================= QUEUE ================= */
function enqueue(files) {
  if (uploading) return;

  for (const file of files) {
    queue.push(file);
    addQueueItem(file.name);
  }

  if (!uploading && queue.length > 0) {
    uploading = true;
    processQueue();
  }
}

function addQueueItem(name) {
  const div = document.createElement("div");
  div.className = "bg-slate-800 rounded p-3";
  div.innerHTML = `
    <div class="text-sm mb-1">${name}</div>
    <div class="w-full bg-gray-700 rounded-full h-2">
      <div class="bg-green-400 h-2 rounded-full progress" style="width:0%"></div>
    </div>
  `;
  queueEl.appendChild(div);
}

/* ================= UPLOAD ================= */
async function processQueue() {
  const total = queue.length;

  for (let i = 0; i < total; i++) {
    await uploadFile(queue[i], i);
    uploaded++;
    updateOverall(total);
  }

  document.getElementById("overallText").innerText = "Upload completed";
  uploading = false;
}

function updateOverall(total) {
  const percent = Math.round((uploaded / total) * 100);
  document.getElementById("overallBar").style.width = percent + "%";
  document.getElementById("overallPercent").innerText = percent + "%";
  document.getElementById("overallText").innerText =
    "Uploaded " + uploaded + " / " + total;
}

function uploadFile(file, index) {
  return new Promise(async (resolve, reject) => {
    const path = userId + "/" + Date.now() + "_" + file.name;
    const xhr = new XMLHttpRequest();

    xhr.open(
      "POST",
      SUPABASE_URL + "/storage/v1/object/gallery/" + encodeURIComponent(path)
    );
    xhr.setRequestHeader("Authorization", "Bearer " + SUPABASE_ANON_KEY);
    xhr.setRequestHeader("x-upsert", "false");

    const bar = document.querySelectorAll(".progress")[index];

    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        bar.style.width = Math.round((e.loaded / e.total) * 100) + "%";
      }
    };

    xhr.onload = async () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        const buf = await crypto.subtle.digest(
          "SHA-256",
          await file.arrayBuffer()
        );
        const hash = Array.from(new Uint8Array(buf))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");

        await sb.from("file_hashes").upsert(
          {
            user_id: userId,
            file_path: path,
            hash: hash,
            synced: false
          },
          { onConflict: "hash" }
        );

        resolve();
      } else {
        reject();
      }
    };

    xhr.onerror = () => reject();
    xhr.send(file);
  });
}
</script>

</body>
</html>
