<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üì∏ Photographer Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- LINE LIFF -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-xl space-y-6">

  <h1 class="text-2xl font-bold text-center text-yellow-400">
    üì∏ Photographer Upload
  </h1>

  <!-- LOGIN -->
  <div id="loginBox" class="bg-slate-800 rounded-xl p-6 text-center space-y-3">
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</p>
    <button
      id="loginBtn"
      class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl font-semibold"
    >
      Login with LINE
    </button>
  </div>

  <!-- UPLOAD -->
  <div id="uploadBox" class="hidden space-y-4">

    <div class="bg-slate-800 rounded-xl p-4 text-center">
      <p id="welcome" class="font-semibold"></p>
      <p class="text-sm text-gray-400">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</p>
    </div>

    <div
      id="dropzone"
      class="border-2 border-dashed border-gray-500 rounded-xl p-10 text-center cursor-pointer hover:border-yellow-400 transition"
    >
      <p class="text-gray-300">Drag & Drop ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
      <input id="fileInput" type="file" multiple accept="image/*" class="hidden" />
    </div>

    <div id="status" class="text-sm text-gray-300"></div>

  </div>

</div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2001781240-k2PJ3Ap2";
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const FACE_SYNC_URL = SUPABASE_URL + "/functions/v1/face-sync";
/* ========================================== */

/* ---------- Supabase Client (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ä‡∏ô) ---------- */
const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ---------- State ---------- */
let userId = null;

/* ---------- LINE LOGIN ---------- */
document.getElementById("loginBtn").addEventListener("click", loginLine);

async function loginLine() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  await checkPermission(profile);
}

async function checkPermission(profile) {
  const { data, error } = await sb
    .from("photographer_registration")
    .select("*")
    .eq("user_id", profile.userId)
    .eq("status", "approved")
    .single();

  if (error || !data) {
    alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û");
    return;
  }

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("uploadBox").classList.remove("hidden");
  document.getElementById("welcome").textContent =
    `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${data.name}`;
}

/* ---------- Drag & Drop ---------- */
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");

dropzone.addEventListener("click", () => fileInput.click());

dropzone.addEventListener("dragover", e => {
  e.preventDefault();
  dropzone.classList.add("border-yellow-400");
});

dropzone.addEventListener("dragleave", () => {
  dropzone.classList.remove("border-yellow-400");
});

dropzone.addEventListener("drop", e => {
  e.preventDefault();
  dropzone.classList.remove("border-yellow-400");
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener("change", e => {
  handleFiles(e.target.files);
});

/* ---------- Upload Logic ---------- */
async function handleFiles(files) {
  for (const file of files) {
    await uploadSingleFile(file);
  }
  await triggerSync(); // üî• auto sync
}

async function uploadSingleFile(file) {
  const filePath = `${userId}/${Date.now()}_${file.name}`;
  statusEl.textContent = `‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${file.name}`;

  const { error: uploadError } = await sb
    .storage
    .from("gallery")
    .upload(filePath, file, { upsert: false });

  if (uploadError) {
    statusEl.textContent = `‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${file.name}`;
    return;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á hash
  const hashBuffer = await crypto.subtle.digest(
    "SHA-256",
    await file.arrayBuffer()
  );
  const hashHex = Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");

  await sb.from("file_hashes").insert({
    user_id: userId,
    file_path: filePath,
    hash: hashHex,
    synced: false
  });

  statusEl.textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${file.name}`;
}

/* ---------- Auto Sync ---------- */
async function triggerSync() {
  await fetch(FACE_SYNC_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId })
  });
}
</script>

</body>
</html>
