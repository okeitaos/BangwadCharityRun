<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

  <style>
    .filename {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      width: 100%;
      text-align: center;
    }

    #previewPopup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      overflow-y: auto;
      padding: 2rem 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }

    #previewPopup.show {
      opacity: 1;
      pointer-events: auto;
    }

    #previewPopup > div {
      background: #1e293b;
      border-radius: 1rem;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
      text-align: center;
      max-width: 600px;
      width: 100%;
      margin: auto;
      transform: translateY(20px);
      transition: transform 0.35s ease;
    }

    #previewPopup.show > div {
      transform: translateY(0);
    }

    #previewCanvas {
      max-width: 100%;
      max-height: 75vh;
      object-fit: contain;
      border: 2px solid white;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <div class="w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
      <button id="langToggle" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">EN</button>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl shadow-lg text-center">
      <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />

      <div class="flex gap-2 mb-4">
        <button id="searchBtn" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg">
          üîé <span id="btnSearchText">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û</span>
        </button>
        <button id="clearBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg">
          üßπ <span id="btnClearText">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</span>
        </button>
      </div>

      <!-- üîß FIX: threshold ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 65% -->
      <div class="mb-4 text-left">
        <label id="thresholdLabel" class="block text-sm text-gray-300 mb-1">
          ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (65%)
        </label>
        <input id="threshold" type="range" min="55" max="85" value="65" class="w-full accent-green-500">
        <p id="thresholdValue" class="text-xs text-gray-400 mt-1 text-center">‚â• 65%</p>
      </div>

      <p id="status" class="text-gray-400 text-sm mb-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</p>
      <div id="result" class="text-sm text-gray-200"></div>
    </div>
  </div>

  <!-- Preview Popup -->
  <div id="previewPopup">
    <div class="bg-slate-800 p-4 rounded-xl shadow-xl text-center">
      <canvas id="previewCanvas"></canvas>
      <div class="flex justify-center gap-3 mt-3">
        <button id="confirmDownload" class="bg-green-600 px-4 py-2 rounded-lg">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="cancelPreview" class="bg-red-600 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// üîß FIX: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
let SIM_THRESHOLD = 0.65;

const statusDiv = document.getElementById("status");
const resultDiv = document.getElementById("result");
const thresholdInput = document.getElementById("threshold");
const thresholdLabel = document.getElementById("thresholdLabel");
const thresholdValue = document.getElementById("thresholdValue");

thresholdInput.oninput = (e) => {
  SIM_THRESHOLD = e.target.value / 100;
  thresholdLabel.textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (${e.target.value}%)`;
  thresholdValue.textContent = `‚â• ${e.target.value}%`;
};

// üîß FIX: ‡πÉ‡∏ä‡πâ TinyFaceDetector
const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
await Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri(modelURL),
  faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
  faceapi.nets.faceRecognitionNet.loadFromUri(modelURL),
]);

statusDiv.textContent = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";

document.getElementById("searchBtn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");

  resultDiv.innerHTML = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const img = await faceapi.bufferToImage(file);

  // üîß FIX: detector ‡πÉ‡∏´‡∏°‡πà + option
  const det = await faceapi
    .detectSingleFace(
      img,
      new faceapi.TinyFaceDetectorOptions({
        inputSize: 416,
        scoreThreshold: 0.5,
      })
    )
    .withFaceLandmarks()
    .withFaceDescriptor();

  if (!det) {
    resultDiv.innerHTML = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ";
    return;
  }

  // üîß FIX: ‡πÉ‡∏ä‡πâ descriptor ‡∏ï‡∏£‡∏á ‡πÜ (‡πÑ‡∏°‡πà normalize ‡∏ã‡πâ‡∏≥)
  const embedding = Array.from(det.descriptor);

  statusDiv.textContent = `üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‚â• ${Math.round(SIM_THRESHOLD * 100)}%)`;

  const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify({
      embedding,
      threshold: SIM_THRESHOLD,
      limit: 20,
    }),
  });

  const { matches } = await res.json();

  if (!matches || !matches.length) {
    resultDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á ‡∏•‡∏≠‡∏á‡∏•‡∏î threshold";
    return;
  }

  resultDiv.innerHTML = `
    <p class="text-green-400 mb-2">üéØ ‡∏û‡∏ö ${matches.length} ‡∏†‡∏≤‡∏û</p>
    <div class="grid grid-cols-2 gap-3">
      ${matches.map(m => `
        <div class="bg-slate-700 p-2 rounded">
          <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}" class="rounded mb-1">
          <p class="text-xs text-center">${(m.similarity*100).toFixed(1)}%</p>
        </div>
      `).join("")}
    </div>
  `;
};
</script>
</body>
</html>
