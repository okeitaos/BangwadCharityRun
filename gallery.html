<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ | BCR RUN GALLERY</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Face Recognition -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      color: #facc15;
      text-shadow: 0 0 10px rgba(250,204,21,0.4);
      margin-bottom: 10px;
    }

    p { opacity: 0.85; }

    #uploadInput {
      margin: 15px 0;
      padding: 10px;
      border-radius: 25px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }
    #uploadInput:hover { background: rgba(255,255,255,0.15); }

    #status {
      color: #facc15;
      font-weight: 600;
      margin: 10px 0;
    }

    .preview-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .preview-container img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #facc15;
    }

    .slider-box {
      margin: 15px auto;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 10px;
      max-width: 400px;
    }

    input[type="range"] {
      width: 80%;
    }

    .progress-container {
      width: 80%;
      max-width: 600px;
      margin: 15px auto;
      background: rgba(255,255,255,0.1);
      border-radius: 30px;
      overflow: hidden;
      height: 20px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #84cc16);
      border-radius: 30px;
      transition: width 0.2s ease;
    }

    .progress-text {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: 25px auto;
    }

    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
    }
    .card:hover { transform: scale(1.03); }

    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .card p {
      margin: 6px 0;
      color: #eee;
      font-size: 0.9rem;
    }

    .download-btn {
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border: none;
      color: #fff;
      padding: 6px 14px;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.3s;
      margin-bottom: 10px;
    }

    .download-btn:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <h1>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
  <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏û) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>

  <input type="file" id="uploadInput" accept="image/*" multiple />

  <div class="slider-box">
    <label for="similarityRange">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label><br>
    <input type="range" id="similarityRange" min="0.4" max="0.65" step="0.01" value="0.55" />
    <p>üîß ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="similarityLabel">0.55 (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</span></p>
  </div>

  <div id="status">‚è≥ ‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>

  <div class="preview-container" id="previewContainer"></div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>

  <div class="grid" id="resultGrid"></div>

  <script>
    const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
    const BUCKET = "gallery";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allImages = [];
    let modelsLoaded = false;

    window.onload = async () => {
      await loadModels();
      await loadAllImages();
    };

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    async function loadModels() {
      const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";
      await faceapi.nets.sssdMobilenetv1?.loadFromUri?.(MODEL_URL) ?? faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
      modelsLoaded = true;
      document.getElementById("status").innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ)";
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function loadAllImages() {
      const { data: folders } = await sb.storage.from(BUCKET).list("", { limit: 100 });
      for (const folder of folders) {
        if (!folder.name.startsWith(".")) {
          const { data: files } = await sb.storage.from(BUCKET).list(folder.name + "/", { limit: 1000 });
          files?.forEach(f => {
            if (/\.(jpg|jpeg|png)$/i.test(f.name)) {
              allImages.push({
                url: `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${folder.name}/${f.name}`,
                name: f.name,
              });
            }
          });
        }
      }
      console.log("üì∏ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß:", allImages.length);
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ slider
    const slider = document.getElementById("similarityRange");
    const label = document.getElementById("similarityLabel");
    slider.addEventListener("input", () => {
      const val = parseFloat(slider.value);
      let level = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
      if (val <= 0.45) level = "‡πÄ‡∏Ç‡πâ‡∏° (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á)";
      else if (val >= 0.6) level = "‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á)";
      label.innerText = `${val.toFixed(2)} (${level})`;
    });

    // ‡πÅ‡∏™‡∏î‡∏á preview ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.getElementById("uploadInput").addEventListener("change", e => {
      const files = Array.from(e.target.files);
      const previewContainer = document.getElementById("previewContainer");
      previewContainer.innerHTML = "";
      files.forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        previewContainer.appendChild(img);
      });
      if (files.length) searchFaces(files);
    });

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    async function searchFaces(files) {
      const THRESHOLD = parseFloat(slider.value);
      const status = document.getElementById("status");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      if (!files.length) return;
      if (!modelsLoaded) return alert("‚è≥ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à");

      status.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
      const descriptors = [];

      for (const file of files) {
        const img = await faceapi.bufferToImage(file);
        const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
        if (det) descriptors.push(det.descriptor);
      }

      if (!descriptors.length) {
        status.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
        return;
      }

      const avgDescriptor = new Float32Array(128);
      descriptors.forEach(d => {
        for (let i = 0; i < 128; i++) avgDescriptor[i] += d[i] / descriptors.length;
      });

      const matches = [];
      for (let i = 0; i < allImages.length; i++) {
        const img = allImages[i];
        try {
          const refImg = new Image();
          refImg.crossOrigin = "anonymous";
          refImg.src = img.url;
          await new Promise((res, rej) => { refImg.onload = res; refImg.onerror = rej; });

          const refDet = await faceapi.detectSingleFace(refImg).withFaceLandmarks().withFaceDescriptor();
          if (!refDet) continue;

          const distance = faceapi.euclideanDistance(avgDescriptor, refDet.descriptor);
          const confidence = Math.round((1 - distance) * 100);

          if (distance < THRESHOLD && confidence >= 50) matches.push({ ...img, similarity: confidence });
        } catch { }

        const percent = Math.round(((i + 1) / allImages.length) * 100);
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${percent}% (${i + 1}/${allImages.length})`;
      }

      matches.sort((a, b) => b.similarity - a.similarity);
      matches.splice(30);

      if (!matches.length) {
        status.innerText = "üò¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô";
        document.getElementById("resultGrid").innerHTML = "";
      } else {
        status.innerText = `‚úÖ ‡∏û‡∏ö ${matches.length} ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô`;
        renderResults(matches);
      }

      progressBar.style.width = "0%";
      progressText.textContent = "0%";
    }

    function renderResults(list) {
      document.getElementById("resultGrid").innerHTML = list.map(i => `
        <div class="card">
          <img src="${i.url}" alt="${i.name}">
          <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢: ${i.similarity}%</p>
          <button class="download-btn" onclick="downloadImage('${i.url}', '${i.name}')">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        </div>`).join("");
    }

    function downloadImage(url, filename) {
      fetch(url)
        .then(res => res.blob())
        .then(blob => {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          URL.revokeObjectURL(a.href);
        });
    }
  </script>
</body>
</html>
