<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì | Charity Run</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

<style>
.card {
  transition: transform .2s, box-shadow .2s;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 25px rgba(0,0,0,.4);
}
</style>
</head>

<body class="bg-slate-900 text-white min-h-screen">

<div class="max-w-7xl mx-auto px-4 py-6 space-y-6">

<h1 class="text-2xl md:text-3xl font-bold text-center text-yellow-400">
üèÉ‚Äç‚ôÇÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
</h1>

<!-- Upload -->
<div class="bg-slate-800 rounded-2xl p-5 space-y-3">
  <input id="fileInput" type="file" accept="image/*"
    class="block w-full text-sm
    file:bg-yellow-500 file:text-black
    file:px-5 file:py-2 file:rounded-xl" />
  <div id="status" class="text-sm text-gray-300"></div>
</div>

<!-- Query Preview -->
<div id="queryPreviewBox"
  class="hidden bg-slate-800 rounded-2xl p-4 text-center">
  <p class="text-sm text-gray-400 mb-2">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
  <img id="queryPreviewImg"
    class="mx-auto rounded-xl max-h-64 border border-yellow-500/40">
</div>

<div id="resultInfo"
  class="hidden text-sm text-center text-gray-300"></div>

<!-- Primary -->
<div>
<h2 class="text-sm text-green-400 mb-2 text-center">
‚úÖ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á)
</h2>
<div id="primaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
</div>

<!-- Secondary -->
<div id="secondarySection" class="hidden mt-8">
<h2 class="text-sm text-yellow-400 mb-2 text-center">
‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞)
</h2>
<div id="secondaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const RESULT_LIMIT = 200;
/* ========================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const resultInfo = document.getElementById("resultInfo");
const primaryBox = document.getElementById("primaryBox");
const secondaryBox = document.getElementById("secondaryBox");
const secondarySection = document.getElementById("secondarySection");
const queryPreviewBox = document.getElementById("queryPreviewBox");
const queryPreviewImg = document.getElementById("queryPreviewImg");

/* ================= LOAD MODELS ================= */
(async () => {
  const MODEL_URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
  statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  statusEl.innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
})();

/* ================= GROUP FACE SUPPORT ================= */
function pickMainFaces(detections, maxFaces = 1) {
  return detections
    .map(d => ({
      descriptor: d.descriptor,
      area: d.detection.box.width * d.detection.box.height
    }))
    .sort((a, b) => b.area - a.area)
    .slice(0, maxFaces);
}

function mergeResults(resultSets) {
  const map = new Map();
  resultSets.flat().forEach(r => {
    if (!map.has(r.image_id) || r.distance < map.get(r.image_id).distance) {
      map.set(r.image_id, r);
    }
  });
  return Array.from(map.values());
}

/* ================= SPLIT RESULTS (Layer 3) ================= */
function splitResults(rows) {
  if (!rows || rows.length === 0) return { primary: [], secondary: [] };

  const HARD_CUTOFF = 0.45;
  const STRONG_MAX  = 0.30;
  const MAX_JUMP    = 0.10;
  const MAX_PRIMARY = 40;

  const sorted = rows
    .filter(r => r.distance <= HARD_CUTOFF)
    .sort((a, b) => a.distance - b.distance);

  if (sorted.length === 0) return { primary: [], secondary: [] };

  const primary = [sorted[0]];
  const secondary = [];

  for (let i = 1; i < sorted.length; i++) {
    const jump = sorted[i].distance - sorted[i - 1].distance;
    if (sorted[i].distance > STRONG_MAX) break;
    if (jump > MAX_JUMP) break;
    if (primary.length >= MAX_PRIMARY) break;
    primary.push(sorted[i]);
  }

  const last = primary[primary.length - 1];
  for (let i = primary.length; i < sorted.length; i++) {
    if (sorted[i].distance - last.distance > MAX_JUMP) break;
    secondary.push(sorted[i]);
  }

  return { primary, secondary };
}

/* ================= Layer 4: Identity Consistency ================= */
function identityConsistencyFilter(results) {
  if (results.length <= 2) return results;

  const anchors = results.slice(0, 5);

  return results.filter(r => {
    let votes = 0;
    for (const a of anchors) {
      if (Math.abs(r.distance - a.distance) < 0.08) votes++;
    }
    return votes >= 2;
  });
}

/* ================= Layer 5: Context Boost ================= */
function contextBoost(results) {
  const boosted = [];
  for (let i = 0; i < results.length; i++) {
    let score = 0;
    if (i > 0 && results[i].photographer_code === results[i - 1].photographer_code) score++;
    if (i < results.length - 1 &&
        results[i].photographer_code === results[i + 1].photographer_code) score++;
    if (score > 0) boosted.push(results[i]);
  }
  return boosted;
}

/* ================= SEARCH (ELITE PIPELINE) ================= */
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  primaryBox.innerHTML = "";
  secondaryBox.innerHTML = "";
  secondarySection.classList.add("hidden");
  resultInfo.classList.add("hidden");

  statusEl.innerText = "üì∏ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";

  const img = await faceapi.bufferToImage(file);
  queryPreviewImg.src = img.src;
  queryPreviewBox.classList.remove("hidden");

  const detections = await faceapi
    .detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
    .withFaceLandmarks()
    .withFaceDescriptors();

  if (!detections || detections.length === 0) {
    statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
    return;
  }

  statusEl.innerText = `üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö ${detections.length} ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Ä¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;

  const mainFaces = pickMainFaces(detections, 1);
  let allResults = [];

  for (const face of mainFaces) {
    const vectorLiteral = "[" + Array.from(face.descriptor).join(",") + "]";
    const { data } = await sb.rpc("search_face_ranked", {
      query_vector: vectorLiteral,
      result_limit: RESULT_LIMIT
    });
    if (data) allResults.push(data);
  }

  const merged = mergeResults(allResults);
  const { primary, secondary } = splitResults(merged);

  const primaryFinal = identityConsistencyFilter(primary);
  const secondaryFinal = contextBoost(secondary);

  statusEl.innerText = "üéâ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

  renderBox(primaryFinal, primaryBox);

  if (secondaryFinal.length) {
    secondarySection.classList.remove("hidden");
    renderBox(secondaryFinal, secondaryBox);
  }

  resultInfo.classList.remove("hidden");
  resultInfo.innerText =
    `‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${primaryFinal.length} ‡∏†‡∏≤‡∏û` +
    (secondaryFinal.length ? ` ‚Ä¢ ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ${secondaryFinal.length} ‡∏†‡∏≤‡∏û` : "");
};

/* ================= RENDER ================= */
function renderBox(rows, box) {
  box.innerHTML = "";
  rows.forEach((r,i)=>{
    const url = sb.storage.from("gallery")
      .getPublicUrl(r.file_path).data.publicUrl;

    const card = document.createElement("div");
    card.className = "card bg-slate-800 rounded-2xl overflow-hidden";

    card.innerHTML = `
      <img src="${url}" class="w-full h-56 object-cover">
      <div class="p-3 text-xs text-gray-400">
        Similarity ${(1-r.distance).toFixed(2)}
      </div>
    `;
    box.appendChild(card);
  });
}
</script>

</body>
</html>
