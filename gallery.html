<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

</head>

<body class="bg-slate-900 text-white p-6 min-h-screen">
  <h1 class="text-2xl font-bold mb-4">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>

  <input id="file" type="file" accept="image/*" class="mb-3 block">
  <button id="search" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  </button>

  <p id="status" class="text-sm text-gray-400 mt-3"></p>

  <div id="result" class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-6"></div>

<script type="module">
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";

search.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ");

  const img = await faceapi.bufferToImage(file);
  const dets = await faceapi
    .detectAllFaces(img)
    .withFaceLandmarks()
    .withFaceDescriptors();

  if (!dets.length) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");

  const main = dets.reduce((a,b)=>
    b.detection.box.area > a.detection.box.area ? b : a
  );

  const embedding = Array.from(main.descriptor);

  const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": ANON_KEY
    },
    body: JSON.stringify({
      embedding,
      threshold: 0.8,
      limit: 300
    })
  });

  const json = await res.json();
  if (!json.matches?.length) {
    result.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ</p>";
    return;
  }

  // üîí ‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏∏‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
  const top = json.matches[0].similarity;
  const final = json.matches.filter(
    m => top - m.similarity <= 0.08
  );

  result.innerHTML = final.map(m => `
    <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}"
         class="rounded shadow">
  `).join("");
};
</script>

</body>
</html>
