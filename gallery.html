<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Face Search | Bangwad Charity Run</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
<style>
  .filename {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    width: 100%;
    text-align: center;
  }
</style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-4">üì∏ Face Search</h1>

  <div class="bg-slate-800 p-6 rounded-xl shadow-lg w-full max-w-md text-center">
    <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300">
    <button id="searchBtn" class="w-full bg-green-500 hover:bg-green-600 py-2 rounded-lg mb-3">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    <div id="status" class="text-gray-400 text-sm mb-2">‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</div>
    <div id="result"></div>
  </div>

  <!-- Popup Viewer -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="relative">
      <img id="popupImg" class="max-h-[85vh] rounded-lg shadow-lg border-4 border-white">
      <button id="closePopup" class="absolute top-2 right-2 bg-white text-black px-3 py-1 rounded-lg">‚úï</button>
    </div>
  </div>

  <!-- Download Option -->
  <div id="downloadDialog" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 items-center justify-center">
    <div class="bg-slate-800 p-6 rounded-xl shadow-xl text-center max-w-xs">
      <h2 class="text-lg font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</h2>
      <div class="flex flex-col gap-3">
        <button id="dlWith" class="bg-green-600 hover:bg-green-700 py-2 rounded-lg">üíß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</button>
        <button id="dlNo" class="bg-blue-600 hover:bg-blue-700 py-2 rounded-lg">üñºÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</button>
      </div>
      <button id="cancelDl" class="mt-4 text-gray-400 hover:text-gray-200 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

// üîß CONFIG
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"
const BUCKET = "gallery"
const WATERMARK_SRC = "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png"

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const fileInput = document.getElementById("fileInput")
const searchBtn = document.getElementById("searchBtn")
const resultDiv = document.getElementById("result")
const statusDiv = document.getElementById("status")
const popup = document.getElementById("popup")
const popupImg = document.getElementById("popupImg")
const closePopup = document.getElementById("closePopup")
const downloadDialog = document.getElementById("downloadDialog")
const dlWith = document.getElementById("dlWith")
const dlNo = document.getElementById("dlNo")
const cancelDl = document.getElementById("cancelDl")

let downloadQueue = { url: null, name: null }

function normalize(d){const n=Math.sqrt(d.reduce((a,b)=>a+b*b,0));return d.map(x=>x/n)}

statusDiv.textContent="‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•..."
await Promise.all([
  faceapi.nets.ssdMobilenetv1.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/"),
  faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/"),
  faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/")
])
statusDiv.textContent="‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß"

// üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
searchBtn.onclick = async () => {
  const f = fileInput.files[0]
  if (!f) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô")
  resultDiv.innerHTML = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤..."
  const img = await faceapi.bufferToImage(f)
  const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor()
  if (!det) return (resultDiv.innerHTML = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤")

  const emb = normalize(Array.from(det.descriptor))
  resultDiv.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
  const r = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ embedding: emb, threshold: 0.95, limit: 20 })
  })
  const { matches, error } = await r.json()
  if (error || !matches?.length) return (resultDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô")

  resultDiv.innerHTML = `
    <p class="text-green-400 font-semibold mb-2">üéØ ‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ${matches.length} ‡∏†‡∏≤‡∏û</p>
    <div class="grid grid-cols-2 gap-3">
      ${matches.map(m => `
        <div class="bg-slate-700 p-2 rounded-lg overflow-hidden">
          <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}"
               class="rounded-lg mb-2 shadow cursor-pointer hover:scale-105 transition w-full object-cover aspect-[3/4]"
               onclick="openPopup('${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}')">
          <p class="filename text-sm text-gray-200" title="${m.name}">${m.name}</p>
          <p class="text-xs text-gray-400 mb-2 text-center">Similarity: ${(m.similarity*100).toFixed(2)}%</p>
          <button onclick="chooseDownload('${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}','${m.name}')"
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs rounded px-2 py-1">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        </div>`).join("")}
    </div>`
}

// üñºÔ∏è popup viewer
window.openPopup = (src) => {
  popupImg.src = src
  popup.classList.remove("hidden")
}
closePopup.onclick = () => popup.classList.add("hidden")

// üíæ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥
window.chooseDownload = (url, name) => {
  downloadQueue = { url, name }
  downloadDialog.classList.remove("hidden")
  downloadDialog.classList.add("flex")
}
cancelDl.onclick = () => downloadDialog.classList.add("hidden")
dlWith.onclick = () => { downloadImage(true); }
dlNo.onclick = () => { downloadImage(false); }

async function downloadImage(withWatermark) {
  const { url, name } = downloadQueue
  downloadDialog.classList.add("hidden")

  const response = await fetch(url, { mode: "cors" })
  const blob = await response.blob()
  const safeName = name.replace(/[/\\?%*:|"<>]/g, "-") + ".jpg"

  if (!withWatermark) {
    const a = document.createElement("a")
    a.href = URL.createObjectURL(blob)
    a.download = safeName
    a.click()
    return
  }

  const img = await createImageBitmap(blob)
  const logo = new Image()
  logo.src = WATERMARK_SRC
  await logo.decode()

  const canvas = document.createElement("canvas")
  canvas.width = img.width
  canvas.height = img.height
  const ctx = canvas.getContext("2d")
  ctx.drawImage(img, 0, 0)
  const w = img.width / 6
  const h = (logo.height / logo.width) * w
  ctx.globalAlpha = 0.85
  ctx.drawImage(logo, img.width - w - 20, img.height - h - 20, w, h)
  ctx.globalAlpha = 1

  canvas.toBlob((b) => {
    const a = document.createElement("a")
    a.href = URL.createObjectURL(b)
    a.download = safeName
    a.click()
  }, "image/jpeg", 0.95)
}
</script>
</body>
</html>
