<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ | BCR RUN GALLERY</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Prompt", sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #0f172a, #1e293b);
    color: #fff;
    text-align: center;
    padding: 20px;
  }

  h1 {
    color: #facc15;
    text-shadow: 0 0 8px rgba(250,204,21,0.3);
  }

  #status {
    margin: 10px auto;
    font-size: 1.1rem;
  }

  #uploadInput {
    margin: 20px;
    padding: 12px;
    border-radius: 25px;
    background: #06c755;
    border: none;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    width: 80%;
    max-width: 300px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    transition: 0.2s;
  }

  #uploadInput:hover {
    background: #00b900;
  }

  .progress-container {
    width: 90%;
    max-width: 600px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    margin: 10px auto;
    overflow: hidden;
  }

  .progress-bar {
    height: 20px;
    width: 0%;
    background: linear-gradient(90deg, #22c55e, #84cc16);
    transition: width 0.3s ease;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 25px;
  }

  .card {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }

  .card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
  }

  .card p {
    margin: 6px 0;
    color: #f1f5f9;
  }

  #cacheInfo {
    margin-top: 10px;
    color: #9ca3af;
  }
</style>
</head>
<body>
  <h1>üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
  <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô</p>

  <input type="file" id="uploadInput" accept="image/*" value="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
  <div id="status">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</div>

  <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>

  <div id="cacheInfo"></div>
  <div id="resultGrid" class="grid"></div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";
const DB_NAME = "face-cache", DB_STORE = "descriptors";

async function openDb() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE, { keyPath: "url" });
    };
    r.onsuccess = e => res(e.target.result);
    r.onerror = e => rej(e.target.error);
  });
}
async function idbGetAll() {
  const db = await openDb();
  return new Promise((res, rej) => {
    const t = db.transaction(DB_STORE, "readonly").objectStore(DB_STORE).getAll();
    t.onsuccess = () => res(t.result);
    t.onerror = e => rej(e);
  });
}
async function idbPut(item) {
  const db = await openDb();
  const tx = db.transaction(DB_STORE, "readwrite").objectStore(DB_STORE).put(item);
}

async function loadModels() {
  document.getElementById("status").innerText = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  document.getElementById("status").innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
}

async function listAllImages() {
  const { data: folders } = await sb.storage.from(BUCKET).list("", { limit: 100 });
  const list = [];
  for (const folder of folders || []) {
    const { data: files } = await sb.storage.from(BUCKET).list(folder.name + "/", { limit: 500 });
    for (const f of files || []) {
      if (/\.(jpg|jpeg|png)$/i.test(f.name)) {
        list.push({
          url: `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${folder.name}/${f.name}`,
          name: f.name
        });
      }
    }
  }
  return list;
}

async function descriptorFromUrl(url) {
  const img = await faceapi.fetchImage(url);
  const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  return det ? Array.from(det.descriptor) : null;
}
function euclid(a, b) {
  let sum = 0; for (let i = 0; i < a.length; i++) { const d = a[i] - b[i]; sum += d * d; }
  return Math.sqrt(sum);
}

document.getElementById("uploadInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const status = document.getElementById("status");
  const grid = document.getElementById("resultGrid");
  const progress = document.getElementById("progressBar");
  status.innerText = "üïµÔ∏è‚Äç‚ôÄÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const userImg = await faceapi.bufferToImage(file);
  const det = await faceapi.detectSingleFace(userImg, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if (!det) { status.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"; return; }

  const q = det.descriptor;
  const cache = await idbGetAll();
  const valid = cache.filter(c => c.descriptor && c.descriptor.length > 0);
  if (valid.length === 0) { status.innerText = "‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô"; return; }

  status.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô...";
  const results = [];
  for (let i = 0; i < valid.length; i++) {
    const d = euclid(q, valid[i].descriptor);
    if (d < 0.6) results.push({ ...valid[i], distance: d });
    progress.style.width = `${(i / valid.length) * 100}%`;
    await new Promise(r => setTimeout(r, 5));
  }
  progress.style.width = "0%";

  if (results.length === 0) { status.innerText = "üò¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô"; grid.innerHTML = ""; return; }
  status.innerText = `‚úÖ ‡∏û‡∏ö ${results.length} ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô`;
  grid.innerHTML = results.slice(0, 50).map(r => `
    <div class="card">
      <img src="${r.url}" alt="${r.name}">
      <p>${r.name}<br><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ ${(1 - r.distance).toFixed(3)}</small></p>
    </div>`).join("");
});

(async () => {
  await loadModels();
  const imgs = await listAllImages();
  document.getElementById("status").innerText = `üì¶ ‡∏û‡∏ö ${imgs.length} ‡∏£‡∏π‡∏õ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;
  const cache = await idbGetAll();
  const exist = new Set(cache.map(c => c.url));
  const missing = imgs.filter(i => !exist.has(i.url));
  if (missing.length === 0) {
    document.getElementById("status").innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    return;
  }
  for (let i = 0; i < missing.length; i++) {
    const d = await descriptorFromUrl(missing[i].url);
    await idbPut({ url: missing[i].url, descriptor: d });
    document.getElementById("progressBar").style.width = `${(i / missing.length) * 100}%`;
  }
  document.getElementById("status").innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
})();
</script>
</body>
</html>
