<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

  <style>
    .filename {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
  </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center p-6">

<div class="w-full max-w-md">
  <h1 class="text-2xl font-bold mb-4 text-center">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>

  <div class="bg-slate-800 p-5 rounded-xl shadow">
    <input id="fileInput" type="file" accept="image/*"
      class="w-full mb-4 text-sm text-gray-300"/>

    <button id="searchBtn"
      class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">
      üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ
    </button>

    <p id="status" class="text-sm text-gray-400 mt-3 text-center">
      ‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...
    </p>

    <div id="result" class="mt-4 text-sm"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";

/* ================= INIT ================= */
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const fileInput = document.getElementById("fileInput");
const searchBtn = document.getElementById("searchBtn");
const statusDiv = document.getElementById("status");
const resultDiv = document.getElementById("result");

/* ================= LOAD MODELS ================= */
const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
await Promise.all([
  faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
  faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
  faceapi.nets.faceRecognitionNet.loadFromUri(modelURL),
]);
statusDiv.textContent = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß";

/* ================= SEARCH ================= */
searchBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");

  resultDiv.innerHTML = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const img = await faceapi.bufferToImage(file);

  // üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î
  const detections = await faceapi
    .detectAllFaces(img)
    .withFaceLandmarks()
    .withFaceDescriptors();

  if (!detections.length) {
    resultDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
    return;
  }

  const area = d => d.detection.box.width * d.detection.box.height;
  const mainFace = detections.reduce((a,b)=> area(b)>area(a)?b:a);
  const embedding = Array.from(mainFace.descriptor);

  statusDiv.textContent = "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...";

  /* ================= CALL EDGE ================= */
  const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
    },
    body: JSON.stringify({ embedding })
  });

  const { matches, error } = await res.json();
  if (error || !matches || !matches.length) {
    resultDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô";
    return;
  }

  /* ================= SMART FILTER ================= */

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  matches.sort((a,b)=>b.similarity - a.similarity);

  const TOP = matches[0].similarity;
  const GAP = 0.08;

  // 1Ô∏è‚É£ score gap
  const gapFiltered = matches.filter(
    m => TOP - m.similarity <= GAP
  );

  // 2Ô∏è‚É£ vote ‡∏ï‡πà‡∏≠ image
  const vote = new Map();
  for (const m of gapFiltered) {
    vote.set(m.image_url, (vote.get(m.image_url) || 0) + 1);
  }

  // 3Ô∏è‚É£ ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 embedding
  let final = gapFiltered.filter(
    m => vote.get(m.image_url) >= 2
  );

  // fallback ‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏≤‡∏¢
  if (final.length < 5) {
    final = gapFiltered.slice(0, 30);
  }

  /* ================= UNIQUE IMAGE ================= */
  const uniq = new Map();
  for (const m of final) {
    if (!uniq.has(m.image_url)) uniq.set(m.image_url, m);
  }

  const images = [...uniq.values()];

  /* ================= RENDER ================= */
  resultDiv.innerHTML = `
    <p class="text-green-400 font-semibold mb-2">
      üéØ ‡∏û‡∏ö ${images.length} ‡∏†‡∏≤‡∏û
    </p>
    <div class="grid grid-cols-2 gap-3">
      ${images.map(m => `
        <div class="bg-slate-700 p-2 rounded">
          <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}"
               class="rounded mb-2 w-full object-cover aspect-[3/4]">
          <p class="filename text-xs">${m.image_url.split("/").pop()}</p>
          <p class="text-xs text-gray-400 text-center">
            ${(m.similarity*100).toFixed(2)}%
          </p>
        </div>
      `).join("")}
    </div>
  `;
};
</script>

</body>
</html>
