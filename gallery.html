<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

  <style>
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏£‡∏≠‡∏ö */
    .filename {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
  </style>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <div class="w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
      <button id="langToggle" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">EN</button>
    </div>

    <!-- üîç Search Box -->
    <div class="bg-slate-800 p-6 rounded-xl shadow-lg text-center">
      <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />
      <div class="flex gap-2 mb-4">
        <button id="searchBtn" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg">üîé <span id="btnSearchText">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û</span></button>
        <button id="clearBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg">üßπ <span id="btnClearText">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</span></button>
      </div>

      <div class="mb-4 text-left">
        <label for="threshold" id="thresholdLabel" class="block text-sm text-gray-300 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (95%)</label>
        <input id="threshold" type="range" min="80" max="99" value="95" class="w-full accent-green-500">
        <p id="thresholdValue" class="text-xs text-gray-400 mt-1 text-center">‚â• 95%</p>
      </div>

      <p id="status" class="text-gray-400 text-sm mb-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</p>
      <div id="result" class="text-sm text-gray-200"></div>
    </div>
  </div>

  <!-- üì∏ Popup Viewer -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="relative">
      <img id="popupImg" src="" class="max-h-[80vh] rounded-lg shadow-lg border-4 border-white" />
      <button id="closePopup" class="absolute top-2 right-2 bg-white text-black px-3 py-1 rounded-lg">‚úï</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ‚öôÔ∏è CONFIG
    const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
    const BUCKET = "gallery";
    let SIM_THRESHOLD = 0.95;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // üé® DOM
    const fileInput = document.getElementById("fileInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusDiv = document.getElementById("status");
    const resultDiv = document.getElementById("result");
    const langToggle = document.getElementById("langToggle");
    const thresholdInput = document.getElementById("threshold");
    const thresholdLabel = document.getElementById("thresholdLabel");
    const thresholdValue = document.getElementById("thresholdValue");
    const title = document.getElementById("title");
    const btnSearchText = document.getElementById("btnSearchText");
    const btnClearText = document.getElementById("btnClearText");
    const popup = document.getElementById("popup");
    const popupImg = document.getElementById("popupImg");
    const closePopup = document.getElementById("closePopup");

    // üåê Languages
    const LANG = {
      th: {
        title: "üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤",
        choose: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô",
        analyzing: "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...",
        notFound: "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ",
        searching: (v) => `üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‚â•${v}%)`,
        found: (n, v) => `üéØ ‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚â•${v}% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} ‡∏†‡∏≤‡∏û`,
        btnSearch: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û",
        btnClear: "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå",
        level: (v) => `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (${v}%)`,
        ready: "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        loading: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...",
        download: "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î"
      },
      en: {
        title: "üì∏ Face Search",
        choose: "Please select an image first.",
        analyzing: "üß† Detecting face...",
        notFound: "‚ö†Ô∏è No face detected in this image.",
        searching: (v) => `üîç Searching for similar faces (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå No similar faces found (‚â•${v}%)`,
        found: (n, v) => `üéØ Found ${n} similar faces (‚â•${v}%)`,
        btnSearch: "Search",
        btnClear: "Clear",
        level: (v) => `Similarity Level (${v}%)`,
        ready: "‚úÖ Ready to use",
        loading: "‚è≥ Loading model...",
        download: "Download"
      }
    };

    let currentLang = "th";
    function setLang(lang) {
      currentLang = lang;
      const t = LANG[lang];
      title.textContent = t.title;
      btnSearchText.textContent = t.btnSearch;
      btnClearText.textContent = t.btnClear;
      thresholdLabel.textContent = t.level(Math.round(SIM_THRESHOLD * 100));
      thresholdValue.textContent = `‚â• ${Math.round(SIM_THRESHOLD * 100)}%`;
      langToggle.textContent = lang === "th" ? "EN" : "TH";
      statusDiv.textContent = t.ready;
    }

    langToggle.onclick = () => setLang(currentLang === "th" ? "en" : "th");

    // üß† ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    statusDiv.textContent = LANG[currentLang].loading;
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
    ]);
    statusDiv.textContent = LANG[currentLang].ready;

    // Normalize
    const normalize = (desc) => {
      const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
      return desc.map(x => x / norm);
    };

    thresholdInput.oninput = (e) => {
      const v = e.target.value;
      SIM_THRESHOLD = v / 100;
      thresholdLabel.textContent = LANG[currentLang].level(v);
      thresholdValue.textContent = `‚â• ${v}%`;
    };

    clearBtn.onclick = () => {
      fileInput.value = "";
      resultDiv.innerHTML = "";
      statusDiv.textContent = LANG[currentLang].ready;
    };

    async function downloadImage(url, name) {
      const res = await fetch(url);
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = name || "image.jpg";
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
    }

    searchBtn.onclick = async () => {
      const langPack = LANG[currentLang];
      const file = fileInput.files[0];
      if (!file) return alert(langPack.choose);

      resultDiv.innerHTML = langPack.analyzing;
      const img = await faceapi.bufferToImage(file);
      const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
      if (!det) return (resultDiv.innerHTML = langPack.notFound);

      const embedding = normalize(Array.from(det.descriptor));
      statusDiv.textContent = langPack.searching(Math.round(SIM_THRESHOLD * 100));

      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ embedding, threshold: SIM_THRESHOLD, limit: 20 })
        });

        const { matches, error } = await res.json();
        if (error) throw new Error(error);
        if (!matches?.length) return (resultDiv.innerHTML = langPack.noMatch(Math.round(SIM_THRESHOLD * 100)));

        resultDiv.innerHTML = `
          <p class="text-green-400 font-semibold mb-2">${langPack.found(matches.length, Math.round(SIM_THRESHOLD * 100))}</p>
          <div class="grid grid-cols-2 gap-3">
            ${matches.map(m => `
              <div class="bg-slate-700 p-2 rounded-lg overflow-hidden">
                <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}" 
                     class="rounded-lg mb-2 shadow cursor-pointer hover:scale-105 transition" 
                     onclick="openPopup('${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}')">
                <p class="filename text-sm" title="${m.name}">${m.name}</p>
                <p class="text-xs text-gray-400 mb-2">Similarity: ${(m.similarity * 100).toFixed(2)}%</p>
                <button onclick="downloadImage('${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}','${m.name}.jpg')" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs rounded px-2 py-1">${langPack.download}</button>
              </div>
            `).join("")}
          </div>
        `;
      } catch (e) {
        resultDiv.innerHTML = `‚ùå ${e.message}`;
      }
    };

    window.openPopup = (src) => { popupImg.src = src; popup.classList.remove("hidden"); };
    closePopup.onclick = () => popup.classList.add("hidden");

    setLang("th");
    window.downloadImage = downloadImage;
  </script>
</body>
</html>
