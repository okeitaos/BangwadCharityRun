<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Face Search (Fast)</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#fff;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;max-width:1000px;margin:20px auto}
  img{width:100%;height:160px;object-fit:cover;border-radius:8px}
</style>
</head>
<body>
<h1>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏£‡πá‡∏ß)</h1>
<input id="file" type="file" accept="image/*"/>
<div id="status">‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</div>
<div class="grid" id="results"></div>

<script>
const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";
const SEARCH_EDGE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co/functions/v1/search_face"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
let loaded=false;

async function loadModels(){
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  loaded=true; document.getElementById('status').innerText='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
}
loadModels();

document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f || !loaded) return alert('‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
  document.getElementById('status').innerText='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì descriptor...';
  const img = await faceapi.bufferToImage(f);
  const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions({ inputSize:416 }))
    .withFaceLandmarks().withFaceDescriptor();
  if(!detection){ document.getElementById('status').innerText='‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤'; return; }
  const descriptor = Array.from(detection.descriptor);

  document.getElementById('status').innerText='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
  const resp = await fetch(SEARCH_EDGE_URL, {
    method:'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ descriptor, limit: 12 })
  });
  const json = await resp.json();
  const results = json.results || [];
  showResults(results);
  document.getElementById('status').innerText = `‡∏û‡∏ö ${results.length} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÅ‡∏™‡∏î‡∏á ${Math.min(12, results.length)})`;
});

function showResults(rows){
  const grid = document.getElementById('results');
  grid.innerHTML = rows.map(r => `
    <div>
      <img src="${r.image_url}" alt="">
      <div>distance: ${Number(r.distance).toFixed(4)}</div>
    </div>
  `).join('');
}
</script>
</body>
</html>
