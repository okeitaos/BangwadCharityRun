<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Search | Stable + Popup + Watermark Option</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
  <style>
    .filename {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      text-align: center;
    }
  </style>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">ü§ñ Face Search (Popup + Watermark Option)</h1>

  <!-- üîç Search Section -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg w-full max-w-md mb-8 text-center">
    <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />
    
    <label class="block text-sm text-gray-400 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (Threshold)</label>
    <input type="range" id="thresholdSlider" min="0.4" max="0.99" step="0.01" value="0.95" class="w-full mb-2">
    <p id="thresholdValue" class="text-gray-400 text-sm mb-4 text-center">0.95</p>

    <button id="searchBtn" class="w-full bg-green-500 hover:bg-green-600 py-2 rounded-lg mb-4">
      üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    </button>

    <div id="status" class="text-sm text-gray-300 mb-2">‚è≥ Initializing...</div>
    <div id="result" class="text-sm text-gray-200"></div>
  </div>

  <script>
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const BUCKET = "gallery";
  const WATERMARK_SRC = "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";

  const CONF_THRESHOLD = 0.9;
  const EDGE_LIMIT = 50;

  const fileInput = document.getElementById("fileInput");
  const searchBtn = document.getElementById("searchBtn");
  const statusDiv = document.getElementById("status");
  const resultDiv = document.getElementById("result");
  const thresholdSlider = document.getElementById("thresholdSlider");
  const thresholdValue = document.getElementById("thresholdValue");

  thresholdSlider.oninput = () => {
    thresholdValue.textContent = parseFloat(thresholdSlider.value).toFixed(2);
  };

  function normalize(desc) {
    const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
    return desc.map(x => x / norm);
  }

  async function initModels() {
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    statusDiv.textContent = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
    ]);
    statusDiv.textContent = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
  }

  async function performSearch() {
    const file = fileInput.files[0];
    if (!file) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
    resultDiv.innerHTML = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";

    const img = await faceapi.bufferToImage(file);
    const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    if (!det) return resultDiv.innerHTML = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";

    const SIM_THRESHOLD = parseFloat(thresholdSlider.value);
    const queryEmbedding = normalize(Array.from(det.descriptor));

    resultDiv.innerHTML = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ embedding: queryEmbedding, threshold: SIM_THRESHOLD, limit: EDGE_LIMIT })
    });

    const { matches, error } = await resp.json();
    if (error || !matches?.length) {
      resultDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô";
      return;
    }

    resultDiv.innerHTML = `
      <p class="text-green-400 font-semibold mb-2">üéØ ‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ${matches.length} ‡∏†‡∏≤‡∏û</p>
      <div class="grid grid-cols-2 gap-3">
        ${matches.map(v => {
          const imgUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${v.image_url}`;
          return `
            <div class="bg-slate-700 p-2 rounded-lg cursor-pointer" onclick="openPopup('${imgUrl}','${v.name}',${(v.similarity*100).toFixed(2)})">
              <img src="${imgUrl}" class="rounded-lg mb-2 shadow w-full object-cover aspect-[3/4]">
              <p class="filename text-sm">${v.name}</p>
              <p class="text-xs text-gray-400 text-center">Similarity: ${(v.similarity*100).toFixed(2)}%</p>
            </div>`;
        }).join("")}
      </div>`;
  }

  // üß© Popup Viewer + Download Option
  const WATERMARK = new Image();
  WATERMARK.src = WATERMARK_SRC;
  let downloadQueue = { url: "", name: "" };

  window.openPopup = (url, name, sim) => {
    downloadQueue = { url, name };
    const popup = document.createElement("div");
    popup.className = "fixed inset-0 bg-black/70 flex items-center justify-center z-50";
    popup.innerHTML = `
      <div class="bg-slate-900 rounded-xl p-4 shadow-xl text-center relative max-w-[90%] max-h-[90%] overflow-auto">
        <button id="closePopup" class="absolute top-2 right-2 text-gray-300 hover:text-white text-xl">‚úï</button>
        <img src="${url}" class="rounded-lg max-h-[70vh] mx-auto mb-3 shadow-lg">
        <p class="font-semibold text-lg mb-1">${name}</p>
        <p class="text-gray-400 text-sm mb-4">Similarity: ${sim}%</p>
        <div class="flex gap-3 justify-center">
          <button id="dlWith" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">üíß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</button>
          <button id="dlNo" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">üñºÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</button>
        </div>
      </div>`;
    document.body.appendChild(popup);

    popup.querySelector("#closePopup").onclick = () => popup.remove();
    popup.querySelector("#dlWith").onclick = () => { downloadImage(true); popup.remove(); };
    popup.querySelector("#dlNo").onclick = () => { downloadImage(false); popup.remove(); };
  };

  async function downloadImage(withWatermark) {
    const { url, name } = downloadQueue;
    const safeName = (name || "image").replace(/[/\\?%*:|"<>]/g, "-") + ".jpg";
    const res = await fetch(url, { mode: "cors" });
    const blob = await res.blob();

    if (!withWatermark) {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = safeName;
      a.click();
      return;
    }

    const img = await createImageBitmap(blob);
    await WATERMARK.decode();

    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    const w = img.width / 6;
    const h = (WATERMARK.height / WATERMARK.width) * w;
    ctx.globalAlpha = 0.85;
    ctx.drawImage(WATERMARK, img.width - w - 20, img.height - h - 20, w, h);
    ctx.globalAlpha = 1.0;

    canvas.toBlob((b) => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = safeName;
      a.click();
    }, "image/jpeg", 0.95);
  }

  window.addEventListener("DOMContentLoaded", initModels);
  searchBtn.addEventListener("click", performSearch);
  </script>
</body>
</html>
