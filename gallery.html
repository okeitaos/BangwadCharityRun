<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ” Face Search | Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6 relative">
  <h1 class="text-3xl font-bold mb-6 text-center">ğŸ” Face Search | Gallery v2</h1>

  <!-- ğŸ” Search UI -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg w-full max-w-md mb-8 text-center">
    <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />
    <button id="searchBtn" class="w-full bg-green-500 hover:bg-green-600 py-2 rounded-lg mb-4">
      ğŸ” à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸šà¸«à¸™à¹‰à¸²
    </button>
    <div id="status" class="text-sm text-gray-300 mb-2">â³ Initializing...</div>
    <div id="result" class="text-sm text-gray-200"></div>
  </div>

  <!-- ğŸ–¼ï¸ Popup Modal -->
  <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="relative">
      <img id="modalImage" src="" alt="Full View" class="max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl border border-gray-700" />
      <div class="absolute top-2 right-2 flex gap-2">
        <button id="downloadModal" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg shadow">
          ğŸ’¾ Download
        </button>
        <button id="closeModal" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg shadow">
          âœ–ï¸ Close
        </button>
      </div>
    </div>
  </div>

  <script>
  // âš™ï¸ CONFIG
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY"; // ğŸ”’ à¹ƒà¸ªà¹ˆà¸‚à¸­à¸‡à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const BUCKET = "gallery";
  const EDGE_LIMIT = 50;
  const SIM_THRESHOLD = 0.93;
  const DISPLAY_THRESHOLD = 0.95;

  // ğŸ“¦ DOM
  const fileInput = document.getElementById("fileInput");
  const searchBtn = document.getElementById("searchBtn");
  const statusDiv = document.getElementById("status");
  const resultDiv = document.getElementById("result");
  const imageModal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  const closeModal = document.getElementById("closeModal");
  const downloadModal = document.getElementById("downloadModal");

  // ğŸ§  Normalize descriptor
  function normalize(desc) {
    const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
    return desc.map(x => x / norm);
  }

  // ğŸ§© à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ FaceAPI
  async function initModels() {
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    statusDiv.textContent = "â³ à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥...";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
    ]);
    statusDiv.textContent = "âœ… à¸à¸£à¹‰à¸­à¸¡à¸„à¹‰à¸™à¸«à¸²à¹à¸¥à¹‰à¸§";
  }

  // ğŸ’¾ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸—à¸±à¸™à¸—à¸µ
  async function downloadImage(url, filename) {
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename || "download.jpg";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    } catch (err) {
      alert("âŒ à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
      console.error(err);
    }
  }

  // ğŸ” Face Search
  async function performSearch() {
    const file = fileInput.files[0];
    if (!file) return alert("à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸à¹ˆà¸­à¸™à¸„à¹‰à¸™à¸«à¸²");

    resultDiv.innerHTML = "ğŸ§  à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¹ƒà¸šà¸«à¸™à¹‰à¸²...";
    const img = await faceapi.bufferToImage(file);
    const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    if (!det) return resultDiv.innerHTML = "âš ï¸ à¹„à¸¡à¹ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²";

    const queryEmbedding = normalize(Array.from(det.descriptor));
    resultDiv.innerHTML = "ğŸ” à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²...";

    const resp = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        embedding: queryEmbedding,
        threshold: SIM_THRESHOLD,
        limit: EDGE_LIMIT
      })
    });

    const { matches, error } = await resp.json();
    if (error || !matches?.length) {
      resultDiv.innerHTML = "âŒ à¹„à¸¡à¹ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸„à¸¥à¹‰à¸²à¸¢à¸à¸±à¸™";
      return;
    }

    const filtered = matches.filter(m => m.similarity >= DISPLAY_THRESHOLD);
    if (!filtered.length) {
      resultDiv.innerHTML = "âŒ à¹„à¸¡à¹ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™ â‰¥ 95%";
      return;
    }

    resultDiv.innerHTML = `
      <p class="text-green-400 font-semibold mb-2">ğŸ¯ à¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™ â‰¥95% à¸ˆà¸³à¸™à¸§à¸™ ${filtered.length} à¸ à¸²à¸</p>
      <div class="grid grid-cols-2 gap-3">
        ${filtered.map(v => {
          const imgUrl = `${v.image_url}`;
          const fileName = v.name || "face.jpg";
          const owner = v.owner_name || "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰";
          return `
          <div class="bg-slate-700 p-2 rounded-lg hover:scale-105 transition">
            <img src="${imgUrl}" class="rounded-lg mb-2 shadow cursor-pointer" data-img="${imgUrl}">
            <p class="text-sm truncate">${fileName}</p>
            <p class="text-xs text-gray-400">${owner}</p>
            <p class="text-xs text-gray-500">Sim: ${(v.similarity*100).toFixed(2)}%</p>
            <button class="downloadBtn mt-1 text-blue-400 hover:text-blue-200 text-xs" data-url="${imgUrl}" data-name="${fileName}">ğŸ’¾ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”</button>
          </div>`;
        }).join("")}
      </div>`;

    // ğŸ–¼ï¸ à¸„à¸¥à¸´à¸à¸”à¸¹à¸ à¸²à¸à¹à¸šà¸š Popup
    document.querySelectorAll("[data-img]").forEach(el => {
      el.addEventListener("click", () => {
        const imgUrl = el.dataset.img;
        modalImage.src = imgUrl;
        downloadModal.setAttribute("data-url", imgUrl);
        imageModal.classList.remove("hidden");
      });
    });

    // ğŸ’¾ à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹à¸•à¹ˆà¸¥à¸°à¸ à¸²à¸
    document.querySelectorAll(".downloadBtn").forEach(btn => {
      btn.addEventListener("click", e => {
        e.stopPropagation();
        const url = btn.getAttribute("data-url");
        const name = btn.getAttribute("data-name");
        downloadImage(url, name);
      });
    });
  }

  // ğŸ’¾ à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹ƒà¸™ Popup
  downloadModal.addEventListener("click", () => {
    const url = downloadModal.getAttribute("data-url");
    downloadImage(url, "face_result.jpg");
  });

  // âŒ à¸›à¸´à¸” Popup
  closeModal.addEventListener("click", () => imageModal.classList.add("hidden"));
  imageModal.addEventListener("click", e => {
    if (e.target === imageModal) imageModal.classList.add("hidden");
  });

  // ğŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
  window.addEventListener("DOMContentLoaded", initModels);
  searchBtn.addEventListener("click", performSearch);
  </script>
</body>
</html>
