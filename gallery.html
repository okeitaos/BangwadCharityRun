<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì | Bangwad Charity Run</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <!-- üî• ADD -->
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

<style>
.card { transition:.2s }
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 25px rgba(0,0,0,.4);
}
.debug {
  font-size: 10px;
  opacity: .75;
}
</style>
</head>

<body class="bg-slate-900 text-white min-h-screen">

<div class="max-w-7xl mx-auto px-4 py-6 space-y-6">

<h1 class="text-2xl md:text-3xl font-bold text-center text-yellow-400">
üèÉ‚Äç‚ôÇÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
</h1>

<!-- üî• EVENT SELECT -->
<div class="bg-slate-800 rounded-xl p-4 text-center">
  <label class="text-sm text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á</label>
  <select id="eventSelect"
    class="mt-2 w-full bg-slate-700 text-white p-2 rounded-lg">
  </select>
</div>

<!-- Upload -->
<div class="bg-slate-800 rounded-2xl p-5 space-y-3">
  <input id="fileInput" type="file" accept="image/*"
    class="block w-full text-sm
    file:bg-yellow-500 file:text-black
    file:px-5 file:py-2 file:rounded-xl" />
  <div id="status" class="text-sm text-gray-300"></div>
</div>

<!-- Query Preview -->
<div id="queryPreviewBox"
  class="hidden bg-slate-800 rounded-xl p-4 text-center">
  <p class="text-sm text-gray-400 mb-2">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
  <img id="queryPreviewImg"
    class="mx-auto rounded-xl max-h-64 border border-yellow-500/40">
</div>

<div id="resultInfo"
  class="hidden text-sm text-center text-gray-300"></div>

<!-- PRIMARY -->
<div>
<h2 class="text-sm text-green-400 mb-2 text-center">
‚úÖ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á)
</h2>
<div id="primaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
</div>

<!-- SECONDARY -->
<div id="secondarySection" class="hidden mt-8">
<h2 class="text-sm text-yellow-400 mb-2 text-center">
üìå ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
</h2>
<div id="secondaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
</div>

</div>

<!-- PREVIEW MODAL -->
<div id="previewModal"
  class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
  <div class="relative max-w-6xl w-full p-4">
    <button onclick="closePreview()"
      class="absolute top-2 right-2 text-white text-2xl">‚úñ</button>

    <canvas id="previewCanvas"
      class="w-full max-h-[85vh] object-contain rounded-xl mb-4"></canvas>

    <div class="text-center">
      <button id="downloadBtn"
        class="bg-yellow-500 text-black px-6 py-2 rounded-lg font-semibold">
        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥)
      </button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co"; // üî• ADD
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";                     // üî• ADD

const SERVER_API =
  "https://xjdjurdflowiwdxgkvfr.supabase.co/functions/v1/face-search";

const LOGO_URL =
  "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";
/* ========================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // üî• ADD

const eventSelect = document.getElementById("eventSelect"); // üî• ADD
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const queryPreviewBox = document.getElementById("queryPreviewBox");
const queryPreviewImg = document.getElementById("queryPreviewImg");
const resultInfo = document.getElementById("resultInfo");

const primaryBox = document.getElementById("primaryBox");
const secondaryBox = document.getElementById("secondaryBox");
const secondarySection = document.getElementById("secondarySection");

let currentFilename = "";

/* ================= LOAD EVENTS üî• ================= */
async function loadEvents(){
  const { data } = await sb
    .from("events")
    .select("name, slug")
    .eq("is_active", true)
    .order("start_date");

  data.forEach(e=>{
    const opt = document.createElement("option");
    opt.value = e.slug;
    opt.textContent = e.name;
    eventSelect.appendChild(opt);
  });
}
loadEvents();

/* ================= LOAD MODELS ================= */
(async()=>{
  const URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
  statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
  statusEl.innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
})();

/* ================= SEARCH ================= */
fileInput.onchange = async ()=>{
  const file = fileInput.files[0];
  if(!file) return;

  resetUI();

  statusEl.innerText = "üì∏ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const img = await faceapi.bufferToImage(file);

  queryPreviewImg.src = img.src;
  queryPreviewBox.classList.remove("hidden");

  const detections = await faceapi
    .detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
    .withFaceLandmarks()
    .withFaceDescriptors();

  if(!detections.length){
    statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
    return;
  }

  statusEl.innerText = "üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (AI)...";

  const descriptors = detections.map(d => Array.from(d.descriptor));
  const event_slug = eventSelect.value; // üî• ADD

  const res = await fetch(SERVER_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ descriptors, event_slug }) // üî• ADD
  });

  const json = await res.json();
  renderResults(json);
};

/* ================= RENDER ================= */
function renderResults({ primary=[], secondary=[] }) {
  renderBox(primary, primaryBox);

  if(secondary.length){
    secondarySection.classList.remove("hidden");
    renderBox(secondary, secondaryBox);
  }

  resultInfo.classList.remove("hidden");
  resultInfo.innerText =
    `‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${primary.length} ‡∏†‡∏≤‡∏û` +
    (secondary.length ? ` ‚Ä¢ ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ${secondary.length} ‡∏†‡∏≤‡∏û` : "");

  statusEl.innerText = "üéâ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
}

function renderBox(rows, box){
  box.innerHTML = "";
  rows.forEach((r,i)=>{
    const card = document.createElement("div");
    card.className = "card bg-slate-800 rounded-2xl overflow-hidden";

    card.innerHTML = `
      <img src="${r.url}"
        class="w-full h-56 object-cover cursor-pointer"
        onclick="openPreview('${r.url}','photo_${i+1}.jpg')">
      <div class="p-3 text-xs text-gray-400 flex justify-between">
        <span>Similarity ${r.similarity}</span>
        ${r.debug ? `<span class="debug text-red-400">${r.debug}</span>` : ``}
      </div>
    `;
    box.appendChild(card);
  });
}

/* ================= HELPERS ================= */
function resetUI(){
  primaryBox.innerHTML="";
  secondaryBox.innerHTML="";
  secondarySection.classList.add("hidden");
  resultInfo.classList.add("hidden");
}
</script>

</body>
</html>
