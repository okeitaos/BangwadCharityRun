<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Auto Cache)</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

<style>
  body{font-family:"Prompt",sans-serif;margin:0;background:#0f172a;color:#fff;text-align:center;padding:20px}
  h1{color:#facc15}
  #uploadInput{margin:12px;padding:10px;border-radius:14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12)}
  #status{color:#facc15;margin:8px;font-weight:600}
  .progress{width:80%;max-width:900px;margin:14px auto;background:rgba(255,255,255,0.06);height:18px;border-radius:9px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .2s}
  .controls{margin:12px}
  button{margin:6px;padding:8px 14px;border-radius:12px;border:none;cursor:pointer}
  .btn{background:#06C755;color:#fff}
  .btn-muted{background:#334155;color:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;max-width:1100px;margin:18px auto}
  .card{background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,0.4)}
  .card img{width:100%;height:180px;object-fit:cover}
  .card p{margin:8px;color:#eee}
  small{opacity:.75}
  #cacheInfo{margin-top:8px;color:#cbd5e1}
</style>
</head>
<body>
  <h1>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Auto Cache)</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á descriptor ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>

  <input id="uploadInput" type="file" accept="image/*">
  <div id="status">‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <div class="controls">
    <button id="btnClear" class="btn-muted">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á Cache</button>
    <button id="btnReindex" class="btn">üîÅ ‡∏£‡∏µ‡∏Ñ‡∏≤‡∏•‡∏Ñ‡∏π‡πÄ‡∏•‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <span id="cacheInfo"></span>
  </div>

  <div id="resultGrid" class="grid"></div>

<script>
/* === CONFIG === */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const BUCKET = "gallery";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";
const DB_NAME = "face-cache", DB_STORE = "descriptors";
const BATCH_SIZE = 25;

/* === IndexedDB === */
function openDb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(DB_STORE)){db.createObjectStore(DB_STORE,{keyPath:"url"})}};r.onsuccess=e=>res(e.target.result);r.onerror=e=>rej(e.target.error)})}
async function idbGetAll(){const db=await openDb();return new Promise((res,rej)=>{const t=db.transaction(DB_STORE,"readonly");const s=t.objectStore(DB_STORE);const q=s.getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}
async function idbPut(item){const db=await openDb();return new Promise((res,rej)=>{const t=db.transaction(DB_STORE,"readwrite");const s=t.objectStore(DB_STORE);const q=s.put(item);q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error)})}
async function idbClear(){const db=await openDb();return new Promise((res,rej)=>{const t=db.transaction(DB_STORE,"readwrite");const s=t.objectStore(DB_STORE);const q=s.clear();q.onsuccess=()=>res(true);q.onerror=()=>rej(q.error)})}

/* === FaceAPI === */
let modelsLoaded=false;
async function loadModels(){
  const s=document.getElementById("status");
  s.innerText="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  modelsLoaded=true;
  s.innerText="‚úÖ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
}
function euclid(a,b){let sum=0;for(let i=0;i<a.length;i++){const d=a[i]-b[i];sum+=d*d;}return Math.sqrt(sum);}
async function descriptorFromUrl(url){const img=await faceapi.fetchImage(url);const det=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();return det?Array.from(det.descriptor):null;}
async function descriptorFromFile(file){const img=await faceapi.bufferToImage(file);const det=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();return det?Array.from(det.descriptor):null;}

/* === Supabase list === */
async function listAllImages(){
  const {data:folders}=await sb.storage.from(BUCKET).list("",{limit:100});
  const images=[];
  for(const folder of folders||[]){
    if(!folder.name||folder.name.startsWith("."))continue;
    const {data:files}=await sb.storage.from(BUCKET).list(folder.name+"/",{limit:10000});
    for(const f of files||[]){
      if(/\.(jpe?g|png)$/i.test(f.name)){
        images.push({url:`${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${folder.name}/${f.name}`,name:f.name,folder:folder.name});
      }
    }
  }
  return images;
}

/* === Cache handling === */
async function ensureCacheIndexed(allImages){
  const status=document.getElementById("status");
  const bar=document.getElementById("bar");
  const cached=await idbGetAll();
  const cachedMap=new Map(cached.map(c=>[c.url,c]));
  const missing=allImages.filter(img=>!cachedMap.has(img.url));
  if(missing.length===0){status.innerText=`‚úÖ Cache ‡∏û‡∏£‡πâ‡∏≠‡∏° (${cached.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;updateCacheInfo();return;}
  status.innerText=`‚öôÔ∏è ‡∏û‡∏ö ${missing.length} ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á descriptor...`;
  let done=0;
  for(let i=0;i<missing.length;i+=BATCH_SIZE){
    const batch=missing.slice(i,i+BATCH_SIZE);
    await Promise.all(batch.map(async img=>{
      try{
        const desc=await descriptorFromUrl(img.url);
        await idbPut({url:img.url,name:img.name,folder:img.folder,descriptor:desc});
      }catch{await idbPut({url:img.url,name:img.name,folder:img.folder,descriptor:null,noface:true});}
    }));
    done+=batch.length;
    bar.style.width=Math.min((done/missing.length)*100,100)+"%";
    await new Promise(r=>setTimeout(r,80));
  }
  bar.style.width="0%";
  status.innerText=`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á descriptor ‡πÄ‡∏™‡∏£‡πá‡∏à (${missing.length})`;
  updateCacheInfo();
}

/* === Search === */
async function onSearchFile(file){
  const status=document.getElementById("status");
  const bar=document.getElementById("bar");
  const grid=document.getElementById("resultGrid");
  if(!modelsLoaded)return alert("‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πà‡∏≠‡∏ô");
  status.innerText="üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const q=await descriptorFromFile(file);
  if(!q){status.innerText="‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";return;}
  const cache=await idbGetAll();
  const valid=cache.filter(c=>Array.isArray(c.descriptor)&&c.descriptor.length>0);
  if(!valid.length){status.innerText="‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ descriptor ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á";return;}
  const results=[];
  const chunk=300;
  for(let i=0;i<valid.length;i+=chunk){
    const part=valid.slice(i,i+chunk);
    for(const item of part){
      const d=euclid(q,item.descriptor);
      if(d<0.6)results.push({...item,distance:d});
    }
    bar.style.width=Math.min(((i+chunk)/valid.length)*100,100)+"%";
    await new Promise(r=>setTimeout(r,10));
  }
  bar.style.width="0%";
  if(!results.length){status.innerText="üò¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô";grid.innerHTML="";return;}
  results.sort((a,b)=>a.distance-b.distance);
  status.innerText=`‚úÖ ‡∏û‡∏ö ${results.length} ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô (‡πÅ‡∏™‡∏î‡∏á top 50)`;
  renderResults(results.slice(0,50));
}
function renderResults(list){
  const g=document.getElementById("resultGrid");
  g.innerHTML=list.map(i=>`
  <div class="card">
    <img src="${i.url}">
    <p>${i.name}<br><small>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: ${i.distance.toFixed(3)}</small></p>
  </div>`).join("");
}

/* === UI + Events === */
document.getElementById("uploadInput").addEventListener("change",async e=>{
  const f=e.target.files[0];if(!f)return;await onSearchFile(f);
});
document.getElementById("btnClear").addEventListener("click",async()=>{
  if(confirm("‡∏•‡πâ‡∏≤‡∏á Cache ‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")){await idbClear();updateCacheInfo();document.getElementById("status").innerText="üóëÔ∏è Cache ‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á";}
});
document.getElementById("btnReindex").addEventListener("click",async()=>{
  document.getElementById("status").innerText="üîÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á descriptor ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà...";
  const imgs=await listAllImages();await ensureCacheIndexed(imgs);
});

/* === Helpers === */
async function updateCacheInfo(){
  const all=await idbGetAll();
  const total=all.filter(a=>a.descriptor&&a.descriptor.length>0).length;
  document.getElementById("cacheInfo").innerText=`Cache: ${total}/${all.length} descriptors`;
}

/* === Main init === */
(async()=>{
  try{
    await loadModels();
    const images=await listAllImages();
    document.getElementById("status").innerText=`üì¶ ‡∏û‡∏ö ${images.length} ‡∏£‡∏π‡∏õ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à Cache...`;
    await ensureCacheIndexed(images); // üëà ‡∏ó‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    await updateCacheInfo();
    document.getElementById("status").innerText="‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
  }catch(e){
    console.error(e);
    document.getElementById("status").innerText="‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message;
  }
})();
</script>
</body>
</html>
