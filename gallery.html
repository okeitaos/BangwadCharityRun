<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì | Bangwad Charity Run</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

<style>
.card {
  transition: transform .25s ease, box-shadow .25s ease;
}
.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
}
</style>
</head>

<body class="bg-slate-950 text-white min-h-screen select-none">

<div class="max-w-7xl mx-auto px-4 py-8 space-y-8">

<!-- HEADER -->
<h1 class="text-3xl md:text-4xl font-extrabold text-center text-yellow-400">
üèÉ‚Äç‚ôÇÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
</h1>
<p class="text-center text-gray-400 text-sm">
‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‚Ä¢ ‡πÄ‡∏à‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏Ñ‡∏∏‡∏ì‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
</p>

<!-- UPLOAD -->
<div class="bg-slate-800 rounded-2xl p-6 space-y-3">
  <input id="fileInput" type="file" accept="image/*"
    class="block w-full text-sm
    file:bg-yellow-500 file:text-black
    file:px-6 file:py-2 file:rounded-xl" />
  <div id="status" class="text-sm text-gray-300"></div>
</div>

<!-- QUERY PREVIEW -->
<div id="queryBox" class="hidden bg-slate-800 rounded-2xl p-4 text-center">
  <p class="text-xs text-gray-400 mb-2">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
  <img id="queryImg" class="mx-auto max-h-64 rounded-xl border border-yellow-400/30">
</div>

<!-- INFO -->
<div id="info" class="hidden text-center text-sm text-gray-300"></div>

<!-- PRIMARY -->
<section>
<h2 class="text-sm text-green-400 text-center mb-3">
‚úÖ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á)
</h2>
<div id="primaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-5"></div>
</section>

<!-- SECONDARY -->
<section id="secondarySection" class="hidden">
<h2 class="text-sm text-yellow-400 text-center mb-3">
üìå ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
</h2>
<div id="secondaryBox"
  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-5"></div>
</section>

</div>

<!-- PREVIEW MODAL -->
<div id="modal"
  class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center">
  <div class="relative max-w-6xl w-full p-4">
    <button onclick="closeModal()"
      class="absolute top-2 right-2 text-white text-3xl">‚úñ</button>

    <canvas id="canvas"
      class="w-full max-h-[85vh] rounded-xl mb-4"></canvas>

    <div class="text-center">
      <button id="downloadBtn"
        class="bg-yellow-500 text-black px-8 py-3 rounded-xl font-bold">
        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥)
      </button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const LOGO_URL =
"https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";

const RESULT_LIMIT = 200;
const HARD_MAX = 0.45;
const PRIMARY_MAX = 0.30;
const MAX_JUMP = 0.12;
/* ========================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = id => document.getElementById(id);

/* ================= LOAD MODELS ================= */
(async () => {
  const URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
  el("status").innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö AI...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
  el("status").innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
})();

/* ================= SEARCH ================= */
el("fileInput").onchange = async () => {
  const file = el("fileInput").files[0];
  if (!file) return;

  el("primaryBox").innerHTML = "";
  el("secondaryBox").innerHTML = "";
  el("secondarySection").classList.add("hidden");
  el("info").classList.add("hidden");

  el("status").innerText = "üì∏ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  const img = await faceapi.bufferToImage(file);
  el("queryImg").src = img.src;
  el("queryBox").classList.remove("hidden");

  const faces = await faceapi
    .detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
    .withFaceLandmarks()
    .withFaceDescriptors();

  if (!faces.length) {
    el("status").innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
    return;
  }

  el("status").innerText = `üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ${faces.length} ‡∏Ñ‡∏ô...`;

  let results = [];
  for (const f of faces) {
    const vector = "[" + Array.from(f.descriptor).join(",") + "]";
    const { data } = await sb.rpc("search_face_ranked", {
      query_vector: vector,
      result_limit: RESULT_LIMIT
    });
    if (data) results.push(...data);
  }

  renderGOD(results);
};

/* ================= GOD MODE LOGIC ================= */
function renderGOD(rows) {
  let list = rows
    .filter(r => r.distance <= HARD_MAX)
    .sort((a,b)=>a.distance-b.distance);

  if (!list.length) return;

  // Primary cluster
  let primaryRaw = [list[0]];
  for (let i=1;i<list.length;i++){
    const jump = list[i].distance - list[i-1].distance;
    if (list[i].distance <= PRIMARY_MAX && jump <= MAX_JUMP)
      primaryRaw.push(list[i]);
    else break;
  }

  // Identity consistency
  const anchors = primaryRaw.slice(0,3);
  const primary = primaryRaw.filter(r=>{
    let v=0;
    for (const a of anchors)
      if (Math.abs(r.distance-a.distance)<0.08) v++;
    return v>=2 || anchors.length===1;
  });

  // Secondary = everything else
  let secondary = list.slice(primaryRaw.length);

  // UX GUARANTEE
  if (secondary.length===0 && primary.length>1)
    secondary = primary.slice(1);

  draw(primary, "primaryBox");
  if (secondary.length){
    el("secondarySection").classList.remove("hidden");
    draw(secondary, "secondaryBox");
  }

  el("info").classList.remove("hidden");
  el("info").innerText =
    `‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${primary.length} ‡∏†‡∏≤‡∏û` +
    (secondary.length ? ` ‚Ä¢ ‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ${secondary.length} ‡∏†‡∏≤‡∏û` : "");
}

/* ================= RENDER ================= */
function draw(rows, boxId){
  const box = el(boxId);
  rows.forEach((r,i)=>{
    const url = sb.storage.from("gallery")
      .getPublicUrl(r.file_path).data.publicUrl;

    const d = document.createElement("div");
    d.className = "card bg-slate-800 rounded-2xl overflow-hidden";
    d.innerHTML = `
      <img src="${url}" class="w-full h-56 object-cover cursor-pointer"
        onclick="openModal('${url}','photo_${i+1}.jpg')">
      <div class="p-3 text-xs text-gray-400">
        Similarity ${(1-r.distance).toFixed(2)}
      </div>`;
    box.appendChild(d);
  });
}

/* ================= PREVIEW + WATERMARK ================= */
async function openModal(url, name){
  el("modal").classList.remove("hidden");
  const img = new Image(), logo = new Image();
  img.crossOrigin = logo.crossOrigin = "anonymous";
  img.src = url; logo.src = LOGO_URL;

  await Promise.all([img.onload, logo.onload]);

  const c = el("canvas"), ctx = c.getContext("2d");
  c.width = img.width; c.height = img.height;
  ctx.drawImage(img,0,0);

  const pad = c.width*0.03;
  ctx.globalAlpha = 0.45;
  ctx.fillStyle = "white";
  ctx.font = `bold ${c.width*0.02}px Arial`;
  ctx.textAlign = "center";
  ctx.fillText(
    "BANGWAD CHARITY RUN 2025 | OFFICIAL PHOTOGRAPHER",
    c.width/2, c.height-pad*0.4
  );
  ctx.globalAlpha = 1;

  const w = c.width*0.15;
  ctx.drawImage(
    logo,
    c.width-w-pad,
    c.height-(w*(logo.height/logo.width))-pad*1.6,
    w, w*(logo.height/logo.width)
  );

  el("downloadBtn").onclick = ()=>{
    const a = document.createElement("a");
    a.href = c.toDataURL("image/jpeg",0.95);
    a.download = name;
    a.click();
  };
}

function closeModal(){
  el("modal").classList.add("hidden");
}

/* ===== Block Right Click & DevTools ===== */
document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  const k=e.key.toUpperCase();
  if(k==="F12"||(e.ctrlKey&&e.shiftKey&&["I","J","C"].includes(k))||(e.ctrlKey&&k==="U"))
    e.preventDefault();
});
</script>

</body>
</html>
