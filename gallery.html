<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Face API -->
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

<style>
  .thumb { transition: transform .2s; }
  .thumb:hover { transform: scale(1.05); }
</style>
</head>

<body class="bg-slate-900 text-white min-h-screen">

<div class="max-w-6xl mx-auto p-4 space-y-6">

  <h1 class="text-2xl font-bold text-center text-yellow-400">
    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
  </h1>

  <!-- Upload -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-3">
    <input
      id="fileInput"
      type="file"
      accept="image/*"
      class="block w-full text-sm
        file:bg-yellow-500
        file:text-black
        file:px-4
        file:py-2
        file:rounded-lg"
    />
    <div id="status" class="text-sm text-gray-300"></div>
  </div>

  <!-- Preview -->
  <div id="previewBox" class="hidden bg-slate-800 rounded-xl p-4 text-center">
    <img id="previewImg" class="mx-auto rounded-xl max-h-64">
  </div>

  <!-- Results -->
  <div
    id="resultBox"
    class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"
  ></div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
const DISTANCE_THRESHOLD = 0.45;
/* ========================================= */

/* üîë IMPORTANT:
   ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ sb ‡πÅ‡∏ó‡∏ô supabase
   ‡∏Å‡∏±‡∏ô error Identifier already declared */
const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const previewImg = document.getElementById("previewImg");
const previewBox = document.getElementById("previewBox");
const resultBox = document.getElementById("resultBox");

/* ================= LOAD MODELS ================= */
async function loadModels() {
  const MODEL_URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
  statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";

  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

  statusEl.innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
}
loadModels();

/* ================= HANDLE FILE ================= */
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  resultBox.innerHTML = "";
  statusEl.innerText = "üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";

  const img = await faceapi.bufferToImage(file);
  previewImg.src = img.src;
  previewBox.classList.remove("hidden");

  const detection = await faceapi
    .detectSingleFace(
      img,
      new faceapi.TinyFaceDetectorOptions({
        inputSize: 416,
        scoreThreshold: 0.4
      })
    )
    .withFaceLandmarks()
    .withFaceDescriptor();

  if (!detection) {
    statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
    return;
  }

  // vector ‚Üí pgvector literal
  const vectorLiteral =
    "[" + Array.from(detection.descriptor).join(",") + "]";

  statusEl.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ...";

  const { data, error } = await sb.rpc("search_face", {
    query_vector: vectorLiteral,
    threshold: DISTANCE_THRESHOLD,
    result_limit: 100
  });

  if (error) {
    console.error(error);
    statusEl.innerText = "‚ùå ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    return;
  }

  if (!data || data.length === 0) {
    statusEl.innerText = "üò¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô";
    return;
  }

  statusEl.innerText = `üéâ ‡∏û‡∏ö ${data.length} ‡∏†‡∏≤‡∏û`;

  renderResults(data);
};

/* ================= RENDER ================= */
function renderResults(rows) {
  resultBox.innerHTML = "";

  rows.forEach(r => {
    const url = sb
      .storage
      .from("gallery")
      .getPublicUrl(r.file_path).data.publicUrl;

    const div = document.createElement("div");
    div.className = "thumb";

    div.innerHTML = `
      <img src="${url}" class="rounded-lg w-full">
      <div class="text-xs text-center text-gray-400 mt-1">
        similarity ${(1 - r.distance).toFixed(2)}
      </div>
    `;

    resultBox.appendChild(div);
  });
}
</script>

</body>
</html>
