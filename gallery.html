<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

  <style>
    .filename {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      width: 100%;
      text-align: center;
    }

    #previewPopup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      overflow-y: auto;
      padding: 2rem 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }

    #previewPopup.show {
      opacity: 1;
      pointer-events: auto;
    }

    #previewPopup > div {
      background: #1e293b;
      border-radius: 1rem;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
      text-align: center;
      max-width: 600px;
      width: 100%;
      margin: auto;
      transform: translateY(20px);
      transition: transform 0.35s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #previewPopup.show > div {
      transform: translateY(0);
    }

    #previewCanvas {
      max-width: 100%;
      max-height: 75vh;
      object-fit: contain;
      border: 2px solid white;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #confirmDownload, #cancelPreview {
      transition: transform 0.15s ease, background 0.25s;
    }

    #confirmDownload:hover, #cancelPreview:hover {
      transform: scale(1.05);
    }

    @media (max-width: 640px) {
      #previewPopup > div {
        width: 95%;
        padding: 1rem;
      }
      #previewCanvas {
        max-height: 60vh;
      }
    }
  </style>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <div class="w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
      <button id="langToggle" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">EN</button>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl shadow-lg text-center">
      <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />
      <div class="flex gap-2 mb-4">
        <button id="searchBtn" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg">
          üîé <span id="btnSearchText">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û</span>
        </button>
        <button id="clearBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg">
          üßπ <span id="btnClearText">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</span>
        </button>
      </div>

      <div class="mb-4 text-left">
        <label for="threshold" id="thresholdLabel" class="block text-sm text-gray-300 mb-1">
          ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (95%)
        </label>
        <input id="threshold" type="range" min="80" max="99" value="95" class="w-full accent-green-500">
        <p id="thresholdValue" class="text-xs text-gray-400 mt-1 text-center">‚â• 95%</p>
      </div>

      <p id="status" class="text-gray-400 text-sm mb-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</p>
      <div id="result" class="text-sm text-gray-200"></div>
    </div>
  </div>

  <!-- üÜï Popup Preview -->
  <div id="previewPopup">
    <div class="bg-slate-800 p-4 rounded-xl shadow-xl text-center max-w-lg w-[90%]">
      <h2 class="text-lg font-semibold mb-3">üñºÔ∏è Preview ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</h2>
      <canvas id="previewCanvas" class="max-w-full rounded-lg shadow-lg border-2 border-white mb-3"></canvas>
      <div class="flex justify-center gap-3">
        <button id="confirmDownload" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
          ‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        </button>
        <button id="cancelPreview" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
          ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
    const BUCKET = "gallery";
    const WATERMARK_URL =
      "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";
    let SIM_THRESHOLD = 0.95;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fileInput = document.getElementById("fileInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusDiv = document.getElementById("status");
    const resultDiv = document.getElementById("result");
    const langToggle = document.getElementById("langToggle");
    const thresholdInput = document.getElementById("threshold");
    const thresholdLabel = document.getElementById("thresholdLabel");
    const thresholdValue = document.getElementById("thresholdValue");
    const title = document.getElementById("title");
    const btnSearchText = document.getElementById("btnSearchText");
    const btnClearText = document.getElementById("btnClearText");
    const previewPopup = document.getElementById("previewPopup");
    const previewCanvas = document.getElementById("previewCanvas");
    const confirmDownload = document.getElementById("confirmDownload");
    const cancelPreview = document.getElementById("cancelPreview");

    const LANG = {
      th: {
        title: "üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤",
        choose: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô",
        analyzing: "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...",
        notFound: "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ",
        searching: (v) => `üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‚â•${v}%)`,
        found: (n, v) => `üéØ ‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚â•${v}% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} ‡∏†‡∏≤‡∏û`,
        btnSearch: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û",
        btnClear: "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå",
        level: (v) => `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (${v}%)`,
        ready: "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        loading: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...",
        download: "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î",
      },
      en: {
        title: "üì∏ Face Search",
        choose: "Please select an image first.",
        analyzing: "üß† Detecting face...",
        notFound: "‚ö†Ô∏è No face detected in this image.",
        searching: (v) => `üîç Searching for similar faces (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå No similar faces found (‚â•${v}%)`,
        found: (n, v) => `üéØ Found ${n} similar faces (‚â•${v}%)`,
        btnSearch: "Search",
        btnClear: "Clear",
        level: (v) => `Similarity Level (${v}%)`,
        ready: "‚úÖ Ready to use",
        loading: "‚è≥ Loading model...",
        download: "Download",
      },
    };

    let currentLang = "th";
    function setLang(lang) {
      currentLang = lang;
      const t = LANG[lang];
      title.textContent = t.title;
      btnSearchText.textContent = t.btnSearch;
      btnClearText.textContent = t.btnClear;
      thresholdLabel.textContent = t.level(Math.round(SIM_THRESHOLD * 100));
      thresholdValue.textContent = `‚â• ${Math.round(SIM_THRESHOLD * 100)}%`;
      langToggle.textContent = lang === "th" ? "EN" : "TH";
      statusDiv.textContent = t.ready;
    }

    langToggle.onclick = () => setLang(currentLang === "th" ? "en" : "th");

    statusDiv.textContent = LANG[currentLang].loading;
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL),
    ]);
    statusDiv.textContent = LANG[currentLang].ready;

    const normalize = (desc) => {
      const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
      return desc.map((x) => x / norm);
    };

    thresholdInput.oninput = (e) => {
      const v = e.target.value;
      SIM_THRESHOLD = v / 100;
      thresholdLabel.textContent = LANG[currentLang].level(v);
      thresholdValue.textContent = `‚â• ${v}%`;
    };

    clearBtn.onclick = () => {
      fileInput.value = "";
      resultDiv.innerHTML = "";
      statusDiv.textContent = LANG[currentLang].ready;
    };

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
    async function previewWatermarkedImage(imageUrl, fileName) {
      const [imgRes, watermarkRes] = await Promise.all([fetch(imageUrl), fetch(WATERMARK_URL)]);
      const [imgBlob, watermarkBlob] = await Promise.all([imgRes.blob(), watermarkRes.blob()]);
      const img = await createImageBitmap(imgBlob);
      const watermark = await createImageBitmap(watermarkBlob);
      const ctx = previewCanvas.getContext("2d");
      previewCanvas.width = img.width;
      previewCanvas.height = img.height;
      ctx.drawImage(img, 0, 0, img.width, img.height);

      // ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
      const aspectRatio = img.width / img.height;
      let scaleFactor;
      if (aspectRatio > 1.3) scaleFactor = 0.18;
      else if (aspectRatio < 0.8) scaleFactor = 0.28;
      else scaleFactor = 0.22;

      const w = img.width * scaleFactor;
      const s = w / watermark.width;
      const h = watermark.height * s;
      const x = img.width - w - 20;
      const y = img.height - h - 20;
      ctx.drawImage(watermark, x, y, w, h);

      // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á (‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å ‡∏™‡∏µ‡∏à‡∏≤‡∏á ‡πÄ‡∏á‡∏≤‡πÄ‡∏ö‡∏≤)
      const text = "BANGWAD CHARITY RUN 2025 | OFFICAIL";
      const fontSize = Math.floor(img.width * 0.022);
      ctx.font = `${fontSize}px 'Poppins', sans-serif`;
      ctx.fillStyle = "rgba(255,255,255,0.65)";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.shadowColor = "rgba(0,0,0,0.4)";
      ctx.shadowBlur = 4;
      ctx.fillText(text, img.width / 2, img.height - 12);

      previewPopup.classList.add("show");

      confirmDownload.onclick = () => {
        previewCanvas.toBlob((b) => {
          const l = document.createElement("a");
          l.href = URL.createObjectURL(b);
          l.download = fileName;
          l.click();
        }, "image/jpeg", 0.95);
        previewPopup.classList.remove("show");
      };

      cancelPreview.onclick = () => previewPopup.classList.remove("show");
    }

    window.downloadImage = async (url, name) => {
      await previewWatermarkedImage(url, name);
    };

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    searchBtn.onclick = async () => {
      const langPack = LANG[currentLang];
      const file = fileInput.files[0];
      if (!file) return alert(langPack.choose);

      resultDiv.innerHTML = langPack.analyzing;
      const img = await faceapi.bufferToImage(file);
      const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
      if (!det) return (resultDiv.innerHTML = langPack.notFound);

      const embedding = normalize(Array.from(det.descriptor));
      statusDiv.textContent = langPack.searching(Math.round(SIM_THRESHOLD * 100));

      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({ embedding, threshold: SIM_THRESHOLD, limit: 999 }),
        });
        const { matches, error } = await res.json();
        if (error) throw new Error(error);
        if (!matches?.length)
          return (resultDiv.innerHTML = langPack.noMatch(Math.round(SIM_THRESHOLD * 100)));

        resultDiv.innerHTML = `
          <p class="text-green-400 font-semibold mb-2">${langPack.found(matches.length, Math.round(SIM_THRESHOLD * 100))}</p>
          <div class="grid grid-cols-2 gap-3">
            ${matches
              .map(
                (m) => `
             <div class="bg-slate-700 p-2 rounded-lg overflow-hidden relative">
  <div class="relative">
    <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}" 
         class="rounded-lg mb-2 shadow w-full object-cover aspect-[3/4]" >
    <img src="https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png"
         class="absolute bottom-2 right-2 w-1/4 opacity-100 pointer-events-none select-none">
  </div>
  <p class="filename text-sm text-gray-200 mt-1" title="${m.name}">${m.name}</p>
  <p class="text-xs text-gray-400 mb-2 text-center">Similarity: ${(m.similarity * 100).toFixed(2)}%</p>
  <button onclick="downloadImage('${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}','${m.name}.jpg')" 
          class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs rounded px-2 py-1">${langPack.download}</button>
</div>
            `
              )
              .join("")}
          </div>
        `;
      } catch (e) {
        resultDiv.innerHTML = `‚ùå ${e.message}`;
      }
    };

    setLang("th");

    document.addEventListener("contextmenu", (e) => e.preventDefault());
    document.addEventListener("dragstart", (e) => e.preventDefault());

    previewPopup.addEventListener("click", (e) => {
      if (e.target === previewPopup) previewPopup.classList.remove("show");
    });
  </script>
</body>
</html>
