<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Face Search</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
</head>

<body class="bg-slate-900 text-white p-6">
<input type="file" id="file" class="mb-4" />
<button id="search" class="bg-green-600 px-4 py-2 rounded">à¸„à¹‰à¸™à¸«à¸²</button>
<div id="result" class="mt-4 grid grid-cols-2 gap-3"></div>

<script type="module">
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const BUCKET = "gallery";

await Promise.all([
  faceapi.nets.ssdMobilenetv1.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/"),
  faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/"),
  faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/")
]);

search.onclick = async () => {
  const file = document.getElementById("file").files[0];
  if (!file) return alert("à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›");

  const img = await faceapi.bufferToImage(file);
  const detections = await faceapi
    .detectAllFaces(img)
    .withFaceLandmarks()
    .withFaceDescriptors();

  if (!detections.length) return alert("à¹„à¸¡à¹ˆà¸žà¸šà¹ƒà¸šà¸«à¸™à¹‰à¸²");

  // à¹€à¸¥à¸·à¸­à¸à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹ƒà¸«à¸à¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸”
  const area = d => d.detection.box.width * d.detection.box.height;
  const main = detections.reduce((a,b)=>area(b)>area(a)?b:a);

  const embedding = Array.from(main.descriptor);

  const res = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      embedding,
      threshold: 0.8,
      limit: 300
    })
  });

  const { matches } = await res.json();
  if (!matches.length) return alert("à¹„à¸¡à¹ˆà¹€à¸ˆà¸­");

  // ðŸ”’ GAP filter + cluster
  const GAP = 0.08;
  const top = matches[0].similarity;
  const near = matches.filter(m => top - m.similarity <= GAP);

  const countByImage = {};
  for (const m of near) {
    countByImage[m.image_url] = (countByImage[m.image_url] || 0) + 1;
  }

  const final = near.filter(m => countByImage[m.image_url] >= 2);

  result.innerHTML = final.map(m => `
    <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}"
         class="rounded shadow">
  `).join("");
};
</script>
</body>
</html>
