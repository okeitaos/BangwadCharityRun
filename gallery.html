<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì | Charity Run</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>

<style>
  .card {
    transition: transform .2s, box-shadow .2s;
  }
  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0,0,0,.4);
  }
</style>
</head>

<body class="bg-slate-900 text-white min-h-screen">

<div class="max-w-7xl mx-auto px-4 py-6 space-y-6">

  <!-- Header -->
  <h1 class="text-2xl md:text-3xl font-bold text-center text-yellow-400">
    üèÉ‚Äç‚ôÇÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  </h1>

  <!-- Upload -->
  <div class="bg-slate-800 rounded-2xl p-5 space-y-3">
    <input id="fileInput" type="file" accept="image/*"
      class="block w-full text-sm
      file:bg-yellow-500 file:text-black
      file:px-5 file:py-2 file:rounded-xl" />
    <div id="status" class="text-sm text-gray-300"></div>
  </div>

  <!-- Query Preview -->
  <div id="queryPreviewBox"
       class="hidden bg-slate-800 rounded-2xl p-4 text-center">
    <p class="text-sm text-gray-400 mb-2">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
    <img id="queryPreviewImg"
         class="mx-auto rounded-xl max-h-64 border border-yellow-500/40">
  </div>

  <!-- Result Info -->
  <div id="resultInfo"
       class="hidden text-sm text-center text-gray-300">
  </div>

  <!-- Primary Results -->
  <div>
    <h2 class="text-sm text-green-400 mb-2 text-center">
      ‚úÖ ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á)
    </h2>
    <div id="primaryBox"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    </div>
  </div>

  <!-- Secondary Results -->
  <div id="secondarySection" class="hidden mt-8">
    <h2 class="text-sm text-yellow-400 mb-2 text-center">
      ‚ö†Ô∏è ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
    </h2>
    <div id="secondaryBox"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üîë ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
const LOGO_URL =
  "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";
const RESULT_LIMIT = 500;
/* ========================================= */

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const resultInfo = document.getElementById("resultInfo");

const primaryBox = document.getElementById("primaryBox");
const secondaryBox = document.getElementById("secondaryBox");
const secondarySection = document.getElementById("secondarySection");

const queryPreviewBox = document.getElementById("queryPreviewBox");
const queryPreviewImg = document.getElementById("queryPreviewImg");

/* ================= LOAD MODELS ================= */
async function loadModels() {
  const MODEL_URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
  statusEl.innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  statusEl.innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
}
loadModels();

/* ================= SPLIT RESULTS (‡∏ó‡∏≤‡∏á A) ================= */
function splitResults(rows) {
  if (!rows || rows.length === 0) {
    return { primary: [], secondary: [] };
  }

  const sorted = [...rows].sort((a, b) => a.distance - b.distance);

  const primary = [sorted[0]]; // anchor
  const secondary = [];

  const MAX_JUMP = 0.12;
  const ABS_MAX_PRIMARY = 0.70;
  const ABS_MAX_SECONDARY = 0.80;

  let cutIndex = 1;

  // primary (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á)
  for (let i = 1; i < sorted.length; i++) {
    const jump = sorted[i].distance - sorted[i - 1].distance;

    if (sorted[i].distance > ABS_MAX_PRIMARY) break;
    if (jump > MAX_JUMP) break;

    primary.push(sorted[i]);
    cutIndex = i + 1;
  }

  // secondary (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πà)
  for (let i = cutIndex; i < sorted.length; i++) {
    if (sorted[i].distance <= ABS_MAX_SECONDARY) {
      secondary.push(sorted[i]);
    }
  }

  return { primary, secondary };
}

/* ================= SEARCH ================= */
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  primaryBox.innerHTML = "";
  secondaryBox.innerHTML = "";
  secondarySection.classList.add("hidden");
  resultInfo.classList.add("hidden");

  statusEl.innerText = "üì∏ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";

  const img = await faceapi.bufferToImage(file);

  // Show query preview
  queryPreviewImg.src = img.src;
  queryPreviewBox.classList.remove("hidden");

  const detection = await faceapi
    .detectSingleFace(
      img,
      new faceapi.TinyFaceDetectorOptions({ inputSize: 416 })
    )
    .withFaceLandmarks()
    .withFaceDescriptor();

  if (!detection) {
    statusEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
    return;
  }

  const vectorLiteral =
    "[" + Array.from(detection.descriptor).join(",") + "]";

  statusEl.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...";

  const { data, error } = await sb.rpc("search_face_ranked", {
    query_vector: vectorLiteral,
    result_limit: RESULT_LIMIT
  });

  if (error || !data) {
    console.error(error);
    statusEl.innerText = "‚ùå ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    return;
  }

  const { primary, secondary } = splitResults(data);

  statusEl.innerText = "üéâ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  resultInfo.classList.remove("hidden");
  resultInfo.innerText =
    `‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${primary.length} ‡∏†‡∏≤‡∏û` +
    (secondary.length ? ` ‚Ä¢ ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πà ${secondary.length} ‡∏†‡∏≤‡∏û` : "");

  renderPrimary(primary);
  renderSecondary(secondary);
};

/* ================= DOWNLOAD + WATERMARK ================= */
async function downloadWithWatermark(imageUrl, filename) {
  const img = new Image();
  const logo = new Image();
  img.crossOrigin = "anonymous";
  logo.crossOrigin = "anonymous";

  img.src = imageUrl;
  logo.src = LOGO_URL;

  await Promise.all([
    new Promise(r => img.onload = r),
    new Promise(r => logo.onload = r)
  ]);

  const canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext("2d");

  ctx.drawImage(img, 0, 0);

  const logoW = canvas.width * 0.15;
  const logoH = logoW * (logo.height / logo.width);
  const pad = canvas.width * 0.02;

  ctx.globalAlpha = 0.85;
  ctx.drawImage(
    logo,
    canvas.width - logoW - pad,
    canvas.height - logoH - pad,
    logoW,
    logoH
  );
  ctx.globalAlpha = 1;

  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/jpeg", 0.95);
  a.download = filename;
  a.click();
}

/* ================= RENDER ================= */
function renderPrimary(rows) {
  primaryBox.innerHTML = "";
  rows.forEach((r, i) => renderCard(r, i, primaryBox));
}

function renderSecondary(rows) {
  if (rows.length === 0) return;

  secondarySection.classList.remove("hidden");
  secondaryBox.innerHTML = "";
  rows.forEach((r, i) => renderCard(r, i, secondaryBox, true));
}

function renderCard(r, i, box) {
  const url =
    sb.storage.from("gallery")
      .getPublicUrl(r.file_path).data.publicUrl;

  const card = document.createElement("div");
  card.className = "card bg-slate-800 rounded-2xl overflow-hidden";

  card.innerHTML = `
    <div class="relative">
      <img src="${url}" class="w-full h-56 object-cover">
      <img src="${LOGO_URL}"
           class="absolute bottom-2 right-2 w-12 opacity-80 pointer-events-none">
    </div>
    <div class="p-3 space-y-2">
      <div class="text-xs text-gray-400">
        Similarity ${(1 - r.distance).toFixed(2)}
      </div>
      <button
        class="w-full bg-yellow-500 text-black text-sm py-1.5 rounded-lg hover:bg-yellow-400"
        onclick="downloadWithWatermark('${url}', 'myphoto_${i+1}.jpg')">
        ‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
      </button>
    </div>
  `;

  box.appendChild(card);
}
</script>

</body>
</html>
