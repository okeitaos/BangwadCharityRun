<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Search | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <div class="w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
      <button id="langToggle" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">EN</button>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl shadow-lg text-center">
      <input id="fileInput" type="file" accept="image/*" class="mb-4 w-full text-gray-300" />
      <button id="searchBtn" class="w-full bg-green-500 hover:bg-green-600 py-2 rounded-lg mb-4">
        üîé <span id="btnSearchText">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û</span>
      </button>

      <div class="mb-4 text-left">
        <label for="threshold" id="thresholdLabel" class="block text-sm text-gray-300 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (95%)</label>
        <input id="threshold" type="range" min="80" max="99" value="95" class="w-full accent-green-500">
        <p id="thresholdValue" class="text-xs text-gray-400 mt-1 text-center">‚â• 95%</p>
      </div>

      <p id="status" class="text-gray-400 text-sm mb-3">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</p>
      <div id="result" class="text-sm text-gray-200"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // =========================
    // ‚öôÔ∏è CONFIG
    // =========================
    const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
    const BUCKET = "gallery";
    let SIM_THRESHOLD = 0.95; // default 95%

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // üé® DOM
    // =========================
    const fileInput = document.getElementById("fileInput");
    const searchBtn = document.getElementById("searchBtn");
    const statusDiv = document.getElementById("status");
    const resultDiv = document.getElementById("result");
    const langToggle = document.getElementById("langToggle");
    const thresholdInput = document.getElementById("threshold");
    const thresholdLabel = document.getElementById("thresholdLabel");
    const thresholdValue = document.getElementById("thresholdValue");
    const title = document.getElementById("title");
    const btnSearchText = document.getElementById("btnSearchText");

    // =========================
    // üåê Language Pack
    // =========================
    const LANG = {
      th: {
        title: "üì∏ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤",
        choose: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô",
        analyzing: "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...",
        notFound: "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ",
        searching: (v) => `üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‚â•${v}%)`,
        found: (n, v) => `üéØ ‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚â•${v}% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${n} ‡∏†‡∏≤‡∏û`,
        btnSearch: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û",
        level: (v) => `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô (${v}%)`,
        ready: "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        loading: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•..."
      },
      en: {
        title: "üì∏ Face Search",
        choose: "Please select an image first.",
        analyzing: "üß† Detecting face...",
        notFound: "‚ö†Ô∏è No face detected in this image.",
        searching: (v) => `üîç Searching for similar faces (‚â•${v}%)...`,
        noMatch: (v) => `‚ùå No similar faces found (‚â•${v}%)`,
        found: (n, v) => `üéØ Found ${n} similar faces (‚â•${v}%)`,
        btnSearch: "Search",
        level: (v) => `Similarity Level (${v}%)`,
        ready: "‚úÖ Ready to use",
        loading: "‚è≥ Loading model..."
      }
    };

    let currentLang = "th";

    function setLang(lang) {
      currentLang = lang;
      const t = LANG[lang];
      title.textContent = t.title;
      btnSearchText.textContent = t.btnSearch;
      thresholdLabel.textContent = t.level(Math.round(SIM_THRESHOLD * 100));
      thresholdValue.textContent = `‚â• ${Math.round(SIM_THRESHOLD * 100)}%`;
      langToggle.textContent = lang === "th" ? "EN" : "TH";
      statusDiv.textContent = t.ready;
    }

    langToggle.onclick = () => {
      setLang(currentLang === "th" ? "en" : "th");
    };

    // =========================
    // üß† ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
    // =========================
    statusDiv.textContent = LANG[currentLang].loading;
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
    ]);
    statusDiv.textContent = LANG[currentLang].ready;

    // =========================
    // üßÆ Helper
    // =========================
    function normalize(desc) {
      const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
      return desc.map(x => x / norm);
    }

    // =========================
    // üîß Similarity Slider
    // =========================
    thresholdInput.addEventListener("input", (e) => {
      const v = e.target.value;
      SIM_THRESHOLD = v / 100;
      thresholdLabel.textContent = LANG[currentLang].level(v);
      thresholdValue.textContent = `‚â• ${v}%`;
    });

    // =========================
    // üîç Face Search
    // =========================
    searchBtn.onclick = async () => {
      const langPack = LANG[currentLang];
      const file = fileInput.files[0];
      if (!file) return alert(langPack.choose);

      resultDiv.innerHTML = langPack.analyzing;
      const img = await faceapi.bufferToImage(file);
      const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

      if (!det) {
        resultDiv.innerHTML = langPack.notFound;
        return;
      }

      const embedding = normalize(Array.from(det.descriptor));
      statusDiv.textContent = langPack.searching(Math.round(SIM_THRESHOLD * 100));

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/face-search`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            embedding,
            threshold: SIM_THRESHOLD,
            limit: 20
          })
        });

        const { matches, error } = await response.json();
        if (error) throw new Error(error);

        if (!matches?.length) {
          resultDiv.innerHTML = langPack.noMatch(Math.round(SIM_THRESHOLD * 100));
          return;
        }

        resultDiv.innerHTML = `
          <p class="text-green-400 font-semibold mb-2">${langPack.found(matches.length, Math.round(SIM_THRESHOLD * 100))}</p>
          <div class="grid grid-cols-2 gap-3">
            ${matches.map(m => `
              <div class="bg-slate-700 p-2 rounded-lg">
                <img src="${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${m.image_url}" 
                     class="rounded-lg mb-2 shadow cursor-pointer hover:scale-105 transition" 
                     onclick="window.open(this.src, '_blank')" />
                <p class="text-sm">${m.name}</p>
                <p class="text-xs text-gray-400">Similarity: ${(m.similarity * 100).toFixed(2)}%</p>
              </div>
            `).join("")}
          </div>
        `;

      } catch (e) {
        resultDiv.innerHTML = `‚ùå ${e.message}`;
      }
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    setLang("th");
  </script>
</body>
</html>
