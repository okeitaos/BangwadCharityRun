<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Face Sync Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-xl mx-auto space-y-4">

  <h1 class="text-2xl font-bold text-center text-yellow-400">
    üì± Face Sync Control
  </h1>

  <!-- STATUS -->
  <div class="bg-slate-800 rounded-xl p-4 grid grid-cols-3 text-center gap-2">
    <div>
      <div class="text-gray-400 text-sm">Total</div>
      <div id="total" class="text-xl font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Synced</div>
      <div id="synced" class="text-xl font-bold text-green-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Remain</div>
      <div id="remaining" class="text-xl font-bold text-red-400">0</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div class="flex justify-between text-sm">
      <span id="statusText">Idle</span>
      <span id="percentText">0%</span>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-3">
      <div id="progressBar"
           class="bg-green-400 h-3 rounded-full transition-all duration-300"
           style="width:0%"></div>
    </div>
  </div>

  <!-- BUTTONS -->
  <div class="grid grid-cols-2 gap-3">
    <button id="startBtn"
      class="bg-green-600 py-3 rounded-xl font-semibold active:scale-95">
      ‚ñ∂ Start Sync
    </button>

    <button id="stopBtn"
      class="bg-red-600 py-3 rounded-xl font-semibold active:scale-95">
      ‚èπ Stop
    </button>
  </div>

  <!-- LOG -->
  <div class="bg-slate-800 rounded-xl p-3 h-48 overflow-auto text-xs"
       id="logBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://192.168.1.18:3000"; // üëà IP MAC
const SYNC_INTERVAL = 1200;
const STATUS_INTERVAL = 700;
/* ========================================= */

let syncing = false;
let syncTimer = null;
let statusTimer = null;

/* DOM */
const totalEl = document.getElementById("total");
const syncedEl = document.getElementById("synced");
const remainingEl = document.getElementById("remaining");
const statusText = document.getElementById("statusText");
const percentText = document.getElementById("percentText");
const progressBar = document.getElementById("progressBar");
const logBox = document.getElementById("logBox");

/* LOG */
function log(msg) {
  const el = document.createElement("div");
  el.textContent = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* START */
document.getElementById("startBtn").onclick = () => {
  if (syncing) return;
  syncing = true;
  statusText.textContent = "Syncing...";
  log("üöÄ Start sync");

  runSyncLoop();
  startStatusLoop();
};

/* STOP */
document.getElementById("stopBtn").onclick = () => {
  syncing = false;
  clearTimeout(syncTimer);
  clearInterval(statusTimer);
  statusText.textContent = "Stopped";
  log("‚èπ Stop sync");
};

/* SYNC LOOP (POST) */
function runSyncLoop() {
  if (!syncing) return;

  fetch(`${API_BASE}/sync`, {
    method: "POST"
  })
  .then(res => res.json())
  .then(d => {
    if (d.status === "busy") {
      log("‚è≥ Server busy");
    }
    if (d.status === "no_files") {
      log("‚úÖ No pending files");
      syncing = false;
    }
  })
  .catch(() => {
    log("‚ùå Sync request failed");
    syncing = false;
  });

  syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
}

/* STATUS LOOP */
function startStatusLoop() {
  statusTimer = setInterval(async () => {
    try {
      const res = await fetch(`${API_BASE}/sync/status`);
      const d = await res.json();

      totalEl.textContent = d.total;
      syncedEl.textContent = d.synced;
      remainingEl.textContent = d.remaining;

      const percent = d.total
        ? Math.round((d.synced / d.total) * 100)
        : 0;

      progressBar.style.width = percent + "%";
      percentText.textContent = percent + "%";

      if (d.done && syncing) {
        syncing = false;
        log("üéâ Sync completed");
        statusText.textContent = "Completed";
      }
    } catch {
      log("‚ö†Ô∏è Status fetch error");
    }
  }, STATUS_INTERVAL);
}
</script>

</body>
</html>
