<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Face Sync Control ‚Äî Auto Recover</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-xl mx-auto space-y-4">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-yellow-400">
      üì± Face Sync Control
    </h1>
    <!-- SERVER BADGE -->
    <span id="serverBadge"
      class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-600">
      ‚óè Unknown
    </span>
  </div>

  <!-- STATS -->
  <div class="bg-slate-800 rounded-xl p-4 grid grid-cols-3 text-center gap-2">
    <div>
      <div class="text-gray-400 text-sm">Total</div>
      <div id="total" class="text-xl font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Synced</div>
      <div id="synced" class="text-xl font-bold text-green-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Remain</div>
      <div id="remaining" class="text-xl font-bold text-red-400">0</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div class="flex justify-between text-sm">
      <span id="statusText">Idle</span>
      <span id="percentText">0%</span>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-3">
      <div id="progressBar"
           class="bg-green-400 h-3 rounded-full transition-all duration-300"
           style="width:0%"></div>
    </div>
  </div>

  <!-- BUTTONS -->
  <div class="grid grid-cols-2 gap-3">
    <button id="startBtn"
      class="bg-green-600 py-3 rounded-xl font-semibold active:scale-95">
      ‚ñ∂ Start Sync
    </button>

    <button id="stopBtn"
      class="bg-red-600 py-3 rounded-xl font-semibold active:scale-95">
      ‚èπ Stop
    </button>
  </div>

  <!-- LOG -->
  <div class="bg-slate-800 rounded-xl p-3 h-48 overflow-auto text-xs"
       id="logBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://192.168.1.18:3000"; // üëà IP MAC
const SYNC_INTERVAL = 1200;   // sync loop ‡∏õ‡∏Å‡∏ï‡∏¥
const STATUS_INTERVAL = 700;  // status realtime

// Exponential backoff (status)
const BACKOFF_BASE = 800;     // ms
const BACKOFF_MAX  = 10000;   // ms
/* ========================================= */

// STATE
let syncing = false;
let serverOnline = true;
let syncTimer = null;
let statusTimer = null;

// backoff state
let backoffDelay = BACKOFF_BASE;
let backoffTimer = null;

// DOM
const totalEl = document.getElementById("total");
const syncedEl = document.getElementById("synced");
const remainingEl = document.getElementById("remaining");
const statusText = document.getElementById("statusText");
const percentText = document.getElementById("percentText");
const progressBar = document.getElementById("progressBar");
const logBox = document.getElementById("logBox");
const serverBadge = document.getElementById("serverBadge");

/* ================= UI HELPERS ================= */
function setBadgeOnline() {
  serverBadge.textContent = "‚óè Online";
  serverBadge.className =
    "px-3 py-1 rounded-full text-xs font-semibold bg-green-600";
}
function setBadgeOffline() {
  serverBadge.textContent = "‚óè Offline";
  serverBadge.className =
    "px-3 py-1 rounded-full text-xs font-semibold bg-red-600";
}
function log(msg) {
  const el = document.createElement("div");
  el.textContent = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CONTROL ================= */
document.getElementById("startBtn").onclick = () => {
  if (syncing) return;
  syncing = true;
  statusText.textContent = "Syncing‚Ä¶";
  log("üöÄ Start sync");

  runSyncLoop();
  startStatusLoop();
};

document.getElementById("stopBtn").onclick = () => {
  syncing = false;
  clearTimeout(syncTimer);
  clearInterval(statusTimer);
  clearTimeout(backoffTimer);
  statusText.textContent = "Stopped";
  log("‚èπ Stop sync");
};

/* ================= SYNC LOOP ================= */
function runSyncLoop() {
  if (!syncing) return;

  // ‡∏ñ‡πâ‡∏≤ server offline ‚Üí ‡∏£‡∏≠ (auto-recover)
  if (!serverOnline) {
    syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
    return;
  }

  fetch(`${API_BASE}/sync`, { method: "POST" })
    .then(res => res.json())
    .then(d => {
      if (d.status === "busy") {
        log("‚è≥ Server busy");
      }
      if (d.status === "no_files") {
        log("‚úÖ No pending files");
        syncing = false;
        statusText.textContent = "Completed";
      }
    })
    .catch(() => {
      // server ‡∏•‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏¢‡∏¥‡∏á sync
      if (serverOnline) {
        log("‚ö†Ô∏è Sync failed, waiting for server restart‚Ä¶");
      }
      serverOnline = false;
      setBadgeOffline();
      statusText.textContent = "Server reconnecting‚Ä¶";
      scheduleBackoffCheck();
    });

  syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
}

/* ================= STATUS LOOP ================= */
function startStatusLoop() {
  clearInterval(statusTimer);
  statusTimer = setInterval(fetchStatus, STATUS_INTERVAL);
}

async function fetchStatus() {
  try {
    const res = await fetch(`${API_BASE}/sync/status`, { cache: "no-store" });
    if (!res.ok) throw new Error("status not ok");
    const d = await res.json();

    // server ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    if (!serverOnline) {
      serverOnline = true;
      setBadgeOnline();
      backoffDelay = BACKOFF_BASE; // reset backoff
      clearTimeout(backoffTimer);
      log("‚úÖ Server reconnected");
      statusText.textContent = syncing ? "Syncing‚Ä¶" : "Idle";
    }

    totalEl.textContent = d.total;
    syncedEl.textContent = d.synced;
    remainingEl.textContent = d.remaining;

    const percent = d.total
      ? Math.round((d.synced / d.total) * 100)
      : 0;

    progressBar.style.width = percent + "%";
    percentText.textContent = percent + "%";

    if (d.done && syncing) {
      syncing = false;
      log("üéâ Sync completed");
      statusText.textContent = "Completed";
    }

  } catch (e) {
    // status ‡∏•‡πâ‡∏° ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ server offline
    if (serverOnline) {
      log("‚ö†Ô∏è Server offline, auto-recovering‚Ä¶");
    }
    serverOnline = false;
    setBadgeOffline();
    statusText.textContent = "Server reconnecting‚Ä¶";
    scheduleBackoffCheck();
  }
}

/* ================= EXPONENTIAL BACKOFF ================= */
function scheduleBackoffCheck() {
  clearTimeout(backoffTimer);

  backoffTimer = setTimeout(async () => {
    try {
      const res = await fetch(`${API_BASE}/sync/status`, { cache: "no-store" });
      if (!res.ok) throw new Error("still offline");

      // online ‡πÅ‡∏•‡πâ‡∏ß
      serverOnline = true;
      setBadgeOnline();
      backoffDelay = BACKOFF_BASE;
      log("‚úÖ Server reconnected (backoff)");
      statusText.textContent = syncing ? "Syncing‚Ä¶" : "Idle";

    } catch {
      // ‡∏¢‡∏±‡∏á offline ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° backoff
      backoffDelay = Math.min(backoffDelay * 1.8, BACKOFF_MAX);
      log(`‚è≥ Retry in ${Math.round(backoffDelay)} ms`);
      scheduleBackoffCheck();
    }
  }, backoffDelay);
}
</script>

</body>
</html>
