<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Admin Face Sync ‚Äì ThaiRun Style</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">

<div class="max-w-3xl mx-auto space-y-6">

  <h1 class="text-3xl font-bold text-yellow-400 text-center">
    üß† Admin Face Sync (ThaiRun Style)
  </h1>

  <!-- STATUS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-3">
    <div id="statusText" class="font-semibold">Idle</div>

    <div id="counter" class="text-sm text-gray-300">
      Synced: 0 / 0
    </div>

    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
      <div
        id="progressBar"
        class="bg-green-400 h-4 transition-all duration-300"
        style="width:0%">
      </div>
    </div>

    <div id="percentText" class="text-sm text-gray-400">
      0%
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="flex gap-4 justify-center">
    <button id="startBtn"
      class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-xl font-semibold">
      ‚ñ∂ Start Sync
    </button>

    <button id="stopBtn"
      class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-xl font-semibold hidden">
      ‚èπ Stop
    </button>
  </div>

  <!-- LOG -->
  <div
    id="logBox"
    class="bg-slate-800 rounded-xl p-4 text-sm h-72 overflow-auto space-y-1">
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://localhost:3000";
const SYNC_INTERVAL = 800;   // ‡∏¢‡∏¥‡∏á /sync
const STATUS_INTERVAL = 1200; // poll ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
/* ========================================= */

let syncing = false;
let syncLoopTimer = null;
let statusTimer = null;

const statusText = document.getElementById("statusText");
const counter = document.getElementById("counter");
const progressBar = document.getElementById("progressBar");
const percentText = document.getElementById("percentText");
const logBox = document.getElementById("logBox");

document.getElementById("startBtn").onclick = startSync;
document.getElementById("stopBtn").onclick = stopSync;

/* ================= LOG ================= */
function log(msg) {
  const el = document.createElement("div");
  el.innerText = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CONTROL ================= */
function startSync() {
  if (syncing) return;

  syncing = true;
  statusText.innerText = "Syncing‚Ä¶";
  log("üöÄ Start face sync");

  document.getElementById("startBtn").classList.add("hidden");
  document.getElementById("stopBtn").classList.remove("hidden");

  syncLoop();
  pollStatus();
}

function stopSync() {
  syncing = false;
  statusText.innerText = "Stopped";
  log("‚èπ Sync stopped");

  clearTimeout(syncLoopTimer);
  clearTimeout(statusTimer);

  document.getElementById("stopBtn").classList.add("hidden");
  document.getElementById("startBtn").classList.remove("hidden");
}

/* ================= SYNC LOOP ================= */
async function syncLoop() {
  if (!syncing) return;

  try {
    await fetch(`${API_BASE}/sync`, { method: "POST" });
  } catch (e) {
    log("‚ùå Sync request failed");
    stopSync();
    return;
  }

  syncLoopTimer = setTimeout(syncLoop, SYNC_INTERVAL);
}

/* ================= STATUS POLLING ================= */
async function pollStatus() {
  if (!syncing) return;

  try {
    const res = await fetch(`${API_BASE}/sync/status`);
    const data = await res.json();

    const total = data.total || 0;
    const synced = data.synced || 0;
    const remaining = data.remaining || 0;

    const percent = total > 0
      ? Math.round((synced / total) * 100)
      : 0;

    counter.innerText =
      `Synced: ${synced} / ${total} (Remaining: ${remaining})`;

    progressBar.style.width = percent + "%";
    percentText.innerText = percent + "%";

    if (data.done) {
      syncing = false;
      statusText.innerText = "Completed";
      log("üéâ Face sync completed");

      progressBar.style.width = "100%";
      percentText.innerText = "100%";

      document.getElementById("stopBtn").classList.add("hidden");
      document.getElementById("startBtn").classList.remove("hidden");
      return;
    }

  } catch (e) {
    log("‚ùå Status check failed");
  }

  statusTimer = setTimeout(pollStatus, STATUS_INTERVAL);
}
</script>

</body>
</html>
