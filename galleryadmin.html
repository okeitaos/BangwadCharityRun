<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Face Sync Dashboard (Realtime Chart)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">üß† Face Sync Dashboard (Admin + Realtime Chart)</h1>

  <!-- üîÑ Control Panel -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg w-full max-w-2xl mb-6 text-center">
    <h2 class="text-lg font-semibold mb-2">üîÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Gallery</h2>
    <p id="status" class="text-gray-400 mb-2">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</p>
    <div class="flex justify-center gap-3 mb-4">
      <button id="syncBtn" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg">
        üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      </button>
      <button id="clearLogBtn" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg">
        üßπ ‡∏•‡πâ‡∏≤‡∏á Log
      </button>
    </div>

    <!-- üìä Realtime Chart -->
    <div class="bg-slate-700 p-4 rounded-lg mb-4">
      <canvas id="syncChart" height="100"></canvas>
    </div>

    <!-- üìú Log Section -->
    <div id="log" class="text-sm text-left bg-slate-700 p-3 rounded-lg h-64 overflow-y-auto font-mono"></div>
  </div>

  <script>
  // ‚öôÔ∏è CONFIG
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
  const BUCKET = "gallery";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const CONF_THRESHOLD = 0.9;
  const MIN_FACE_SIZE = 100;

  // üì¶ DOM
  const statusDiv = document.getElementById("status");
  const syncBtn = document.getElementById("syncBtn");
  const clearLogBtn = document.getElementById("clearLogBtn");
  const logDiv = document.getElementById("log");
  const ctx = document.getElementById("syncChart");

  // üìä Chart setup
  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ç‡πâ‡∏≤‡∏°", "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"],
      datasets: [
        {
          label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏û",
          data: [0, 0, 0],
          backgroundColor: ["#22c55e", "#3b82f6", "#ef4444"]
        }
      ]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  // üß† ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• face-api
  async function loadModels() {
    const modelURL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.4/model/";
    statusDiv.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
      faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
      faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
    ]);
    statusDiv.textContent = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß";
  }

  // üß© Normalize descriptor
  function normalize(desc) {
    const norm = Math.sqrt(desc.reduce((a, b) => a + b * b, 0));
    return desc.map(x => x / norm);
  }

  // üìÅ ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
  async function listRecursive(path = "") {
    const { data, error } = await supabase.storage.from(BUCKET).list(path, { limit: 1000 });
    if (error) return [];
    let files = [];
    for (const item of data) {
      if (!item.metadata) {
        const sub = await listRecursive(path ? `${path}/${item.name}` : item.name);
        files = files.concat(sub);
      } else {
        files.push(path ? `${path}/${item.name}` : item.name);
      }
    }
    return files;
  }

  // üß† ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sync
  async function syncGallery() {
    statusDiv.textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Gallery...";
    logDiv.innerHTML = "";
    let success = 0, skipped = 0, failed = 0;

    const files = await listRecursive("");
    for (const path of files) {
      try {
        const { data: exists } = await supabase.from("faces").select("id").eq("image_url", path).maybeSingle();
        if (exists) {
          skipped++;
          logDiv.innerHTML += `‚öôÔ∏è ‡∏Ç‡πâ‡∏≤‡∏°‡∏†‡∏≤‡∏û (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß): ${path}<br>`;
          continue;
        }

        const imgUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${path}`;
        const img = await faceapi.fetchImage(imgUrl);
        const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

        if (!det || det.detection.score < CONF_THRESHOLD) {
          failed++;
          logDiv.innerHTML += `‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${path}<br>`;
          continue;
        }

        if (det.detection.box.width < MIN_FACE_SIZE || det.detection.box.height < MIN_FACE_SIZE) {
          failed++;
          logDiv.innerHTML += `‚ö†Ô∏è ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ: ${path}<br>`;
          continue;
        }

        const embedding = normalize(Array.from(det.descriptor));
        const name = path.split("/").pop().split(".")[0];

        const { error: insertError } = await supabase.rpc("insert_face_vector", {
          p_name: name,
          p_image_url: path,
          p_embedding: embedding
        });

        if (insertError) {
          failed++;
          logDiv.innerHTML += `‚ùå Error ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${path}: ${insertError.message}<br>`;
        } else {
          success++;
          logDiv.innerHTML += `‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${path}<br>`;
        }
      } catch (e) {
        failed++;
        logDiv.innerHTML += `üí• Error ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${path}: ${e.message}<br>`;
      }

      // üî¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
      chart.data.datasets[0].data = [success, skipped, failed];
      chart.update();
    }

    statusDiv.textContent = `‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success}, ‡∏Ç‡πâ‡∏≤‡∏° ${skipped}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failed})`;
    logDiv.innerHTML += `<hr><b>üéØ ‡∏™‡∏£‡∏∏‡∏õ:</b> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success}, ‡∏Ç‡πâ‡∏≤‡∏° ${skipped}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failed}<br>`;
  }

  // üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  window.addEventListener("DOMContentLoaded", async () => {
    await loadModels();
    setInterval(syncGallery, 60000); // Auto sync ‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  });

  syncBtn.addEventListener("click", syncGallery);
  clearLogBtn.addEventListener("click", () => (logDiv.innerHTML = ""));
  </script>
</body>
</html>
