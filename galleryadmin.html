<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Face Sync Dashboard (Auto-Watch)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-xl mx-auto space-y-4">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-yellow-400">
      ğŸ“± Face Sync Dashboard
    </h1>
    <span id="serverBadge"
      class="px-3 py-1 rounded-full text-xs font-semibold bg-red-600">
      â— Offline
    </span>
  </div>

  <!-- STATS -->
  <div class="bg-slate-800 rounded-xl p-4 grid grid-cols-3 text-center gap-2">
    <div>
      <div class="text-gray-400 text-sm">Total</div>
      <div id="total" class="text-xl font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Synced</div>
      <div id="synced" class="text-xl font-bold text-green-400">0</div>
    </div>
    <div>
      <div class="text-gray-400 text-sm">Remain</div>
      <div id="remaining" class="text-xl font-bold text-red-400">0</div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div class="flex justify-between text-sm">
      <span id="statusText">Initializingâ€¦</span>
      <span id="percentText">0%</span>
    </div>
    <div class="w-full bg-gray-700 rounded-full h-3">
      <div id="progressBar"
           class="bg-green-400 h-3 rounded-full transition-all duration-300"
           style="width:0%"></div>
    </div>
  </div>

  <!-- LOG -->
  <div class="bg-slate-800 rounded-xl p-3 h-56 overflow-auto text-xs"
       id="logBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://192.168.1.107:3000"; // ğŸ‘ˆ IP MAC
const STATUS_INTERVAL = 1000;
const SYNC_INTERVAL = 1500;

// backoff
const BACKOFF_BASE = 800;
const BACKOFF_MAX  = 12000;
/* ========================================= */

// STATE
let syncing = true;            // ğŸ”¥ auto-start + auto-watch
let serverOnline = false;
let backoffDelay = BACKOFF_BASE;
let backoffTimer = null;
let syncTimer = null;

// DOM
const totalEl = document.getElementById("total");
const syncedEl = document.getElementById("synced");
const remainingEl = document.getElementById("remaining");
const statusText = document.getElementById("statusText");
const percentText = document.getElementById("percentText");
const progressBar = document.getElementById("progressBar");
const logBox = document.getElementById("logBox");
const serverBadge = document.getElementById("serverBadge");

/* ================= UI ================= */
function log(msg) {
  const el = document.createElement("div");
  el.textContent = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

function setBadgeOnline() {
  serverBadge.textContent = "â— Online";
  serverBadge.className =
    "px-3 py-1 rounded-full text-xs font-semibold bg-green-600";
}
function setBadgeOffline() {
  serverBadge.textContent = "â— Offline";
  serverBadge.className =
    "px-3 py-1 rounded-full text-xs font-semibold bg-red-600";
}

/* ================= STATUS ================= */
async function fetchStatus() {
  try {
    const res = await fetch(`${API_BASE}/sync/status`, { cache: "no-store" });
    if (!res.ok) throw new Error("offline");

    const d = await res.json();

    // server back online
    if (!serverOnline) {
      serverOnline = true;
      setBadgeOnline();
      backoffDelay = BACKOFF_BASE;
      clearTimeout(backoffTimer);
      log("âœ… Server online");
    }

    totalEl.textContent = d.total;
    syncedEl.textContent = d.synced;
    remainingEl.textContent = d.remaining;

    const percent = d.total
      ? Math.round((d.synced / d.total) * 100)
      : 0;

    progressBar.style.width = percent + "%";
    percentText.textContent = percent + "%";

    // ğŸ” AUTO-WATCH LOGIC
    if (d.remaining > 0) {
      statusText.textContent = "Syncingâ€¦";
    } else {
      statusText.textContent = "Idle (waiting for new images)";
    }

  } catch {
    if (serverOnline) {
      log("âš ï¸ Server offline, waitingâ€¦");
    }
    serverOnline = false;
    setBadgeOffline();
    statusText.textContent = "Server reconnectingâ€¦";
    scheduleBackoff();
  }
}

/* ================= SYNC LOOP ================= */
function runSyncLoop() {
  if (!syncing) return;

  if (!serverOnline) {
    syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
    return;
  }

  fetch(`${API_BASE}/sync`, { method: "POST" })
    .catch(() => {
      serverOnline = false;
      setBadgeOffline();
      log("âš ï¸ Sync failed, server down");
      scheduleBackoff();
    });

  syncTimer = setTimeout(runSyncLoop, SYNC_INTERVAL);
}

/* ================= BACKOFF ================= */
function scheduleBackoff() {
  clearTimeout(backoffTimer);
  backoffTimer = setTimeout(async () => {
    try {
      const res = await fetch(`${API_BASE}/sync/status`, { cache: "no-store" });
      if (!res.ok) throw new Error();
      serverOnline = true;
      setBadgeOnline();
      backoffDelay = BACKOFF_BASE;
      log("âœ… Server reconnected");
    } catch {
      backoffDelay = Math.min(backoffDelay * 1.8, BACKOFF_MAX);
      log(`â³ Retry in ${Math.round(backoffDelay)} ms`);
      scheduleBackoff();
    }
  }, backoffDelay);
}

/* ================= INIT ================= */
window.addEventListener("load", () => {
  log("ğŸ”Œ Initializing auto-watch mode");
  fetchStatus();
  setInterval(fetchStatus, STATUS_INTERVAL);
  runSyncLoop(); // ğŸ”¥ start once, never stop
});
</script>

</body>
</html>
