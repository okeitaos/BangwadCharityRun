<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üß† Face Sync Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">
  <div class="max-w-4xl mx-auto space-y-6">

    <h1 class="text-3xl font-bold text-center text-yellow-400">
      üß† Face Sync Admin Dashboard
    </h1>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-slate-800 rounded-xl p-4 text-center">
        <p class="text-gray-400">üì∑ ‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p id="totalImages" class="text-2xl font-bold">-</p>
      </div>

      <div class="bg-slate-800 rounded-xl p-4 text-center">
        <p class="text-gray-400">‚è≥ ‡∏£‡∏≠ Sync</p>
        <p id="pendingImages" class="text-2xl font-bold text-yellow-300">-</p>
      </div>

      <div class="bg-slate-800 rounded-xl p-4 text-center">
        <p class="text-gray-400">‚úÖ Sync ‡πÅ‡∏•‡πâ‡∏ß</p>
        <p id="syncedImages" class="text-2xl font-bold text-green-400">-</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-slate-800 rounded-xl p-6 text-center space-y-4">
      <button
        id="syncBtn"
        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-semibold transition disabled:opacity-50"
      >
        üîÑ Sync Now
      </button>

      <div id="result" class="text-sm text-gray-300"></div>
    </div>

    <!-- Log -->
    <div class="bg-black/40 rounded-xl p-4">
      <h2 class="font-semibold mb-2">üìú Log</h2>
      <pre id="log" class="text-xs text-gray-300 max-h-64 overflow-auto"></pre>
    </div>

  </div>

<script>
  // üîß ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
  const EDGE_FUNCTION_URL = SUPABASE_URL + "/functions/v1/face-sync";

  const supabase = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  const totalEl = document.getElementById("totalImages");
  const pendingEl = document.getElementById("pendingImages");
  const syncedEl = document.getElementById("syncedImages");
  const logEl = document.getElementById("log");
  const resultEl = document.getElementById("result");
  const syncBtn = document.getElementById("syncBtn");

  function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function loadStats() {
    log("üîç ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏π‡∏õ...");

    const { count: total } = await supabase
      .from("images")
      .select("*", { count: "exact", head: true });

    const { count: pending } = await supabase
      .from("images")
      .select("*", { count: "exact", head: true })
      .eq("synced", false);

    const { count: synced } = await supabase
      .from("images")
      .select("*", { count: "exact", head: true })
      .eq("synced", true);

    totalEl.textContent = total ?? 0;
    pendingEl.textContent = pending ?? 0;
    syncedEl.textContent = synced ?? 0;

    log("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  }

  async function runSync() {
    syncBtn.disabled = true;
    resultEl.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync...";
    log("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° Sync...");

    try {
      const res = await fetch(EDGE_FUNCTION_URL);
      const json = await res.json();

      log("üì¶ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: " + JSON.stringify(json));

      resultEl.textContent =
        `‚úÖ Synced: ${json.synced || 0} | ‚ùå Skipped: ${json.skipped || 0}`;

      await loadStats();
    } catch (e) {
      console.error(e);
      resultEl.textContent = "‚ùå Sync ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
      log("‚ùå ERROR: " + e.message);
    }

    syncBtn.disabled = false;
  }

  syncBtn.addEventListener("click", runSync);

  loadStats();
</script>

</body>
</html>
