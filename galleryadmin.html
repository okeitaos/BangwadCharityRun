<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin Face Sync</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">

<div class="max-w-3xl mx-auto space-y-6">

  <h1 class="text-3xl font-bold text-yellow-400 text-center">
    Admin Face Sync (ThaiRun Style)
  </h1>

  <!-- SUMMARY -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div id="statusText">Idle</div>

    <div class="w-full bg-gray-700 rounded-full h-4">
      <div id="progressBar"
        class="bg-green-400 h-4 rounded-full"
        style="width:0%">
      </div>
    </div>

    <div id="progressText" class="text-sm">0%</div>
  </div>

  <!-- CONTROLS -->
  <div class="flex gap-4 justify-center">
    <button id="startBtn"
      class="bg-green-600 px-6 py-3 rounded-xl font-semibold">
      Start Sync
    </button>

    <button id="stopBtn"
      class="bg-red-600 px-6 py-3 rounded-xl font-semibold hidden">
      Stop
    </button>
  </div>

  <!-- LOG -->
  <div
    id="logBox"
    class="bg-slate-800 rounded-xl p-4 text-sm h-72 overflow-auto space-y-1">
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const FACE_SYNC_URL = "http://localhost:3000/sync"; // ðŸ”¥ à¹à¸à¹‰à¸•à¸£à¸‡à¸™à¸µà¹‰à¸–à¹‰à¸² deploy à¹à¸¥à¹‰à¸§
const SYNC_KEY = ""; // à¹ƒà¸ªà¹ˆà¸–à¹‰à¸²à¸¡à¸µ x-sync-key
const LOOP_DELAY = 1200; // ms (à¹€à¸«à¸¡à¸·à¸­à¸™à¹„à¸—à¸¢à¸£à¸±à¸™)
/* ========================================= */

let running = false;
let totalDone = 0;

const statusText = document.getElementById("statusText");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const logBox = document.getElementById("logBox");

document.getElementById("startBtn").onclick = startSync;
document.getElementById("stopBtn").onclick = stopSync;

/* ================= LOG ================= */
function log(msg) {
  const el = document.createElement("div");
  el.innerText = new Date().toLocaleTimeString() + " - " + msg;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ================= CONTROL ================= */
async function startSync() {
  if (running) return;

  running = true;
  totalDone = 0;

  statusText.innerText = "Running...";
  progressBar.style.width = "0%";
  progressText.innerText = "0%";

  document.getElementById("startBtn").classList.add("hidden");
  document.getElementById("stopBtn").classList.remove("hidden");

  log("ðŸš€ Start face sync");

  await loopSync();
}

function stopSync() {
  running = false;
  statusText.innerText = "Stopped";
  log("â›” Sync stopped by admin");

  document.getElementById("stopBtn").classList.add("hidden");
  document.getElementById("startBtn").classList.remove("hidden");
}

/* ================= SYNC LOOP ================= */
async function loopSync() {
  while (running) {
    const result = await runBatch();

    if (!result) break;

    if (result.status === "no_files") {
      log("âœ… No pending images");
      finish();
      break;
    }

    totalDone += result.synced;

    log(
      `Batch synced=${result.synced}, skipped=${result.skipped}`
    );

    // fake progress (thai-run style)
    updateProgress(result.synced, result.skipped);

    await sleep(LOOP_DELAY);
  }
}

async function runBatch() {
  try {
    const res = await fetch(FACE_SYNC_URL, {
      method: "POST",
      headers: SYNC_KEY
        ? { "x-sync-key": SYNC_KEY }
        : {}
    });

    if (!res.ok) {
      log("âŒ Server error: " + res.status);
      stopSync();
      return null;
    }

    return await res.json();
  } catch (err) {
    log("âŒ Network error");
    stopSync();
    return null;
  }
}

/* ================= PROGRESS ================= */
function updateProgress(synced, skipped) {
  // progress à¹à¸šà¸šà¸›à¸£à¸°à¸¡à¸²à¸“ (à¹€à¸žà¸£à¸²à¸°à¹€à¸£à¸²à¹„à¸¡à¹ˆà¸£à¸¹à¹‰ total à¸¥à¹ˆà¸§à¸‡à¸«à¸™à¹‰à¸²)
  const inc = synced > 0 ? 3 : 1;
  const current = parseInt(progressBar.style.width) || 0;
  const next = Math.min(100, current + inc);

  progressBar.style.width = next + "%";
  progressText.innerText = next + "%";
}

function finish() {
  running = false;
  progressBar.style.width = "100%";
  progressText.innerText = "100%";
  statusText.innerText = "Completed";

  document.getElementById("stopBtn").classList.add("hidden");
  document.getElementById("startBtn").classList.remove("hidden");

  log("ðŸŽ‰ Face sync completed");
}

/* ================= UTIL ================= */
function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}
</script>

</body>
</html>
