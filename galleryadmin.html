<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Face Sync</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-6">

<div class="max-w-3xl mx-auto space-y-6">

  <h1 class="text-3xl font-bold text-yellow-400 text-center">
    Admin Face Sync (ThaiRun Style)
  </h1>

  <!-- Summary -->
  <div class="bg-slate-800 rounded-xl p-4 space-y-2">
    <div id="pendingText">Loading...</div>
    <div class="w-full bg-gray-700 rounded-full h-4">
      <div id="progressBar" class="bg-green-400 h-4 rounded-full" style="width:0%"></div>
    </div>
    <div id="progressText" class="text-sm">0%</div>
  </div>

  <!-- Controls -->
  <div class="flex gap-4 justify-center">
    <button id="startBtn"
      class="bg-green-600 px-6 py-3 rounded-xl font-semibold">
      Start Sync
    </button>
    <button id="stopBtn"
      class="bg-red-600 px-6 py-3 rounded-xl font-semibold hidden">
      Stop
    </button>
  </div>

  <!-- Log -->
  <div class="bg-slate-800 rounded-xl p-4 text-sm h-64 overflow-auto" id="logBox"></div>

</div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const FACE_SYNC_URL = SUPABASE_URL + "/functions/v1/face-sync";

const BATCH_SIZE = 10;
/* ============================ */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let running = false;
let total = 0;
let done = 0;

const pendingText = document.getElementById("pendingText");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const logBox = document.getElementById("logBox");

document.getElementById("startBtn").onclick = startSync;
document.getElementById("stopBtn").onclick = stopSync;

async function loadPending() {
  const { count } = await sb
    .from("file_hashes")
    .select("*", { count: "exact", head: true })
    .eq("synced", false);

  total = count || 0;
  pendingText.innerText = "Pending images: " + total;
}

async function startSync() {
  if (total === 0) {
    alert("No pending images");
    return;
  }

  running = true;
  done = 0;

  document.getElementById("startBtn").classList.add("hidden");
  document.getElementById("stopBtn").classList.remove("hidden");

  log("Start syncing...");
  await loopSync();
}

function stopSync() {
  running = false;
  log("Sync stopped by admin");
}

async function loopSync() {
  while (running && done < total) {
    await runBatch();
    await sleep(800); // throttle like ThaiRun
  }

  if (done >= total) {
    log("Sync completed");
    document.getElementById("stopBtn").classList.add("hidden");
    document.getElementById("startBtn").classList.remove("hidden");
  }
}

async function runBatch() {
  const res = await fetch(FACE_SYNC_URL, {
    method: "POST"
  });

  const result = await res.json();

  done += (result.synced || 0);
  updateProgress();

  log(
    "Batch: synced=" +
    result.synced +
    " skipped=" +
    result.skipped
  );
}

function updateProgress() {
  const percent = total
    ? Math.min(100, Math.round((done / total) * 100))
    : 0;

  progressBar.style.width = percent + "%";
  progressText.innerText = percent + "%";
}

function log(text) {
  const p = document.createElement("div");
  p.innerText = new Date().toLocaleTimeString() + " - " + text;
  logBox.appendChild(p);
  logBox.scrollTop = logBox.scrollHeight;
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

loadPending();
</script>

</body>
</html>
