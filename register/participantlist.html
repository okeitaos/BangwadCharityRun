<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ | Bangwad Charity Run</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0f172a;
    color: #fff;
    padding: 20px;
    text-align: center;
  }

  h1 { color: #facc15; }

  .lang-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #334155;
    padding: 8px 15px;
    border-radius: 20px;
    color: #fff;
    border: none;
    font-weight: bold;
  }

  input {
    width: 90%;
    max-width: 360px;
    padding: 12px;
    margin: 10px 0;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    text-align: center;
  }

  button {
    background: #3b82f6;
    color: #fff;
    padding: 12px 25px;
    border-radius: 25px;
    border: none;
    margin-top: 10px;
    cursor: pointer;
  }

  .card {
    background: rgba(255,255,255,0.08);
    padding: 20px;
    margin-top: 20px;
    border-radius: 15px;
    max-width: 420px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
    line-height: 1.6;
  }

  .label { color: #facc15; font-weight: bold; }

  .status-approved { color: #4ade80; font-weight: bold; }
  .status-pending { color: #facc15; font-weight: bold; }
  .status-rejected { color: #ef4444; font-weight: bold; }

</style>
</head>

<body>

<button class="lang-btn" onclick="toggleLang()">EN</button>

<h1 id="header">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h1>

<p id="desc">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ Passport</p>

<input type="text" id="nationalId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">

<button onclick="searchData()" id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

<div id="result"></div>

<script>
/* ===============================
   üåè ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤ TH / EN
================================ */
let lang = "TH";

const text = {
  TH: {
    title: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ | Bangwad Charity Run",
    header: "üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
    desc: "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ Passport",
    placeholder: "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
    search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
    notfound: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ",
    loading: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
    id: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß",
    name: "‡∏ä‡∏∑‡πà‡∏≠",
    type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
    regAt: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠",
    download: "üñ®Ô∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    share: "üíö ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE",
    approved: "‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    pending: "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
    rejected: "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
  },
  EN: {
    title: "Registration Status Checker | Bangwad Charity Run",
    header: "üîç Registration Status Checker",
    desc: "Enter your National ID or Passport number",
    placeholder: "Enter ID to search",
    search: "Search",
    notfound: "‚ùå No data found for this ID",
    loading: "‚è≥ Searching...",
    id: "Bib Number",
    name: "Name",
    type: "Category",
    status: "Status",
    regAt: "Registered At",
    download: "üñ®Ô∏è Download Confirmation",
    share: "üíö Share via LINE",
    approved: "Approved",
    pending: "Pending",
    rejected: "Rejected",
  }
};

function applyLang() {
  document.getElementById("title").innerText = text[lang].title;
  document.getElementById("header").innerText = text[lang].header;
  document.getElementById("desc").innerText = text[lang].desc;
  document.getElementById("nationalId").placeholder = text[lang].placeholder;
  document.getElementById("searchBtn").innerText = text[lang].search;
  document.querySelector(".lang-btn").innerText = lang === "TH" ? "EN" : "TH";
}

function toggleLang() {
  lang = lang === "TH" ? "EN" : "TH";
  applyLang();
}

applyLang();

/* ===============================
   üîó Supabase
================================ */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY ="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* üáπüá≠ ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ */
function formatThaiTime(dateString) {
  return new Intl.DateTimeFormat("th-TH", {
    dateStyle: "short",
    timeStyle: "medium",
    timeZone: "Asia/Bangkok"
  }).format(new Date(dateString));
}

/* EN Time */
function formatEnTime(dateString) {
  return new Intl.DateTimeFormat("en-US", {
    dateStyle: "medium",
    timeStyle: "short",
    timeZone: "Asia/Bangkok"
  }).format(new Date(dateString));
}

/* TOPxxx */
function formatTopId(id) {
  return "TOP" + id.toString().padStart(3,"0");
}

/* ===============================
   üì§ ‡πÅ‡∏ä‡∏£‡πå LINE
================================ */
function shareLine(data) {
  const topId = formatTopId(data.id);
  const url = location.href;

  const msg =
`${lang==="TH" ? "Bangwad Charity Run 2025" : "Bangwad Charity Run 2025"}
${text[lang].id}: ${topId}
${text[lang].name}: ${data.first_name} ${data.last_name}
${text[lang].type}: ${data.category}
${text[lang].status}: ${data.status}`;

  window.location.href = `https://line.me/R/share?text=${encodeURIComponent(msg + "\n" + url)}`;
}

/* ===============================
   üñ®Ô∏è PDF
================================ */
async function generatePDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const topId = formatTopId(data.id);

  const time = lang==="TH" ? formatThaiTime(data.created_at) : formatEnTime(data.created_at);

  doc.setFontSize(18);
  doc.text("Bangwad Charity Run 2025", 105, 20, { align: "center" });

  doc.setFontSize(14);
  doc.text(text[lang].id + ": " + topId, 20, 40);
  doc.text(text[lang].name + ": " + data.first_name + " " + data.last_name, 20, 50);
  doc.text(text[lang].type + ": " + data.category, 20, 60);
  doc.text(text[lang].regAt + ": " + time, 20, 70);

  doc.save(`BCR_${topId}.pdf`);
}

/* ===============================
   üîé Search
================================ */
async function searchData() {
  const nationalId = document.getElementById("nationalId").value.trim();
  const result = document.getElementById("result");

  if (!nationalId) {
    result.innerHTML = `<p style="color:#ef4444;">‚ùå ${text[lang].notfound}</p>`;
    return;
  }

  result.innerHTML = `<p style="color:#facc15;">${text[lang].loading}</p>`;

  const { data, error } = await sb
    .from("bangwad")
    .select("*")
    .eq("national_id", nationalId)
    .maybeSingle();

  if (error || !data) {
    result.innerHTML = `<p style="color:#ef4444;">${text[lang].notfound}</p>`;
    return;
  }

  let statusClass = "status-pending";
  if (data.status === "approved") statusClass = "status-approved";
  if (data.status === "rejected") statusClass = "status-rejected";

  const topId = formatTopId(data.id);
  const time = lang==="TH" ? formatThaiTime(data.created_at) : formatEnTime(data.created_at);

  result.innerHTML = `
    <div class="card">
      <p><span class="label">${text[lang].id}:</span> ${topId}</p>
      <p><span class="label">${text[lang].name}:</span> ${data.first_name} ${data.last_name}</p>
      <p><span class="label">${text[lang].type}:</span> ${data.category}</p>
      <p><span class="label">${text[lang].status}:</span> <span class="${statusClass}">${data.status}</span></p>
      <p><span class="label">${text[lang].regAt}:</span> ${time}</p>

      <button onclick='generatePDF(${JSON.stringify(data)})'>
        ${text[lang].download}
      </button>

      <button onclick='shareLine(${JSON.stringify(data)})' style="background:#06C755;">
        ${text[lang].share}
      </button>
    </div>`;
}
</script>

</body>
</html>
