<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ | Bangwad Charity Run</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0f172a;
    color: #fff;
    padding: 20px;
    text-align: center;
  }
  h1 { color: #facc15; margin-bottom: 20px; }
  input {
    width: 90%; max-width: 360px; padding: 12px; margin: 10px 0;
    border-radius: 10px; border: none; background: rgba(255,255,255,0.1);
    color: #fff; text-align: center; font-size: 1rem;
  }
  button {
    background: #3b82f6; color: #fff; padding: 12px 25px; border-radius: 25px;
    border: none; font-size: 1rem; font-weight: bold; margin-top: 10px; cursor: pointer;
  }
  .lang-btn { margin: 10px 5px; padding: 8px 16px; border-radius: 20px; background: #475569; }
  .card {
    background: rgba(255,255,255,0.08); padding: 20px; margin-top: 20px;
    border-radius: 15px; max-width: 420px; margin-left: auto; margin-right: auto;
    text-align: left; line-height: 1.6;
  }
  .label { color: #facc15; font-weight: bold; }

  .slip {
    width: 100%; max-width: 320px; margin-top: 10px; border-radius: 10px;
  }

  .status-approved { color: #4ade80; font-weight: bold; }
  .status-pending { color: #facc15; font-weight: bold; }
  .status-rejected { color: #ef4444; font-weight: bold; }
</style>
</head>

<body>

<h1 id="title">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h1>

<button id="toggleLangBtn" class="lang-btn" onclick="toggleLang()">
  TH / EN
</button>

<p id="desc">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Passport</p>

<input type="text" id="nationalId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/Passport">
<button onclick="searchData()" id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

<div id="result"></div>

<script>
/* ===================== CONFIG ===================== */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
let lang = "th";

/* ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î */
let lastData = null;
let lastBib = null;

/* ===================== MULTILANGUAGE ===================== */
const text = {
  th: {
    title: "üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
    desc: "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Passport",
    placeholder: "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£/Passport",
    search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
    notfound: "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ",
    loading: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
    name: "‡∏ä‡∏∑‡πà‡∏≠",
    age: "‡∏≠‡∏≤‡∏¢‡∏∏",
    phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
    email: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    regAt: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠",
    status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
    bib: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß",
    qr: "QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç"
  },
  en: {
    title: "üîç Check Registration Status",
    desc: "Enter National ID or Passport Number",
    placeholder: "Enter National ID / Passport",
    search: "Search",
    notfound: "‚ùå No data found",
    loading: "‚è≥ Searching...",
    name: "Name",
    age: "Age",
    phone: "Phone",
    email: "Email",
    type: "Category",
    regAt: "Registered At",
    status: "Status",
    bib: "BIB Number",
    qr: "QR Code for Bib Collection"
  }
};

function applyLanguage(){
  document.getElementById("title").innerText = text[lang].title;
  document.getElementById("desc").innerText = text[lang].desc;
  document.getElementById("nationalId").placeholder = text[lang].placeholder;
  document.getElementById("searchBtn").innerText = text[lang].search;

  renderResult(); // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏î‡πâ‡∏ß‡∏¢
}

function toggleLang(){
  lang = (lang === "th") ? "en" : "th";
  applyLanguage();
}

/* ===================== ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ ===================== */
function formatTime(t){
  if (!t) return "-";
  const date = new Date(t);

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡∏ô‡∏ô‡∏ß‡∏• (GMT+7)
  const thaiTime = new Date(date.getTime() + 7 * 60 * 60 * 1000);

  const yy = thaiTime.getFullYear();
  const mm = String(thaiTime.getMonth() + 1).padStart(2, "0");
  const dd = String(thaiTime.getDate()).padStart(2, "0");
  const hh = String(thaiTime.getHours()).padStart(2, "0");
  const mi = String(thaiTime.getMinutes()).padStart(2, "0");
  const ss = String(thaiTime.getSeconds()).padStart(2, "0");

  return `${dd}/${mm}/${yy} ${hh}:${mi}:${ss}`;
}


/* ===================== SEARCH DATA ===================== */
async function searchData(){
  const natId = document.getElementById("nationalId").value.trim();
  const resultBox = document.getElementById("result");

  if (!natId){
    resultBox.innerHTML = `<p style="color:#ef4444">${text[lang].notfound}</p>`;
    return;
  }

  resultBox.innerHTML = `<p style="color:#facc15">${text[lang].loading}</p>`;

  const { data, error } = await sb
    .from("bangwad")
    .select("*")
    .eq("national_id", natId)
    .maybeSingle();

  if (error || !data){
    resultBox.innerHTML = `<p style="color:#ef4444">${text[lang].notfound}</p>`;
    return;
  }

  /* ===== ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BIB ===== */
  const { data: allRows } = await sb
    .from("bangwad")
    .select("id")
    .order("id", { ascending: true });

  const index = allRows.findIndex(r => r.id === data.id);
  const bib = "TOP" + String(index + 1).padStart(3, "0");

  lastData = data;
  lastBib = bib;

  renderResult();
}

/* ===================== RENDER RESULT ===================== */
function renderResult(){
  if (!lastData) return;

  const data = lastData;
  const bib = lastBib;
  const result = document.getElementById("result");

  let displayStatus = data.status ?? "-";
  let rawStatus = displayStatus.toLowerCase();

  let statusClass = "status-pending";
  if (rawStatus === "approved") statusClass = "status-approved";
  else if (rawStatus === "rejected") statusClass = "status-rejected";

  const qrLink = `https://okeitaos.github.io/BangwadCharityRun/checkin.html?bib=${bib}`;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(qrLink)}`;

  const downloadText = (lang === "th")
      ? "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR CODE (JPG ‡∏´‡∏£‡∏∑‡∏≠ PNG)"
      : "Download the QR CODE (JPG or PNG)";

  /* ===============================
     ‚ùó BLOCK IF NOT APPROVED
  =============================== */
  if (rawStatus !== "approved") {
    result.innerHTML = `
      <div class="card">

        <p><span class="label">${text[lang].bib}:</span> ${bib}</p>
        <p><span class="label">${text[lang].name}:</span> ${data.first_name} ${data.last_name}</p>
        <p><span class="label">${text[lang].status}:</span>
          <span class="status-rejected">${displayStatus}</span>
        </p>

        <p style="margin-top:10px;">
          <span class="label">${text[lang].regAt}:</span> ${formatTime(data.created_at)}
        </p>

        <p style="color:#ef4444; font-weight:bold; margin-top:25px; text-align:center;">
          ${
            lang === "th"
            ? "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏ö‡πÑ‡∏î‡πâ"
            : "Payment not verified / Not approved<br>You cannot collect your BIB yet."
          }
        </p>

      </div>
    `;
    return; // ‚ùó‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á QR
  }

  /* ===============================
     ‚úî APPROVED ‚Üí ‡πÅ‡∏™‡∏î‡∏á QR + Download
  =============================== */
  result.innerHTML = `
    <div class="card">
      <p><span class="label">${text[lang].bib}:</span> ${bib}</p>
      <p><span class="label">${text[lang].name}:</span> ${data.first_name} ${data.last_name}</p>
      <p><span class="label">${text[lang].age}:</span> ${data.age}</p>
      <p><span class="label">${text[lang].phone}:</span> ${data.phone}</p>
      <p><span class="label">${text[lang].email}:</span> ${data.email}</p>
      <p><span class="label">${text[lang].type}:</span> ${data.category}</p>

      <p>
        <span class="label">${text[lang].status}:</span>
        <span class="${statusClass}">${displayStatus}</span>
      </p>

      <p><span class="label">${text[lang].regAt}:</span> 
        ${formatTime(data.created_at)}
      </p>

      ${data.slip_url ? `<img src="${data.slip_url}" class="slip">` : ""}

      <div style="text-align:center;margin-top:25px;">
        <p class="label">${text[lang].qr}</p>
        <img id="qrImg" src="${qrUrl}" style="width:240px;height:240px;border-radius:10px;">

        <p style="margin-top:15px; font-size:1rem; color:#facc15;">
          ${
            lang === "th"
            ? "‡∏ô‡∏≥ QR CODE ‡∏ô‡∏µ‡πâ ‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏ö"
            : "Bring this QR CODE to collect your BIB"
          }
        </p>

        <p style="margin-top:8px; font-size:0.9rem; color:#38bdf8;">
          ${downloadText}
        </p>

        <div style="margin-top:12px;">
          <button onclick="downloadQR('${qrUrl}', 'jpg', '${data.first_name} ${data.last_name}', '${bib}')"
            style="background:#14b8a6;padding:10px 20px;border-radius:10px;margin:5px;color:white;">
            JPG
          </button>

          <button onclick="downloadQR('${qrUrl}', 'png', '${data.first_name} ${data.last_name}', '${bib}')"
            style="background:#0ea5e9;padding:10px 20px;border-radius:10px;margin:5px;color:white;">
            PNG
          </button>
        </div>

      </div>
    </div>
  `;
}


async function downloadQR(qrUrl, type, fullName, bibNumber) {
  const LOGO_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co/storage/v1/object/public/user-images/Logo-CharityRun3D.png";
  const finalUrl = qrUrl.replace("size=240x240", "size=900x900");

  const qrImg = new Image();
  const logoImg = new Image();

  qrImg.crossOrigin = "Anonymous";
  logoImg.crossOrigin = "Anonymous";

  qrImg.src = finalUrl;
  logoImg.src = LOGO_URL;

  await Promise.all([
    new Promise(r => qrImg.onload = r),
    new Promise(r => logoImg.onload = r)
  ]);

  const canvas = document.createElement("canvas");

  const W = 1200; 
  const H = 1800;

  canvas.width = W;
  canvas.height = H;

  const ctx = canvas.getContext("2d");

  /* ========= Background ========= */
  const radius = 44;
  ctx.fillStyle = "#ffffff";
  roundRect(ctx, 0, 0, W, H, radius, true, false);

  /* ========= Header (Dark Blue) ========= */
  ctx.fillStyle = "#0f172a";
  roundRect(ctx, 0, 0, W, 420, {tl: radius, tr: radius, br: 0, bl: 0}, true, false);

  /* ========= Logo ========= */
  const logoSize = 240;
  const logoX = (W - logoSize) / 2;
  const logoY = 60;
  ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);

  /* ========= Title ========= */
  ctx.fillStyle = "#facc15";
  ctx.font = "bold 58px Prompt";
  ctx.textAlign = "center";
  ctx.fillText("BANGWAD CHARITY RUN 2025", W / 2, 360);

  /* ========= Name & BIB ========= */
  ctx.fillStyle = "#0f172a";
  ctx.font = "bold 70px Prompt";
  ctx.fillText(fullName, W / 2, 540);

  ctx.fillStyle = "#475569";
  ctx.font = "bold 60px Prompt";
  ctx.fillText("BIB : " + bibNumber, W / 2, 620);

  /* ========= Divider ========= */
  ctx.strokeStyle = "#e2e8f0";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(140, 680);
  ctx.lineTo(W - 140, 680);
  ctx.stroke();

  /* ========= QR CODE ========= */
  const qrSize = 860;
  const qrX = (W - qrSize) / 2;
  const qrY = 740;

  ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

  /* ========= Save ========= */
  const mime = type === "jpg" ? "image/jpeg" : "image/png";
  const dataURL = canvas.toDataURL(mime, 1.0);

  const link = document.createElement("a");
  link.href = dataURL;
  link.download = `BIB_${bibNumber}.${type}`;
  document.body.appendChild(link);
  link.click();
  link.remove();
}
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke === 'undefined') stroke = true;
  if (typeof radius === 'number') {
    radius = {tl: radius, tr: radius, br: radius, bl: radius};
  }
  ctx.beginPath();
  ctx.moveTo(x + radius.tl, y);
  ctx.lineTo(x + width - radius.tr, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
  ctx.lineTo(x + width, y + height - radius.br);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
  ctx.lineTo(x + radius.bl, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
  ctx.lineTo(x, y + radius.tl);
  ctx.quadraticCurveTo(x, y, x + radius.tl, y);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}



  
applyLanguage();
</script>

</body>
</html>
