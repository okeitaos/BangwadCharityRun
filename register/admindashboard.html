<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üèÅ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  body { font-family: 'Prompt', sans-serif; }
  .status-dnf { background-color: #fee2e2; color: #991b1b; }
  .status-finisher { background-color: #dcfce7; color: #065f46; }
  .table-scroll { max-height: 70vh; overflow-y: auto; }
  #loadingOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; justify-content: center; align-items: center;
    color: white; font-size: 1.5rem; font-weight: 600;
    z-index: 9999; display: none;
  }
  @media print {
    #filterSection, #exportBtn, #printBtn, #loadingOverlay { display: none; }
    body { background: white; }
    .table-scroll { max-height: none; overflow: visible; }
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<!-- üåÄ Loading Overlay -->
<div id="loadingOverlay">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>

<div class="max-w-7xl mx-auto bg-white shadow-md rounded-lg p-6">
  <h1 class="text-3xl font-bold text-center mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

  <!-- üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
  <div id="filterSection" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
    <div>
      <label class="block text-sm font-semibold mb-1">‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</label>
      <select id="filterType" class="w-full border rounded-md p-2">
        <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="BCR 50.4">BCR 50.4</option>
        <option value="BCR 69.3">BCR 69.3</option>
        <option value="BCR 100.8">BCR 100.8</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
      <input type="date" id="filterStart" class="w-full border rounded-md p-2">
    </div>
    <div>
      <label class="block text-sm font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
      <input type="date" id="filterEnd" class="w-full border rounded-md p-2">
    </div>
    <div class="flex flex-col justify-end gap-2">
      <button id="filterBtn" class="bg-blue-600 text-white rounded-md py-2">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
      <button id="printBtn" class="bg-gray-700 text-white rounded-md py-2">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <!-- üßÆ ‡∏™‡∏£‡∏∏‡∏õ -->
  <div id="summarySection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
    <div class="bg-green-100 p-4 rounded shadow-sm">
      <div class="text-sm text-gray-700">FINISHER</div>
      <div id="countFinisher" class="text-3xl font-bold text-green-700">0</div>
    </div>
    <div class="bg-red-100 p-4 rounded shadow-sm">
      <div class="text-sm text-gray-700">DNF</div>
      <div id="countDNF" class="text-3xl font-bold text-red-700">0</div>
    </div>
    <div class="bg-yellow-100 p-4 rounded shadow-sm">
      <div class="text-sm text-gray-700">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div id="countTotal" class="text-3xl font-bold text-yellow-700">0</div>
    </div>
    <div class="bg-blue-100 p-4 rounded shadow-sm">
      <div class="text-sm text-gray-700">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
      <div id="dateRange" class="text-base font-medium text-blue-700">-</div>
    </div>
  </div>

  <!-- üß© ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô -->
  <div id="summaryByType" class="mb-6 bg-gray-50 border rounded-lg p-4">
    <h2 class="text-lg font-semibold mb-3">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
    <div id="typeSummaryContent" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
  </div>

  <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="flex justify-between mb-4">
    <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, BIB, ‡∏´‡∏£‡∏∑‡∏≠ Tag ID..." class="border rounded-md p-2 flex-grow max-w-md">
    <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded ml-2">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
  <div class="overflow-x-auto table-scroll border rounded-lg">
    <table class="min-w-full text-sm border-collapse">
      <thead class="bg-gray-200 sticky top-0">
        <tr>
          <th class="p-2 border">BIB</th>
          <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-2 border">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-2 border">‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</th>
          <th class="p-2 border">‡∏£‡∏∞‡∏¢‡∏∞ (‡∏Å‡∏°.)</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 border">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
          <th class="p-2 border">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let allData = [];

const overlay = document.getElementById("loadingOverlay");
function showLoading(show) { overlay.style.display = show ? "flex" : "none"; }

async function loadReport() {
  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
  showLoading(true);

  const { data, error } = await supabase
    .from("v_runner_exit_report")
    .select("*")
    .order("exit_time_th", { ascending: false });

  showLoading(false);
  if (error) {
    console.error(error);
    tbody.innerHTML = `<tr><td colspan="11" class="text-center text-red-500 py-4">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
    return;
  }

  allData = data;
  updateSummary(allData);
  renderReport(allData);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö
function getRaceName(row) {
  return (
    row.race_name_th ||
    row.type ||
    row.category ||
    row.race_name ||
    ""
  ).toUpperCase();
}

// ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô
document.getElementById("filterBtn").addEventListener("click", () => {
  showLoading(true);
  setTimeout(() => {
    const type = document.getElementById("filterType").value;
    const start = document.getElementById("filterStart").value
      ? new Date(document.getElementById("filterStart").value)
      : null;
    const end = document.getElementById("filterEnd").value
      ? new Date(document.getElementById("filterEnd").value + "T23:59:59")
      : null;

    let filtered = [...allData];

    // üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏∏‡πà‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
    if (type !== "ALL") {
      filtered = filtered.filter((r) => getRaceName(r).includes(type.toUpperCase()));
    }

    // üìÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
    if (start && end) {
      filtered = filtered.filter((r) => {
        const exitDate = new Date(r.exit_time_th);
        return exitDate >= start && exitDate <= end;
      });
    }

    updateSummary(filtered);
    renderReport(filtered);
    showLoading(false);
  }, 200);
});

// üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
document.getElementById("searchInput").addEventListener("input", (e) => {
  const q = e.target.value.toLowerCase();
  showLoading(true);
  setTimeout(() => {
    const filtered = allData.filter(
      (r) =>
        (r.runner_name || "").toLowerCase().includes(q) ||
        (r.bib || "").toString().includes(q) ||
        (r.tag_id || "").toLowerCase().includes(q)
    );
    updateSummary(filtered);
    renderReport(filtered);
    showLoading(false);
  }, 200);
});

// üßÆ ‡∏™‡∏£‡∏∏‡∏õ
function updateSummary(list) {
  const finisher = list.filter((r) => r.exit_status === "FINISHER").length;
  const dnf = list.filter((r) => r.exit_status === "DNF").length;
  document.getElementById("countFinisher").textContent = finisher;
  document.getElementById("countDNF").textContent = dnf;
  document.getElementById("countTotal").textContent = list.length;
  document.getElementById("dateRange").textContent = new Date().toLocaleDateString("th-TH");

  const types = ["BCR 50.4", "BCR 69.3", "BCR 100.8"];
  const typeSummaryDiv = document.getElementById("typeSummaryContent");
  typeSummaryDiv.innerHTML = "";

  types.forEach((type) => {
    const f = list.filter((r) => getRaceName(r).includes(type.toUpperCase()) && r.exit_status === "FINISHER").length;
    const d = list.filter((r) => getRaceName(r).includes(type.toUpperCase()) && r.exit_status === "DNF").length;
    typeSummaryDiv.innerHTML += `
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-2">${type}</h3>
        <div class="flex justify-between"><span class="text-green-700">FINISHER:</span><span>${f}</span></div>
        <div class="flex justify-between"><span class="text-red-700">DNF:</span><span>${d}</span></div>
        <div class="flex justify-between mt-1 border-t pt-1"><span class="text-gray-600 text-sm">‡∏£‡∏ß‡∏°:</span><span>${f + d}</span></div>
      </div>`;
  });
}

// üßæ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderReport(list) {
  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = "";
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</td></tr>`;
    return;
  }
  list.forEach((r) => {
    const statusClass = r.exit_status === "DNF" ? "status-dnf" : "status-finisher";
    tbody.innerHTML += `
      <tr class="border-b hover:bg-gray-50 ${statusClass}">
        <td class="p-2 text-center">${r.bib || "-"}</td>
        <td class="p-2">${r.runner_name}</td>
        <td class="p-2 text-center">${getRaceName(r)}</td>
        <td class="p-2 text-center font-semibold">${r.exit_status}</td>
        <td class="p-2 text-center">${r.last_lap}</td>
        <td class="p-2 text-center">${r.distance_km}</td>
        <td class="p-2 text-center">${r.total_running_time || "-"}</td>
        <td class="p-2 text-center">${r.avg_lap_time || "-"}</td>
        <td class="p-2">${r.exit_reason || "-"}</td>
        <td class="p-2 text-center">${r.updated_by_name || "-"}</td>
        <td class="p-2 text-center">${r.exit_time_th ? new Date(r.exit_time_th).toLocaleString("th-TH") : "-"}</td>
      </tr>`;
  });
}

// üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
document.getElementById("printBtn").addEventListener("click", () => window.print());

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
loadReport();
</script>

</body>
</html>
