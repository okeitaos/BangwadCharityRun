<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üèÅ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  body { font-family: 'Prompt', sans-serif; }
  .status-dnf { background-color: #fee2e2; color: #991b1b; }
  .status-finisher { background-color: #dcfce7; color: #065f46; }
  .table-scroll { max-height: 75vh; overflow-y: auto; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto bg-white shadow-md rounded-lg p-6">
  <h1 class="text-3xl font-bold text-center mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

  <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="flex flex-wrap justify-between mb-4 gap-2">
    <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, BIB, ‡∏´‡∏£‡∏∑‡∏≠ Tag ID..." class="border rounded-md p-2 flex-grow max-w-md">
    <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
  <div class="overflow-x-auto table-scroll border rounded-lg">
    <table class="min-w-full text-sm border-collapse">
      <thead class="bg-gray-200 sticky top-0">
        <tr>
          <th class="p-2 border">BIB</th>
          <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-2 border">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-2 border">‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</th>
          <th class="p-2 border">‡∏£‡∏∞‡∏¢‡∏∞ (‡∏Å‡∏°.)</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 border">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
          <th class="p-2 border">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</th>
          <th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const searchInput = document.getElementById("searchInput");
const reportBody = document.getElementById("reportBody");
const exportBtn = document.getElementById("exportBtn");

let allData = [];

async function loadReport() {
  reportBody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

  const { data, error } = await supabase.from("v_runner_exit_report").select("*").order("exit_time_th", { ascending: false });
  if (error) {
    console.error(error);
    reportBody.innerHTML = `<tr><td colspan="11" class="text-center text-red-500 py-4">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
    return;
  }

  allData = data;
  renderReport(data);
}

function renderReport(list) {
  reportBody.innerHTML = "";
  if (!list.length) {
    reportBody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</td></tr>`;
    return;
  }

  list.forEach(r => {
    const statusClass = r.exit_status === "DNF" ? "status-dnf" : "status-finisher";
    reportBody.innerHTML += `
      <tr class="border-b hover:bg-gray-50 ${statusClass}">
        <td class="p-2 text-center">${r.bib || "-"}</td>
        <td class="p-2">${r.runner_name}</td>
        <td class="p-2 text-center">${r.race_name_th}</td>
        <td class="p-2 text-center font-semibold">${r.exit_status}</td>
        <td class="p-2 text-center">${r.last_lap}</td>
        <td class="p-2 text-center">${r.distance_km}</td>
        <td class="p-2 text-center">${r.total_running_time || "-"}</td>
        <td class="p-2 text-center">${r.avg_lap_time || "-"}</td>
        <td class="p-2">${r.exit_reason || "-"}</td>
        <td class="p-2 text-center">${r.updated_by_name || "-"}</td>
        <td class="p-2 text-center">${r.exit_time_th ? new Date(r.exit_time_th).toLocaleString("th-TH") : "-"}</td>
      </tr>
    `;
  });
}

// üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / BIB / Tag ID
searchInput.addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  const filtered = allData.filter(r =>
    (r.runner_name || "").toLowerCase().includes(q) ||
    (r.bib || "").toString().includes(q) ||
    (r.tag_id || "").toLowerCase().includes(q)
  );
  renderReport(filtered);
});

// ‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel (CSV)
exportBtn.addEventListener("click", () => {
  if (!allData.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å");
  const headers = [
    "BIB","‡∏ä‡∏∑‡πà‡∏≠","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢","‡∏£‡∏∞‡∏¢‡∏∞(‡∏Å‡∏°.)",
    "‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°","‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö","‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•","‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£","‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å"
  ];
  const csv = [
    headers.join(","),
    ...allData.map(r => [
      r.bib, `"${r.runner_name}"`, r.race_name_th, r.exit_status, r.last_lap,
      r.distance_km, r.total_running_time, r.avg_lap_time,
      `"${r.exit_reason || ""}"`, `"${r.updated_by_name || ""}"`, r.exit_time_th
    ].join(","))
  ].join("\n");

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "runner_exit_report.csv";
  a.click();
  URL.revokeObjectURL(url);
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
loadReport();

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
supabase.channel("dnf_log_changes")
  .on("postgres_changes", { event: "*", schema: "public", table: "dnf_log" }, loadReport)
  .subscribe();
</script>
</body>
</html>
