<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  body { font-family: 'Prompt', sans-serif; }
  @media print {
    #filterSection, #actionButtons, #loadingOverlay { display: none; }
    body { background: white; color: black; }
  }
  .status-dnf { background-color: #fee2e2; }
  .status-finisher { background-color: #d1fae5; }
  #loadingOverlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.8);
    display: none; justify-content: center; align-items: center; z-index: 50;
    font-size: 1.2rem; color: #333;
  }
</style>
</head>

<body class="bg-gray-100 min-h-screen p-4">
<div id="loadingOverlay">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<h1 class="text-2xl font-bold text-center mb-4">üèÅ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

<!-- üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
<div id="filterSection" class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow mb-4">
  <div class="flex flex-wrap gap-3 items-center">
    <select id="filterType" class="border p-2 rounded">
      <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="BCR 50.4">BCR 50.4</option>
      <option value="BCR 69.3">BCR 69.3</option>
      <option value="BCR 100.8">BCR 100.8</option>
    </select>
    <input id="filterStart" type="date" class="border p-2 rounded" />
    <input id="filterEnd" type="date" class="border p-2 rounded" />
    <button id="filterBtn" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

    <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ / BIB / Tag ID"
      class="border p-2 rounded flex-grow max-w-sm" />
  </div>
</div>

<!-- üìä ‡∏™‡∏£‡∏∏‡∏õ -->
<div class="max-w-6xl mx-auto mb-4 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
  <div class="bg-green-100 p-4 rounded-lg shadow">
    <div class="text-2xl font-bold text-green-700" id="countFinisher">0</div>
    <div>FINISHER</div>
  </div>
  <div class="bg-red-100 p-4 rounded-lg shadow">
    <div class="text-2xl font-bold text-red-700" id="countDNF">0</div>
    <div>DNF</div>
  </div>
  <div class="bg-gray-100 p-4 rounded-lg shadow">
    <div class="text-2xl font-bold" id="countTotal">0</div>
    <div>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
  </div>
</div>

<!-- üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô -->
<div class="max-w-6xl mx-auto mb-6">
  <h2 class="text-lg font-semibold mb-2">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
  <div id="typeSummaryContent" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
</div>

<!-- üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<div class="max-w-6xl mx-auto bg-white rounded-lg shadow p-4 overflow-x-auto">
  <table class="w-full text-sm border-collapse">
    <thead>
      <tr class="bg-gray-200 text-gray-800">
        <th class="p-2 text-center">BIB</th>
        <th class="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏£‡∏∏‡πà‡∏ô</th>
        <th class="p-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
        <th class="p-2 text-center">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-left">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
        <th class="p-2 text-center">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
</div>

<!-- üßæ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
<div id="actionButtons" class="max-w-6xl mx-auto text-center mt-4 flex flex-wrap justify-center gap-3">
  <button id="printBtn" class="bg-gray-600 text-white px-4 py-2 rounded">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  <button id="excelBtn" class="bg-green-600 text-white px-4 py-2 rounded">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let allData = [];
let filteredData = [];

const overlay = document.getElementById("loadingOverlay");
function showLoading(show) { overlay.style.display = show ? "flex" : "none"; }

async function loadReport() {
  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-gray-500">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
  showLoading(true);

  const { data, error } = await supabase.from("v_runner_exit_report").select("*").order("exit_time_th", { ascending: false });
  showLoading(false);

  if (error) { console.error(error); return; }
  allData = data || [];
  filteredData = [...allData];
  updateSummary(filteredData);
  renderReport(filteredData);
}

function getRaceType(r) { return (r.race_type || "").toUpperCase(); }

document.getElementById("filterBtn").addEventListener("click", () => {
  showLoading(true);
  setTimeout(() => {
    const type = document.getElementById("filterType").value;
    const start = document.getElementById("filterStart").value ? new Date(document.getElementById("filterStart").value) : null;
    const end = document.getElementById("filterEnd").value ? new Date(document.getElementById("filterEnd").value + "T23:59:59") : null;

    filteredData = [...allData];
    if (type !== "ALL") filteredData = filteredData.filter((r) => getRaceType(r).includes(type.toUpperCase()));
    if (start && end) filteredData = filteredData.filter((r) => new Date(r.exit_time_th) >= start && new Date(r.exit_time_th) <= end);

    updateSummary(filteredData);
    renderReport(filteredData);
    showLoading(false);
  }, 200);
});

document.getElementById("searchInput").addEventListener("input", (e) => {
  const q = e.target.value.toLowerCase();
  filteredData = allData.filter((r) =>
    (r.runner_name || "").toLowerCase().includes(q) ||
    (r.bib || "").toString().includes(q) ||
    (r.tag_id || "").toLowerCase().includes(q)
  );
  updateSummary(filteredData);
  renderReport(filteredData);
});

function updateSummary(list) {
  const finisher = list.filter((r) => r.exit_status === "FINISHER").length;
  const dnf = list.filter((r) => r.exit_status === "DNF").length;
  document.getElementById("countFinisher").textContent = finisher;
  document.getElementById("countDNF").textContent = dnf;
  document.getElementById("countTotal").textContent = list.length;

  const types = ["BCR 50.4", "BCR 69.3", "BCR 100.8"];
  const div = document.getElementById("typeSummaryContent");
  div.innerHTML = "";
  types.forEach((t) => {
    const f = list.filter((r) => getRaceType(r).includes(t.toUpperCase()) && r.exit_status === "FINISHER").length;
    const d = list.filter((r) => getRaceType(r).includes(t.toUpperCase()) && r.exit_status === "DNF").length;
    div.innerHTML += `
      <div class="bg-white border rounded-lg p-3 shadow-sm">
        <div class="font-semibold">${t}</div>
        <div class="flex justify-between text-sm text-green-700"><span>FINISHER:</span><span>${f}</span></div>
        <div class="flex justify-between text-sm text-red-700"><span>DNF:</span><span>${d}</span></div>
        <div class="flex justify-between text-sm border-t mt-1 pt-1"><span>‡∏£‡∏ß‡∏°:</span><span>${f + d}</span></div>
      </div>`;
  });
}

function renderReport(list) {
  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = "";
  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="11" class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }
  list.forEach((r) => {
    const c = r.exit_status === "DNF" ? "status-dnf" : "status-finisher";
    tbody.innerHTML += `
      <tr class="${c} border-b hover:bg-gray-50">
        <td class="p-2 text-center">${r.bib || "-"}</td>
        <td class="p-2">${r.runner_name}</td>
        <td class="p-2 text-center">${r.race_type}</td>
        <td class="p-2 text-center">${r.exit_status}</td>
        <td class="p-2 text-center">${r.last_lap || "-"}</td>
        <td class="p-2 text-center">${r.distance_km || "-"}</td>
        <td class="p-2 text-center">${r.total_running_time || "-"}</td>
        <td class="p-2 text-center">${r.avg_lap_time || "-"}</td>
        <td class="p-2">${r.exit_reason || "-"}</td>
        <td class="p-2 text-center">${r.updated_by_name || "-"}</td>
        <td class="p-2 text-center">${r.exit_time_th ? new Date(r.exit_time_th).toLocaleString("th-TH") : "-"}</td>
      </tr>`;
  });
}

document.getElementById("printBtn").addEventListener("click", () => window.print());

// üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel
document.getElementById("excelBtn").addEventListener("click", () => {
  const list = filteredData.length ? filteredData : allData;
  if (!list.length) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");

  const rows = list.map((r) => ({
    BIB: r.bib || "-",
    ‡∏ä‡∏∑‡πà‡∏≠: r.runner_name || "-",
    ‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: r.race_type || "-",
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: r.exit_status || "-",
    ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: r.last_lap || "-",
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: r.distance_km || "-",
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: r.total_running_time || "-",
    ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö: r.avg_lap_time || "-",
    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: r.exit_reason || "-",
    ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£: r.updated_by_name || "-",
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: r.exit_time_th ? new Date(r.exit_time_th).toLocaleString("th-TH") : "-"
  }));

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Exit Report");
  const fileName = `Runner_Exit_Report_${new Date().toLocaleDateString("th-TH").replace(/\//g,"-")}.xlsx`;
  XLSX.writeFile(wb, fileName);
});

loadReport();
</script>
</body>
</html>
