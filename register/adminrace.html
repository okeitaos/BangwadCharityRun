<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (Realtime + Confirm DNF/FINISHER)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  @keyframes blinkGold { 0%,100%{background-color:#d1fae5;} 50%{background-color:#fef3c7;} }
  @keyframes blinkYellow { 0%,100%{background-color:#fff9c4;} 50%{background-color:#fde68a;} }
  .blink-finisher { animation: blinkGold 1.8s infinite; }
  .blink-dnf { animation: blinkYellow 1.8s infinite; }
  #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
  .toast { background: #333; color: #fff; padding: 10px 16px; border-radius: 8px; margin-top: 8px; min-width: 250px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: fadeInUp 0.4s forwards; }
  @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-5xl mx-auto bg-white rounded-lg shadow p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (Realtime + Confirm DNF/FINISHER)</h1>

  <!-- üîê Login -->
  <div id="login-section">
    <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£" class="border p-2 w-full rounded mb-2">
    <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border p-2 w-full rounded mb-2">
    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <!-- üßë‚Äç‚öñÔ∏è Admin Section -->
  <div id="admin-section" class="hidden">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
      <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div class="flex flex-wrap gap-2 mb-4">
      <input id="searchInput" type="text" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ Tag ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded flex-grow">
      <button id="clearBtn" class="bg-gray-300 px-3 py-2 rounded">‡∏•‡πâ‡∏≤‡∏á</button>
      <button id="showAllBtn" class="bg-blue-500 text-white px-3 py-2 rounded">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="showRunningBtn" class="bg-green-600 text-white px-3 py-2 rounded">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ RUNNING</button>
    </div>

    <p id="lastUpdate" class="text-xs text-gray-500 mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</p>
    <div id="runnerList" class="space-y-3"></div>
  </div>
</div>

<!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<audio id="alertDnf" preload="auto" src="https://cdn.jsdelivr.net/gh/napthedev/sounds@main/warning-beep.mp3"></audio>
<audio id="alertFinisher" preload="auto" src="https://cdn.jsdelivr.net/gh/napthedev/sounds@main/win.mp3"></audio>

<!-- Popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<div id="toast-container"></div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üëà ‡πÉ‡∏™‡πà anon key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const alertDnf = document.getElementById("alertDnf");
const alertFinisher = document.getElementById("alertFinisher");
const toastContainer = document.getElementById("toast-container");

let currentUser = null;
let searchTimeout = null;
let showOnlyRunning = false;

// ============================ LOGIN ============================
window.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) autoLogin(session.user);
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_IN" && session) autoLogin(session.user);
    if (event === "SIGNED_OUT") showLogin();
  });
});

async function autoLogin(user) {
  const { data: profile } = await supabase
    .from("adminrace")
    .select("is_admin, full_name")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile || !profile.is_admin) {
    await supabase.auth.signOut();
    return alert("‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  }

  currentUser = { id: user.id, name: profile.full_name };
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("admin-section").classList.remove("hidden");

  loadRunners();
  startRealtimeListener();
  setInterval(loadRunners, 10000);
}

document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert("‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  autoLogin(data.user);
};
document.getElementById("logoutBtn").onclick = async () => { await supabase.auth.signOut(); showLogin(); };

function showLogin() {
  currentUser = null;
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("admin-section").classList.add("hidden");
}

// ============================ SEARCH / FILTER ============================
const searchInput = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const showAllBtn = document.getElementById("showAllBtn");
const showRunningBtn = document.getElementById("showRunningBtn");
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => loadRunners(searchInput.value), 800);
});
clearBtn.onclick = () => { searchInput.value = ""; loadRunners(); };
showAllBtn.onclick = () => { showOnlyRunning = false; loadRunners(); };
showRunningBtn.onclick = () => { showOnlyRunning = true; loadRunners(); };

// ============================ LOAD RUNNERS ============================
async function loadRunners(query = "") {
  let queryBuilder = supabase
    .from("runner")
    .select("id, name, tag_id, type, status, record(lap, start_time, finish_time)")
    .order("name", { ascending: true });

  if (query.trim() !== "") queryBuilder = queryBuilder.or(`name.ilike.%${query}%,tag_id.ilike.%${query}%`);
  if (showOnlyRunning) queryBuilder = queryBuilder.eq("status", "RUNNING");

  const { data: runners, error } = await queryBuilder;
  if (error) return console.error(error);

  const runnerList = document.getElementById("runnerList");
  runnerList.innerHTML = "";

  (runners || []).forEach(r => {
    const laps = (r.record || []).filter(x => x.start_time).map(x => x.lap);
    const showLap = laps.length ? Math.max(...laps) : 0;
    const distance = (showLap * 6.3).toFixed(2);

    const normalizedType = (r.type || "").replace(/\s+/g, "").toUpperCase();
    let finisherRequired = 0, dnfStart = 0;
    if (normalizedType.includes("BCR50.4")) { finisherRequired = 8; dnfStart = 4; }
    else if (normalizedType.includes("BCR69.3")) { finisherRequired = 11; dnfStart = 6; }
    else if (normalizedType.includes("BCR100.8")) { finisherRequired = 16; dnfStart = 8; }

    const canFinish = showLap >= finisherRequired;

    let bgClass = r.status === "DNF" ? "bg-red-50" :
                  r.status === "FINISHER" ? "blink-finisher" :
                  "bg-green-50";

    let info = showLap === 0
      ? "‚úÖ Check-in ‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á)"
      : `üèÅ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: ${showLap} / ${finisherRequired}<br>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°.`;

    let buttons = "";
    if (r.status === "FINISHER" || r.status === "DNF") {
      buttons = `<span class="text-gray-500 text-sm">üö´ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`;
    } else if (canFinish) {
      buttons = `
        <div class="flex flex-col items-end gap-1">
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="confirmChange('${r.id}','FINISHER','${r.name}')">FINISHER</button>
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="confirmChange('${r.id}','DNF','${r.name}')">DNF</button>
        </div>`;
    } else if (r.status === "RUNNING") {
      buttons = `
        <div class="flex flex-col items-end gap-1">
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="confirmChange('${r.id}','DNF','${r.name}')">DNF</button>
        </div>`;
    }

    runnerList.innerHTML += `
      <div class="border p-3 rounded flex justify-between items-center ${bgClass}">
        <div>
          <b>${r.name}</b> (${r.type})<br>
          üè∑Ô∏è Tag ID: ${r.tag_id || "-"}<br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r.status}<br>${info}
        </div>
        <div>${buttons}</div>
      </div>`;
  });

  document.getElementById("lastUpdate").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString("th-TH");
}

// ============================ CONFIRM + UPDATE ============================
async function confirmChange(runnerId, status, name) {
  const confirm1 = confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á "${name}" ‡πÄ‡∏õ‡πá‡∏ô ${status}?`);
  if (!confirm1) return;
  const confirm2 = confirm("‚ùó ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (!confirm2) return;

  const reason = prompt(status === "DNF" ? "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• DNF:" : "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ FINISHER:", "‡∏Ñ‡∏£‡∏ö‡∏£‡∏∞‡∏¢‡∏∞ / ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ");
  if (!reason) return;

  await supabase.from("runner").update({ status }).eq("id", runnerId);
  await supabase.from("dnf_log").insert({ runner_id: runnerId, status, reason, updated_by: currentUser.id });

  showToast(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á ${name} ‡πÄ‡∏õ‡πá‡∏ô ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadRunners(searchInput.value);
}

// ============================ REALTIME ============================
function startRealtimeListener() {
  supabase.channel("record-changes")
    .on("postgres_changes", { event: "*", schema: "public", table: "record" }, payload => {
      const lap = payload.new?.lap;
      if (!lap) return;
      loadRunners(searchInput.value);
      if ([4,6,8].includes(lap)) { alertDnf.play(); showToast(`‚ö†Ô∏è ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞ DNF (‡∏£‡∏≠‡∏ö ${lap})`); }
      if ([8,11,16].includes(lap)) { alertFinisher.play(); showToast(`üèÜ ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞ FINISHER (‡∏£‡∏≠‡∏ö ${lap})`); }
    })
    .subscribe();
}

// ============================ TOAST ============================
function showToast(message) {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = message;
  toastContainer.appendChild(t);
  setTimeout(() => {
    t.style.transition = "opacity 0.5s";
    t.style.opacity = "0";
    setTimeout(() => t.remove(), 500);
  }, 3500);
}
</script>
</body>
</html>
