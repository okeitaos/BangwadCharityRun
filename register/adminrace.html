<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (Supabase Auth)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h1>

    <!-- üîê ‡∏™‡πà‡∏ß‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
    <div id="login-section">
      <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£" class="border p-2 w-full rounded mb-2">
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border p-2 w-full rounded mb-2">
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p id="loginStatus" class="text-center text-sm text-gray-600 mt-2"></p>
    </div>

    <!-- üßë‚Äç‚öñÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á -->
    <div id="admin-section" class="hidden">
      <div class="flex justify-between mb-4">
        <h2 class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border p-2 w-full rounded mb-4">
      <div id="runnerList" class="space-y-2"></div>

      <hr class="my-6">
      <h2 class="text-lg font-semibold mb-2">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (DNF / FINISHER)</h2>
      <div id="logList" class="space-y-1 text-sm text-gray-700"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co"; // üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const loginSection = document.getElementById("login-section");
const adminSection = document.getElementById("admin-section");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginStatus = document.getElementById("loginStatus");
const searchInput = document.getElementById("searchInput");
const runnerList = document.getElementById("runnerList");
const logList = document.getElementById("logList");

let currentUser = null;

// üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
loginBtn.addEventListener("click", async () => {
  loginStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput.value,
    password: passwordInput.value
  });

  if (error) {
    loginStatus.textContent = "‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    return;
  }

  const user = data.user;
  const { data: profile } = await supabase
    .from("adminrace")
    .select("is_admin, full_name")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile || !profile.is_admin) {
    await supabase.auth.signOut();
    loginStatus.textContent = "‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    return;
  }

  currentUser = { id: user.id, name: profile.full_name || user.email };
  loginSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
  loadRunners();
  loadLogs();
});

// üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  currentUser = null;
  loginSection.classList.remove("hidden");
  adminSection.classList.add("hidden");
});

// üìã ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á
async function loadRunners(query = "") {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id, name, type, status")
    .ilike("name", `%${query}%`)
    .order("name", { ascending: true });

  if (error) return console.error(error);

  runnerList.innerHTML = "";
  runners.forEach(r => {
    runnerList.innerHTML += `
      <div class="border p-3 rounded flex justify-between items-center">
        <div>
          <b>${r.name}</b> (${r.type})<br>
          <span class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r.status}</span>
        </div>
        <div class="space-x-1">
          <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="updateStatus('${r.id}', 'RUNNING')">RUNNING</button>
          <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="updateStatus('${r.id}', 'DNF')">DNF</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="updateStatus('${r.id}', 'FINISHER')">FINISHER</button>
        </div>
      </div>
    `;
  });
}

// üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á
searchInput.addEventListener("input", e => loadRunners(e.target.value));

// ‚úèÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á
async function updateStatus(runnerId, status) {
  const reason = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:", status === "DNF" ? "‡πÄ‡∏à‡πá‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô" : status === "FINISHER" ? "‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö" : "");
  if (!reason) return;

  const { error: updateError } = await supabase
    .from("runner")
    .update({ status })
    .eq("id", runnerId);

  if (updateError) {
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: " + updateError.message);
    return;
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á dnf_log
  await supabase.from("dnf_log").insert({
    runner_id: runnerId,
    status,
    reason,
    updated_by: currentUser.id
  });

  alert(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadRunners(searchInput.value);
  loadLogs();
}

// üßæ ‡πÇ‡∏´‡∏•‡∏î Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
// üßæ ‡πÇ‡∏´‡∏•‡∏î Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
async function loadLogs() {
  const { data: logs, error } = await supabase
    .from("dnf_log")
    .select(`created_at, status, reason, runner_id, runner(name)`)
    .order("created_at", { ascending: false })
    .limit(20);

  logList.innerHTML = "";
  if (error) {
    console.error(error);
    logList.innerHTML = "<p class='text-red-500'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
    return;
  }

  if (!logs || logs.length === 0) {
    logList.innerHTML = "<p class='text-gray-500'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>";
    return;
  }

  logs.forEach(l => {
    const time = new Date(l.created_at).toLocaleString("th-TH");
    logList.innerHTML += `<div class="border-b py-1">
      üïê ${time} ‚Äî <b>${l.status}</b> (${l.reason || "-"})<br>
      üë§ Runner: ${l.runner?.name || l.runner_id}<br>
      üßë‚Äç‚öñÔ∏è ‡πÇ‡∏î‡∏¢: ${currentUser.name}
    </div>`;
  });
}

</script>
</body>
</html>
