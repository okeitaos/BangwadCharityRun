<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° | Bangwad Charity Run</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
  body {
    background: #0b1120;
    color: #fff;
    font-family: "Prompt", sans-serif;
  }

  /* Header */
  .bw-header {
    background: #1e293b;
    padding: 22px;
    text-align: center;
    border-bottom: 3px solid #334155;
  }

  /* Card ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏ö‡∏ö Bangwad */
  .bw-card {
    background: rgba(255,255,255,0.06);
    border-radius: 18px;
    padding: 20px;
    box-shadow: 0 0 25px rgba(0,0,0,0.35);
    backdrop-filter: blur(6px);
  }

  /* Input */
  .bw-input {
    background: rgba(255,255,255,0.12);
    border: none;
    border-radius: 10px;
    padding: 12px;
    width: 100%;
    color: white;
    margin-bottom: 10px;
    text-align: center;
  }

  /* ‡∏õ‡∏∏‡πà‡∏° Theme */
  .bw-btn-blue {
    background: #3b82f6;
    padding: 13px;
    border-radius: 10px;
    width: 100%;
    font-weight: bold;
    color: white;
    margin-top: 5px;
  }

  .bw-runner {
    background: rgba(255,255,255,0.08);
    padding: 18px;
    border-radius: 15px;
    border-left: 4px solid #38bdf8;
    color: #e2e8f0;
  }

  /* Animations */
  @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
  .toast {
    background:#333;
    padding:10px 16px;
    border-radius:10px;
    margin-top:6px;
    opacity:0;
    transform:translateY(20px);
    animation: fadeInUp .4s forwards;
  }
</style>
</head>

<body>

<!-- HEADER -->
<div class="bw-header">
  <h1 class="text-2xl font-bold text-yellow-300 tracking-wide">üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h1>
</div>

<div class="max-w-4xl mx-auto p-4 mt-6">

  <!-- LOGIN BOX -->
  <div id="login-section" class="bw-card max-w-md mx-auto">
    <h2 class="text-center text-xl text-yellow-300 font-semibold mb-3">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h2>

    <input id="email" type="email" class="bw-input" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
    <input id="password" type="password" class="bw-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">

    <button id="loginBtn" class="bw-btn-blue">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <!-- ADMIN SECTION -->
  <div id="admin-section" class="hidden">

    <!-- Top Bar -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-yellow-300">üëü ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
      <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded text-white">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- Search -->
    <div class="flex gap-3 flex-wrap mb-4">
      <input id="searchInput" type="text" class="bw-input flex-grow" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ / Tag ID / BIB">
      <button id="clearBtn" class="bg-gray-500 text-white px-4 py-2 rounded">‡∏•‡πâ‡∏≤‡∏á</button>
      <button id="showAllBtn" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="showRunningBtn" class="bg-green-600 text-white px-4 py-2 rounded">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ RUNNING</button>
    </div>

    <p id="lastUpdate" class="text-gray-400 text-sm mb-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</p>

    <div id="runnerList" class="space-y-3"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast-container" class="fixed bottom-4 right-4"></div>

<!-- Sounds -->
<audio id="alertDnf" preload="auto"
  src="https://cdn.jsdelivr.net/gh/napthedev/sounds@main/warning-beep.mp3"></audio>
<audio id="alertFinisher" preload="auto"
  src="https://cdn.jsdelivr.net/gh/napthedev/sounds@main/win.mp3"></audio>

<script>
/* =============================
   CONFIG
============================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/*  
==========================================================
‚ö†Ô∏è CODE ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‚Äî ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏ö 100% ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏ö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
==========================================================
*/

let currentUser = null;
let currentSearch = "";
let showOnlyRunning = false;
let searchTimeout = null;

const alertDnf = document.getElementById("alertDnf");
const alertFinisher = document.getElementById("alertFinisher");
const toastContainer = document.getElementById("toast-container");

window.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) autoLogin(session.user);

  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_IN" && session) autoLogin(session.user);
    if (event === "SIGNED_OUT") showLogin();
  });
});

async function autoLogin(user) {
  const { data: profile } = await supabase
    .from("adminrace")
    .select("is_admin, full_name")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile || !profile.is_admin) {
    await supabase.auth.signOut();
    return alert("‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  }

  currentUser = { id: user.id, name: profile.full_name };

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("admin-section").classList.remove("hidden");

  loadRunners(currentSearch);
  startRealtimeListener();

  document.getElementById("logoutBtn").onclick = async () => {
    await supabase.auth.signOut();
    showLogin();
  };

  document.getElementById("searchInput").addEventListener("input", () => {
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentSearch = document.getElementById("searchInput").value.trim();
      loadRunners(currentSearch);
    }, 400);
  });

  document.getElementById("clearBtn").onclick = () => {
    document.getElementById("searchInput").value = "";
    currentSearch = "";
    loadRunners();
  };

  document.getElementById("showAllBtn").onclick = () => { showOnlyRunning = false; loadRunners(); };
  document.getElementById("showRunningBtn").onclick = () => { showOnlyRunning = true; loadRunners(); };
}

async function loadRunners(query = "") {
  const runnerList = document.getElementById("runnerList");
  runnerList.innerHTML = `<p class='text-center text-gray-400'>‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>`;

  let queryBuilder = supabase.from("runner")
    .select("id,name,tag_id,bib,type,status")
    .order("name", { ascending: true });

  if (query)
    queryBuilder = queryBuilder.or(`name.ilike.%${query}%,tag_id.ilike.%${query}%,bib.ilike.%${query}%`);
  if (showOnlyRunning)
    queryBuilder = queryBuilder.eq("status", "RUNNING");

  const { data: runners } = await queryBuilder;

  runnerList.innerHTML = "";
  for (const r of runners) {

    const div = document.createElement("div");
    div.className = "bw-runner";
    div.id = `runner-${r.id}`;

    div.innerHTML = `
      <div>
        <b class="text-yellow-300">${r.name}</b> <span class="text-gray-300">(${r.type})</span><br>
        <span class="text-blue-300">BIB:</span> ${r.bib || "-"} |
        <span class="text-blue-300">Tag:</span> ${r.tag_id || "-"}<br>
        <span class="text-green-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> ${r.status}<br>
        <span class="text-gray-400 text-sm">üì° ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        <div class="mt-2" id="btn-${r.id}"></div>
      </div>
    `;

    runnerList.appendChild(div);

    // Load latest lap + reason
    const [{ data: recordData }, { data: logData }] = await Promise.all([
      supabase.from("record").select("lap").eq("runner_id", r.id),
      supabase.from("dnf_log").select("reason").eq("runner_id", r.id).order("created_at", { ascending: false }).limit(1)
    ]);

    const laps = recordData?.map(x => x.lap) || [];
    const maxLap = laps.length ? Math.max(...laps) : 0;
    const distance = (maxLap * 6.3).toFixed(2);
    const latestReason = logData?.[0]?.reason || "-";

    const span = div.querySelector("span.text-sm");
    span.outerHTML = `
      üèÅ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <b class="text-yellow-300">${maxLap}</b><br>
      üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${distance} ‡∏Å‡∏°.</b><br>
      üéΩ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span class="text-pink-300">${latestReason}</span>
    `;

    // Buttons
    const type = (r.type || "").replace(/\s+/g, "").toUpperCase();
    let finishLap = 0, dnfLap = 0;

    if (type.includes("50.4")) { finishLap = 8; dnfLap = 4; }
    if (type.includes("69.3")) { finishLap = 11; dnfLap = 6; }
    if (type.includes("100.8")) { finishLap = 16; dnfLap = 8; }

    const btn = document.getElementById(`btn-${r.id}`);
    if (r.status === "RUNNING") {
      if (maxLap >= finishLap) {
        btn.innerHTML = `<button class="bg-red-600 text-white px-4 py-2 rounded" onclick="confirmChange('${r.id}','FINISHER','${r.name}',${maxLap},'${r.type}')">FINISHER</button>`;
      } else {
        btn.innerHTML = `<button class="bg-yellow-500 text-white px-4 py-2 rounded" onclick="confirmChange('${r.id}','DNF','${r.name}',${maxLap},'${r.type}')">DNF</button>`;
      }
    } else {
      btn.innerHTML = `<span class="text-gray-400 text-sm">üö´ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`;
    }
  }

  document.getElementById("lastUpdate").textContent =
    "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString("th-TH");
}

async function confirmChange(runnerId, status, name, lap, type) {
  if (!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á "${name}" ‡πÄ‡∏õ‡πá‡∏ô ${status}?`)) return;

  let reason = "";
  if (status === "FINISHER") reason = "üèÅ ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠ Finisher";
  else reason = "üö´ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠";

  await supabase.from("runner").update({ status }).eq("id", runnerId);
  await supabase.from("dnf_log").insert({
    runner_id: runnerId,
    status,
    reason,
    updated_by: currentUser.id
  });

  showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡πÅ‡∏•‡πâ‡∏ß`);
  loadRunners(currentSearch);
}

function startRealtimeListener() {
  supabase.channel("record-changes")
    .on("postgres_changes", { event: "*", table: "record", schema: "public" }, payload => {
      const lap = payload.new?.lap;
      if (!lap) return;

      if ([4,6,8].includes(lap)) {
        alertDnf.play();
        showToast(`‚ö†Ô∏è ‡∏ñ‡∏∂‡∏á‡πÇ‡∏ã‡∏ô DNF (‡∏£‡∏≠‡∏ö ${lap})`);
      }

      if ([8,11,16].includes(lap)) {
        alertFinisher.play();
        showToast(`üèÜ Finisher (‡∏£‡∏≠‡∏ö ${lap})`);
      }

      loadRunners(currentSearch);
    })
    .subscribe();
}

function showToast(msg) {
  const el = document.createElement("div");
  el.className = "toast";
  el.textContent = msg;
  toastContainer.appendChild(el);

  setTimeout(() => {
    el.style.opacity = 0;
    setTimeout(() => el.remove(), 500);
  }, 3000);
}

function showLogin() {
  currentUser = null;
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("admin-section").classList.add("hidden");
}

document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({
    email, password
  });

  if (error) return alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  autoLogin(data.user);
};
</script>
</body>
</html>
