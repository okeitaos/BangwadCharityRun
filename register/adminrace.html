<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (Admin Panel)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  @keyframes blinkGold {
    0%, 100% { background-color: #d1fae5; }
    50% { background-color: #fef3c7; }
  }
  .blink-finisher { animation: blinkGold 2s infinite; }
  .tab-active { background-color: #2563eb; color: white; }
</style>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-5xl mx-auto bg-white rounded-lg shadow p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h1>

  <!-- üîê Login -->
  <div id="login-section">
    <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£" class="border p-2 w-full rounded mb-2">
    <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border p-2 w-full rounded mb-2">
    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <p id="loginStatus" class="text-center text-sm text-gray-600 mt-2"></p>
  </div>

  <!-- üßë‚Äç‚öñÔ∏è Admin Section -->
  <div id="admin-section" class="hidden">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
      <div class="space-x-2">
        <button id="refreshBtn" class="bg-blue-500 text-white px-3 py-1 rounded">üîÑ Refresh</button>
        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-4">
      <button id="tab-runners" class="tab-active px-3 py-1 rounded border">üèÉ‚Äç‚ôÇÔ∏è ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</button>
      <button id="tab-logs" class="px-3 py-1 rounded border">üßæ Logs</button>
      <button id="tab-ultra" class="px-3 py-1 rounded border">üèÖ Ultra Records</button>
    </div>

    <p id="lastUpdate" class="text-xs text-gray-500 mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</p>

    <!-- Sections -->
    <div id="section-runners">
      <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border p-2 w-full rounded mb-4">
      <div id="runnerList" class="space-y-3"></div>
    </div>

    <div id="section-logs" class="hidden">
      <div id="logList" class="space-y-1 text-sm text-gray-700"></div>
    </div>

    <div id="section-ultra" class="hidden">
      <div id="ultraList" class="space-y-1 text-sm text-gray-700"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üëà ‡πÉ‡∏™‡πà anon key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let autoRefreshInterval = null;

// Elements
const loginSection = document.getElementById("login-section");
const adminSection = document.getElementById("admin-section");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const refreshBtn = document.getElementById("refreshBtn");
const lastUpdate = document.getElementById("lastUpdate");
const searchInput = document.getElementById("searchInput");
const runnerList = document.getElementById("runnerList");
const logList = document.getElementById("logList");
const ultraList = document.getElementById("ultraList");
const tabRunners = document.getElementById("tab-runners");
const tabLogs = document.getElementById("tab-logs");
const tabUltra = document.getElementById("tab-ultra");
const sectionRunners = document.getElementById("section-runners");
const sectionLogs = document.getElementById("section-logs");
const sectionUltra = document.getElementById("section-ultra");

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
window.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) autoLogin(session.user);

  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_IN" && session) autoLogin(session.user);
    if (event === "SIGNED_OUT") showLogin();
  });
});

async function autoLogin(user) {
  const { data: profile } = await supabase
    .from("adminrace")
    .select("is_admin, full_name")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile || !profile.is_admin) {
    await supabase.auth.signOut();
    return alert("‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  }

  currentUser = { id: user.id, name: profile.full_name };
  loginSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
  startAutoRefresh();
}

function showLogin() {
  currentUser = null;
  loginSection.classList.remove("hidden");
  adminSection.classList.add("hidden");
  clearInterval(autoRefreshInterval);
}

// Tabs
function showTab(tab) {
  [tabRunners, tabLogs, tabUltra].forEach(t => t.classList.remove("tab-active"));
  [sectionRunners, sectionLogs, sectionUltra].forEach(s => s.classList.add("hidden"));
  if (tab === "runners") { tabRunners.classList.add("tab-active"); sectionRunners.classList.remove("hidden"); }
  if (tab === "logs") { tabLogs.classList.add("tab-active"); sectionLogs.classList.remove("hidden"); }
  if (tab === "ultra") { tabUltra.classList.add("tab-active"); sectionUltra.classList.remove("hidden"); }
}
tabRunners.onclick = () => showTab("runners");
tabLogs.onclick = () => showTab("logs");
tabUltra.onclick = () => showTab("ultra");

loginBtn.onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert("‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  autoLogin(data.user);
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  showLogin();
};

refreshBtn.onclick = () => loadAll();

function startAutoRefresh() {
  loadAll();
  autoRefreshInterval = setInterval(loadAll, 10000);
}
function updateLastTime() {
  lastUpdate.textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString("th-TH");
}
async function loadAll() {
  loadRunners(searchInput.value);
  loadLogs();
  loadUltra();
  updateLastTime();
}

// ===================== Runners =====================
async function loadRunners(query = "") {
  const { data: runners } = await supabase
    .from("runner")
    .select("id, name, type, status, record(lap)")
    .ilike("name", `%${query}%`)
    .order("name", { ascending: true });

  runnerList.innerHTML = "";
  runners.forEach(r => {
    const maxLap = r.record.length > 0 ? Math.max(...r.record.map(x => x.lap)) : 0;
    const distance = (maxLap * 6.3).toFixed(2);

    // ‚úÖ Normalize type
    const runnerType = (r.type || "").trim().toUpperCase();

    // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö Finisher / DNF ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô
    let finisherRequired = 0, dnfStart = 0;
    if (runnerType === "BCR 50.4") { finisherRequired = 8; dnfStart = 4; }
    else if (runnerType === "BCR 69.3") { finisherRequired = 11; dnfStart = 6; }
    else if (runnerType === "BCR 100.8") { finisherRequired = 16; dnfStart = 8; }

    // ‚úÖ Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
    const hasStarted = maxLap > 0;
    const canFinish = hasStarted && finisherRequired > 0 && maxLap >= finisherRequired;
    const shouldWarnDNF = hasStarted && dnfStart > 0 && maxLap >= dnfStart && r.status === "RUNNING";

    let buttons = "";
    if (r.status === "DNF" || r.status === "FINISHER") {
      buttons = `<span class="text-gray-500 text-sm">üö´ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`;
    } else if (canFinish) {
      buttons = `<button class="bg-red-500 text-white px-2 py-1 rounded"
        onclick="updateStatus('${r.id}', 'FINISHER', event)">FINISHER</button>`;
    } else if (hasStarted) {
      buttons = `<button class="bg-yellow-500 text-white px-2 py-1 rounded"
        onclick="updateStatus('${r.id}', 'DNF', event)">DNF</button>`;
    } else {
      buttons = `<span class="text-gray-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á</span>`;
    }

    let bgClass = "bg-green-50";
    if (shouldWarnDNF && !canFinish) bgClass = "bg-yellow-50";
    if (canFinish && r.status === "RUNNING") bgClass = "blink-finisher";
    if (r.status === "DNF" || r.status === "FINISHER") bgClass = "bg-red-50";

    const finisherNotice = hasStarted && canFinish && r.status === "RUNNING"
      ? `<div class="text-green-700 text-xs mt-1 font-medium">üéñÔ∏è FINISHER - ‡∏Ñ‡∏£‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>` : "";
    const dnfWarning = hasStarted && shouldWarnDNF && !canFinish
      ? `<div class="text-yellow-700 text-xs mt-1 font-medium">‚ö†Ô∏è ‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞ DNF ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>` : "";

    runnerList.innerHTML += `
      <div class="border p-3 rounded flex justify-between items-center ${bgClass}">
        <div>
          <b>${r.name}</b> (${r.type})<br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r.status}<br>
          üèÅ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: ${maxLap} | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°.
          ${dnfWarning}${finisherNotice}
        </div>
        <div>${buttons}</div>
      </div>`;
  });
}

// Update Runner Status
async function updateStatus(runnerId, status) {
  const reason = prompt(status === "DNF" ? "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• DNF:" : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô FINISHER:", "‡∏Ñ‡∏£‡∏ö‡∏£‡∏∞‡∏¢‡∏∞ / ‡πÄ‡∏à‡πá‡∏ö / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ");
  if (!reason) return;

  const { error: updateError } = await supabase
    .from("runner")
    .update({ status })
    .eq("id", runnerId);
  if (updateError) return alert("‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

  await supabase.from("dnf_log").insert({
    runner_id: runnerId,
    status,
    reason,
    updated_by: currentUser.id
  });

  alert(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadRunners(searchInput.value);
}

// ===================== Logs =====================
async function loadLogs() {
  const { data: logs } = await supabase
    .from("dnf_log")
    .select("created_at, status, reason, dnf_log_runner_fk(name)")
    .order("created_at", { ascending: false })
    .limit(20);

  logList.innerHTML = logs.map(l => `
    <div class="border-b py-1">
      üïê ${new Date(l.created_at).toLocaleString("th-TH")} ‚Äî <b>${l.status}</b> (${l.reason})<br>
      üë§ ${l.dnf_log_runner_fk?.name || "-"}
    </div>`).join("");
}

// ===================== Ultra Records =====================
async function loadUltra() {
  const { data: ultra, error } = await supabase
    .from("ultra_log")
    .select("name, type, lap, recorded_at")
    .eq("type", "BCR 100.8")
    .order("recorded_at", { ascending: false })
    .limit(50);

  if (error) {
    console.error("Error loading ultra_log:", error);
    return;
  }

  if (!ultra || ultra.length === 0) {
    ultraList.innerHTML = `<div class="text-center text-gray-500">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏∏‡πà‡∏ô 100.8 ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‚Äî</div>`;
    return;
  }

  ultraList.innerHTML = ultra.map(u => {
    const distance = (u.lap * 6.3).toFixed(2);
    return `
      <div class="border-b py-2">
        üèÖ <b>${u.name}</b> (${u.type})<br>
        ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: ${u.lap} | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: ${distance} ‡∏Å‡∏°.<br>
        üïí ${new Date(u.recorded_at).toLocaleString("th-TH")}
      </div>
    `;
  }).join("");
}
</script>
</body>
</html>
