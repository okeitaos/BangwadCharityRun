<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (Admin Panel)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  /* ‚ú® ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ä‡πâ‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö FINISHER */
  @keyframes blinkGold {
    0%, 100% { background-color: #d1fae5; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏≠‡∏á */
    50% { background-color: #fef3c7; } /* ‡∏ó‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  }
  .blink-finisher {
    animation: blinkGold 2s infinite;
  }
</style>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">üèÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h1>

    <!-- üîê ‡∏™‡πà‡∏ß‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
    <div id="login-section">
      <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£" class="border p-2 w-full rounded mb-2">
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border p-2 w-full rounded mb-2">
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p id="loginStatus" class="text-center text-sm text-gray-600 mt-2"></p>
    </div>

    <!-- üßë‚Äç‚öñÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á -->
    <div id="admin-section" class="hidden">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
        <div class="space-x-2">
          <button id="refreshBtn" class="bg-blue-500 text-white px-3 py-1 rounded">üîÑ Refresh</button>
          <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
      <p id="lastUpdate" class="text-xs text-gray-500 mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</p>

      <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="border p-2 w-full rounded mb-4">
      <div id="runnerList" class="space-y-3"></div>

      <hr class="my-6">
      <h2 class="text-lg font-semibold mb-2">üßæ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (DNF / FINISHER)</h2>
      <div id="logList" class="space-y-1 text-sm text-gray-700"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const loginSection = document.getElementById("login-section");
const adminSection = document.getElementById("admin-section");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const refreshBtn = document.getElementById("refreshBtn");
const lastUpdate = document.getElementById("lastUpdate");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginStatus = document.getElementById("loginStatus");
const searchInput = document.getElementById("searchInput");
const runnerList = document.getElementById("runnerList");
const logList = document.getElementById("logList");

let currentUser = null;
let autoRefreshInterval = null;

// üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
loginBtn.addEventListener("click", async () => {
  loginStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput.value,
    password: passwordInput.value
  });

  if (error) {
    loginStatus.textContent = "‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    return;
  }

  const user = data.user;
  const { data: profile } = await supabase
    .from("adminrace")
    .select("is_admin, full_name")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile || !profile.is_admin) {
    await supabase.auth.signOut();
    loginStatus.textContent = "‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    return;
  }

  currentUser = { id: user.id, name: profile.full_name || user.email };
  loginSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
  startAutoRefresh();
});

// üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
logoutBtn.addEventListener("click", async () => {
  clearInterval(autoRefreshInterval);
  await supabase.auth.signOut();
  currentUser = null;
  loginSection.classList.remove("hidden");
  adminSection.classList.add("hidden");
});

// üîÑ ‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
refreshBtn.addEventListener("click", () => {
  loadRunners(searchInput.value);
  loadLogs();
});

// üïí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
function startAutoRefresh() {
  loadRunners();
  loadLogs();
  updateLastTime();
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    loadRunners(searchInput.value);
    loadLogs();
    updateLastTime();
  }, 10000);
}

// üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
function updateLastTime() {
  const now = new Date().toLocaleTimeString("th-TH");
  lastUpdate.textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + now;
}

// üìã ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á
async function loadRunners(query = "") {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id, name, type, status, record(lap)")
    .ilike("name", `%${query}%`)
    .order("name", { ascending: true });

  if (error) return console.error(error);
  runnerList.innerHTML = "";

  runners.forEach(r => {
    const isDNF = r.status === "DNF";
    const isFinisher = r.status === "FINISHER";
    const maxLap = r.record && r.record.length > 0
      ? Math.max(...r.record.map(x => x.lap))
      : 0;
    const distance = (maxLap * 6.3).toFixed(2);

    let finisherRequired = 0, dnfStart = 0;
    if (r.type === "BCR 50.4") { finisherRequired = 8; dnfStart = 4; }
    else if (r.type === "BCR 69.3") { finisherRequired = 11; dnfStart = 6; }
    else if (r.type === "BCR 100.8") { finisherRequired = 16; dnfStart = 8; }

    const canFinish = maxLap >= finisherRequired;
    const shouldWarnDNF = maxLap >= dnfStart && !isDNF && !isFinisher;

    const finisherBtn = canFinish
      ? `<button class="bg-red-500 text-white px-2 py-1 rounded"
          onclick="updateStatus('${r.id}', 'FINISHER', event)">FINISHER</button>`
      : "";
    const dnfBtn = !canFinish
      ? `<button class="bg-yellow-500 text-white px-2 py-1 rounded"
          onclick="updateStatus('${r.id}', 'DNF', event)">DNF</button>`
      : "";

    let buttons = "";
    if (isDNF || isFinisher) {
      buttons = `<span class='text-gray-400'>üö´ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`;
    } else {
      buttons = `${dnfBtn} ${finisherBtn}`;
    }

    let bgClass = "bg-green-50";
    if (shouldWarnDNF) bgClass = "bg-yellow-50";
    if (canFinish && !isFinisher) bgClass = "blink-finisher";
    if (isDNF || isFinisher) bgClass = "bg-red-50";

    const statusColor =
      r.status === "DNF"
        ? "text-yellow-700"
        : r.status === "FINISHER"
        ? "text-red-700"
        : "text-green-700";

    const dnfWarning = shouldWarnDNF && !canFinish
      ? `<div class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è ‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞ DNF ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>`
      : "";
    const finisherNotice = canFinish && !isFinisher
      ? `<div class="text-xs text-green-700 mt-1 font-medium">üéñÔ∏è FINISHER - ‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`
      : "";

    runnerList.innerHTML += `
      <div class="border p-3 rounded flex justify-between items-center ${bgClass}">
        <div>
          <b>${r.name}</b> (${r.type})<br>
          <span class="text-sm ${statusColor}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r.status}</span><br>
          <span class="text-sm text-gray-600">üèÅ ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: ${maxLap} | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distance} ‡∏Å‡∏°.</span>
          ${dnfWarning}
          ${finisherNotice}
        </div>
        <div class="space-x-1">${buttons}</div>
      </div>
    `;
  });
}

// ‚úèÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
async function updateStatus(runnerId, status, event) {
  const { data: runner } = await supabase
    .from("runner")
    .select("status")
    .eq("id", runnerId)
    .maybeSingle();

  if (runner && (runner.status === "DNF" || runner.status === "FINISHER")) {
    alert("‚õî ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  const reason = prompt(
    "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:",
    status === "DNF" ? "‡πÄ‡∏à‡πá‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô" : "‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö"
  );
  if (!reason) return;

  const { error: updateError } = await supabase
    .from("runner")
    .update({ status })
    .eq("id", runnerId);
  if (updateError) {
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: " + updateError.message);
    return;
  }

  await supabase.from("dnf_log").insert({
    runner_id: runnerId,
    status,
    reason,
    updated_by: currentUser.id
  });

  alert(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  loadRunners(searchInput.value);
  loadLogs();
}

// üßæ ‡πÇ‡∏´‡∏•‡∏î Log
async function loadLogs() {
  const { data: logs } = await supabase
    .from("dnf_log")
    .select(`created_at, status, reason, dnf_log_runner_fk(name)`)
    .order("created_at", { ascending: false })
    .limit(20);

  logList.innerHTML = logs.map(l => {
    const time = new Date(l.created_at).toLocaleString("th-TH");
    const name = l.dnf_log_runner_fk?.name || "-";
    return `<div class="border-b py-1">
      üïê ${time} ‚Äî <b>${l.status}</b> (${l.reason})<br>
      üë§ Runner: ${name}<br>
      üßë‚Äç‚öñÔ∏è ‡πÇ‡∏î‡∏¢: ${currentUser.name}
    </div>`;
  }).join("");
}
</script>
</body>
</html>
