<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Check-in Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0f172a;
    color: #fff;
    padding: 20px;
    text-align: center;
  }
  h1 { color: #facc15; }
  #reader { width: 320px; margin: 20px auto; }
  .card {
    background: rgba(255,255,255,0.08);
    padding: 20px;
    border-radius: 15px;
    max-width: 420px;
    margin: 20px auto;
    text-align: left;
  }
  .label { color:#facc15; font-weight:bold; }
  button {
    width: 100%; padding: 14px; border-radius: 10px;
    border: none; margin-top: 15px; cursor:pointer;
    font-size: 1.1rem; font-weight:bold;
    background:#22c55e; color:white;
  }
  button:disabled {
    background:#475569;
    cursor:not-allowed;
  }
</style>
</head>

<body>

<h1 id="title">üì∑ Staff Check-in</h1>

<button onclick="setLang('th')">‡πÑ‡∏ó‡∏¢</button>
<button onclick="setLang('en')">English</button>

<div id="reader"></div>

<h2 id="scanText" style="margin-top:10px;">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>

<div id="result"></div>

<script>
/* =============================
   CONFIG
============================= */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =============================
   MULTI LANGUAGE
============================= */
let lang = "th";

const text = {
  th:{
    title:"üì∑ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà",
    scan:"‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
    bib:"‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß",
    name:"‡∏ä‡∏∑‡πà‡∏≠",
    phone:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
    category:"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    status:"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô",
    checked:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
    notchecked:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô",
    btn:"‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô",
    success:"‚úî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
  },
  en:{
    title:"üì∑ Staff Check-in System",
    scan:"Scan runner QR",
    bib:"BIB Number",
    name:"Name",
    phone:"Phone",
    category:"Category",
    status:"Check-in Status",
    checked:"Checked-in",
    notchecked:"Not Checked-in",
    btn:"Confirm Check-in",
    success:"‚úî Check-in Success"
  }
};

function setLang(l){
  lang = l;
  document.getElementById("title").innerText = text[l].title;
  document.getElementById("scanText").innerText = text[l].scan;
}

/* =============================
   QR SCANNER
============================= */
function startScanner(){
  const scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    async function(decodedText) {
      console.log("QR:", decodedText);

      // Expecting ?bib=TOP001
      const bib = decodedText.split("bib=")[1];
      if (bib) {
        scanner.stop();
        loadRunner(bib);
      }
    },
    function(error){ /* ignore scan errors */ }
  );
}

/* =============================
   LOAD RUNNER DATA
============================= */
async function loadRunner(bib){
  document.getElementById("result").innerHTML =
    `<p style='color:#facc15'>‚è≥ Loading...</p>`;

  const bibNumber = parseInt(bib.replace("TOP",""));

  // load all rows sorted by id
  const { data: allRows } = await sb
    .from("bangwad")
    .select("id")
    .order("id");

  const row = allRows[bibNumber - 1];

  if (!row){
    document.getElementById("result").innerHTML =
      `<p style="color:#ef4444">‚ùå BIB ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>`;
    startScanner();
    return;
  }

  const { data } = await sb
    .from("bangwad")
    .select("*")
    .eq("id", row.id)
    .single();

  renderCard(data, bib);
}

/* =============================
   RENDER CARD
============================= */
function renderCard(data, bib){
  const checked = data.checkin_status === "checked";

  document.getElementById("result").innerHTML = `
    <div class="card">
      <p><span class="label">${text[lang].bib}:</span> ${bib}</p>
      <p><span class="label">${text[lang].name}:</span> ${data.first_name} ${data.last_name}</p>
      <p><span class="label">${text[lang].phone}:</span> ${data.phone}</p>
      <p><span class="label">${text[lang].category}:</span> ${data.category}</p>

      <p><span class="label">${text[lang].status}:</span>
        ${checked ? text[lang].checked : text[lang].notchecked}
      </p>

      <button 
        id="btnCheck"
        onclick="doCheckIn(${data.id})"
        ${checked ? "disabled" : ""}>
        ${text[lang].btn}
      </button>
    </div>

    <button onclick="location.reload()" 
      style="margin-top:15px;background:#3b82f6">
      üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
    </button>
  `;
}

/* =============================
   CHECK-IN
============================= */
async function doCheckIn(id){
  await sb
    .from("bangwad")
    .update({
      checkin_status:"checked",
      checkin_time: new Date().toISOString()
    })
    .eq("id", id);

  document.getElementById("btnCheck").innerText = text[lang].success;
  document.getElementById("btnCheck").disabled = true;
}

setLang("th");
startScanner();
</script>

</body>
</html>
