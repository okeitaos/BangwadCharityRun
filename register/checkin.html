<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STAFF CHECK-IN | Bangwad Charity Run</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: #0b1120;
    color: #fff;
    margin: 0;
    padding: 0;
  }

  header {
    background: #1e293b;
    padding: 20px;
    text-align: center;
    border-bottom: 2px solid #334155;
  }

  header h1 {
    margin: 0;
    color: #facc15;
    font-size: 1.9rem;
    letter-spacing: 1px;
  }

  .lang-box {
    margin-top: 10px;
  }
  .lang-box button {
    background:#334155;
    padding:7px 16px;
    border-radius: 8px;
    border:none;
    margin:4px;
    color:#fff;
    cursor:pointer;
  }

  #scanBox {
    text-align: center;
    padding: 20px;
  }

  #reader {
    width: 90%;
    max-width: 320px;
    margin: auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(250,204,21,0.3);
  }

  #scanText {
    margin-top: 15px;
    font-size: 1.1rem;
    color: #facc15;
  }

  .card {
    background: rgba(255,255,255,0.08);
    padding: 20px;
    border-radius: 20px;
    max-width: 450px;
    margin: 20px auto;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
    animation: fadeIn 0.4s;
  }

  .label { font-weight: bold; color: #38bdf8; }
  .value { font-size: 1.1rem; }

  .status-chip {
    display:inline-block;
    padding:6px 12px;
    border-radius:12px;
    margin-left:5px;
    font-weight:bold;
  }
  .checked { background:#22c55e; color:#fff; }
  .notchecked { background:#ef4444; color:#fff; }

  .btn-checkin {
    width:100%;
    padding:15px;
    border-radius:12px;
    font-size:1.3rem;
    border:none;
    cursor:pointer;
    margin-top:15px;
    background:#22c55e;
    color:white;
  }
  .btn-checkin:disabled { background:#475569; }

  .btn-reset {
    background:#3b82f6;
    padding:12px 20px;
    border-radius:10px;
    border:none;
    font-size:1rem;
    color:white;
    margin-top:8px;
    cursor:pointer;
  }

  @keyframes fadeIn {
    from { opacity:0; transform:translateY(10px); }
    to { opacity:1; transform:translateY(0); }
  }

  /* LOGIN BOX */
  #loginBox {
    max-width: 360px;
    margin: 60px auto;
    background: rgba(255,255,255,0.07);
    padding: 25px;
    border-radius: 15px;
    text-align: center;
  }
  #loginBox input {
    width: 90%;
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
    border: none;
    background: rgba(255,255,255,0.12);
    color: #fff;
    text-align: center;
  }
  #loginBox button {
    background:#3b82f6;
    padding:12px 20px;
    border:none;
    color:white;
    border-radius:10px;
    margin-top:15px;
    cursor:pointer;
    width: 100%;
  }
</style>
</head>

<body>

<header>
  <h1 id="title">üì∑ STAFF CHECK-IN</h1>
  <div class="lang-box">
    <button onclick="setLang('th')">‡πÑ‡∏ó‡∏¢</button>
    <button onclick="setLang('en')">English</button>
  </div>
</header>

<!-- LOGIN BOX -->
<div id="loginBox" style="display:none;">
  <h2>üîê STAFF LOGIN</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  <p id="loginMsg" style="margin-top:10px;color:#f87171;"></p>
</div>

<!-- SCAN BOX -->
<div id="scanBox" style="display:none;">
  <div id="reader"></div>
  <div id="scanText">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
</div>

<div id="result"></div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =============================
   SECURE LOGIN SYSTEM
============================= */
async function waitAuth() {
  return new Promise(resolve => {
    setTimeout(resolve, 100);
  });
}

async function checkAdmin() {
  await waitAuth();

  const { data: sessionData } = await sb.auth.getSession();
  const session = sessionData.session;

  if (!session) {
    document.getElementById("loginBox").style.display = "block";
    return;
  }

  const uid = session.user.id;

  const { data: admin } = await sb
    .from("adminrace")
    .select("*")
    .eq("id", uid)
    .maybeSingle();

  if (!admin || admin.is_admin !== true) {
    document.getElementById("loginMsg").innerHTML =
      "‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ";
    document.getElementById("loginBox").style.display = "block";
    return;
  }

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("scanBox").style.display = "block";

  startScanner();
}

async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("loginMsg");

  const { error } = await sb.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    msg.innerText = "‚ùå " + error.message;
    return;
  }

  location.reload();
}

sb.auth.onAuthStateChange((event) => {
  if (event === "SIGNED_IN") location.reload();
});

/* =============================
   LANGUAGE
============================= */
let lang = "th";
const text = {
  th:{ title:"üì∑ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", scan:"‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
    bib:"‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß", name:"‡∏ä‡∏∑‡πà‡∏≠", phone:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", category:"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    status:"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô", checked:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß", notchecked:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô",
    btn:"‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô", success:"‚úî ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" },
  en:{ title:"üì∑ Staff Check-in System", scan:"Scan QR Code",
    bib:"BIB Number", name:"Name", phone:"Phone", category:"Category",
    status:"Check-in Status", checked:"Checked-in", notchecked:"Not checked-in",
    btn:"Confirm Check-in", success:"‚úî Check-in Success" }
};

function setLang(l){
  lang = l;
  document.getElementById("title").innerText = text[l].title;
  document.getElementById("scanText").innerText = text[l].scan;
}

/* =============================
   QR SCANNER (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
============================= */
function startScanner(){
  const scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    decoded => {
      if(decoded.includes("bib=")){
        scanner.stop();
        const bib = decoded.split("bib=")[1];
        loadRunner(bib);
      }
    },
    err => {}
  );
}

async function loadRunner(bib){
  document.getElementById("result").innerHTML =
    `<p style='color:#facc15'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;

  const bibNum = parseInt(bib.replace("TOP",""));

  const { data: allRows } = await sb
    .from("bangwad")
    .select("id")
    .order("id");

  const row = allRows[bibNum - 1];
  if(!row){
    document.getElementById("result").innerHTML =
      `<p style="color:#ef4444">BIB ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>`;
    return;
  }

  const { data } = await sb
    .from("bangwad")
    .select("*")
    .eq("id", row.id)
    .single();

  renderCard(data, bib);
}

function renderCard(d, bib){
  const isApproved = d.status && d.status.toLowerCase() === "approved";
  const checked = d.checkin_status === "checked";

  if (!isApproved) {
    document.getElementById("result").innerHTML = `
      <div class="card">
        <p><span class="label">${text[lang].bib}:</span> ${bib}</p>
        <p><span class="label">${text[lang].name}:</span> ${d.first_name} ${d.last_name}</p>
        <p><span class="label">${text[lang].phone}:</span> ${d.phone}</p>
        <p><span class="label">${text[lang].category}:</span> ${d.category}</p>

        <p style="text-align:center;color:#ef4444;font-weight:bold;margin-top:25px;">
          ${lang==="th" ?
            "‚ùå ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ" :
            "‚ùå This participant is not approved<br>Check-in is not allowed"}
        </p>
      </div>

      <button class="btn-reset" onclick="location.reload()">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
    `;
    return;
  }

  document.getElementById("result").innerHTML = `
    <div class="card">
      <p><span class="label">${text[lang].bib}:</span> <span class="value">${bib}</span></p>
      <p><span class="label">${text[lang].name}:</span> ${d.first_name} ${d.last_name}</p>
      <p><span class="label">${text[lang].phone}:</span> ${d.phone}</p>
      <p><span class="label">${text[lang].category}:</span> ${d.category}</p>

      <p><span class="label">${text[lang].status}:</span>
        <span class="status-chip ${checked?'checked':'notchecked'}">
          ${checked ? text[lang].checked : text[lang].notchecked}
        </span>
      </p>

      <button class="btn-checkin"
        id="btnCheck"
        onclick="doCheckIn(${d.id})"
        ${checked ? "disabled" : ""}>
        ${checked ? text[lang].success : text[lang].btn}
      </button>
    </div>

    <button class="btn-reset" onclick="location.reload()">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  `;
}

async function doCheckIn(id){
  await sb
    .from("bangwad")
    .update({
      checkin_status:"checked",
      checkin_time: new Date().toISOString()
    })
    .eq("id", id);

  const btn = document.getElementById("btnCheck");
  btn.innerText = text[lang].success;
  btn.disabled = true;
}

setLang("th");
checkAdmin();
</script>

</body>
</html>
