<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÉ‚Äç‚ôÇÔ∏è Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .rank-finisher { background-color: #d1fae5; }
  .rank-running { background-color: #fef9c3; }
  .rank-dnf { background-color: #fee2e2; }
  .active-tab { background-color: #2563eb !important; color: white !important; }
  .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 50; }
  .modal { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
  .modal h2 { font-size: 1.25rem; font-weight: 700; color: #1e293b; }
  .modal th, .modal td { padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; }
  .modal th { background-color: #f3f4f6; font-weight: 600; }
  @media (max-width: 640px) {
    th:nth-child(3), td:nth-child(3) { display: none; }
    th:nth-child(4), td:nth-child(4) { display: none; }
  }
</style>
</head>
<body class="bg-gray-100 p-4 sm:p-6">

<h1 class="text-2xl sm:text-3xl font-bold text-center mb-4">üìä RACE DASHBOARD</h1>

<!-- üîò ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
<div class="flex flex-wrap justify-center gap-2 mb-4">
  <button data-type="ALL" class="type-tab bg-gray-300 px-3 py-1 rounded active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 100.8</button>
</div>

<!-- üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
<div class="flex justify-center mb-4">
  <input id="searchInput" type="text" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ Tag ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded w-full max-w-md shadow-sm focus:ring-2 focus:ring-blue-400">
</div>

<!-- üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô -->
<div id="summary" class="text-center text-gray-700 font-semibold mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å -->
<div id="runner-list" class="max-w-5xl mx-auto bg-white p-4 rounded-lg shadow overflow-x-auto">
  <table class="w-full text-sm text-left border-collapse min-w-[600px]">
    <thead>
      <tr class="bg-gray-200 text-gray-700">
        <th class="p-2 text-center">üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- ü™ü Modal -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <h2 id="modalTitle"></h2>
    <p id="modalSummary" class="text-sm text-gray-700 mt-2 mb-4"></p>
    <table class="text-xs sm:text-sm">
      <thead>
        <tr>
          <th>üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th>üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th>üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</th>
          <th>‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="modalContent"></tbody>
    </table>
    <p id="avgTime" class="text-center text-sm text-gray-600 mt-3"></p>
    <button id="closeModal" class="bg-gray-700 text-white mt-4 px-4 py-2 rounded w-full">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üëà ‡πÉ‡∏™‡πà anon key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const summary = document.getElementById("summary");
const runnerTableBody = document.getElementById("runnerTableBody");
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalSummary = document.getElementById("modalSummary");
const modalContent = document.getElementById("modalContent");
const avgTime = document.getElementById("avgTime");
const closeModal = document.getElementById("closeModal");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");

let currentType = "ALL";
let currentSearch = "";

closeModal.onclick = () => modal.style.display = "none";

// üïí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô HH:MM:SS
function formatDuration(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id, name, tag_id, type, status, record(lap, start_time, finish_time)")
    .order("name", { ascending: true });
  if (error) return console.error(error);

  let filtered = runners;
  if (currentType !== "ALL") {
    filtered = filtered.filter(r => (r.type || "").replace(/\s+/g,"").toUpperCase().includes(currentType.replace(" ","").toUpperCase()));
  }
  if (currentSearch.trim() !== "") {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r =>
      (r.name || "").toLowerCase().includes(q) ||
      (r.tag_id || "").toLowerCase().includes(q)
    );
  }

  // üßÆ ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∏‡πà‡∏ô
  const total = filtered.length;
  const finisher = filtered.filter(r => r.status === "FINISHER").length;
  const dnf = filtered.filter(r => r.status === "DNF").length;
  const running = filtered.filter(r => r.status === "RUNNING").length;

  summary.innerHTML = `
    ‡∏£‡∏∏‡πà‡∏ô: <b>${currentType === "ALL" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : currentType}</b> |
    üëü ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${total}</b> ‡∏Ñ‡∏ô |
    üü¢ RUNNING: <b>${running}</b> |
    üèÅ FINISHER: <b>${finisher}</b> |
    ‚õî DNF: <b>${dnf}</b>
  `;

  const data = filtered.map(r => {
    let totalTime = 0, completedLaps = 0;
    (r.record || []).forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    const distance = (completedLaps * 6.3).toFixed(2);
    return { ...r, totalTime, completedLaps, distance };
  });

  const finished = data.filter(r => r.status === "FINISHER").sort((a,b) => a.totalTime - b.totalTime);
  const runningSorted = data.filter(r => r.status === "RUNNING").sort((a,b) => b.completedLaps - a.completedLaps);
  const dnfSorted = data.filter(r => r.status === "DNF").sort((a,b) => b.completedLaps - a.completedLaps);
  const all = [...finished, ...runningSorted, ...dnfSorted];

  updateTable(all);
}

// üèÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
function updateTable(runners) {
  runnerTableBody.innerHTML = "";
  runners.forEach((r, i) => {
    const rowClass = r.status === "FINISHER" ? "rank-finisher"
                   : r.status === "DNF" ? "rank-dnf" : "rank-running";
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";
    const row = document.createElement("tr");
    row.className = `${rowClass} border-b hover:bg-gray-100 cursor-pointer`;
    row.innerHTML = `
      <td class="p-2 text-center">${i + 1}</td>
      <td class="p-2 font-medium text-blue-700 hover:underline">${r.name}</td>
      <td class="p-2 text-center">${r.type}</td>
      <td class="p-2 text-center">${r.completedLaps}</td>
      <td class="p-2 text-center">${r.distance}</td>
      <td class="p-2 text-center">${totalTimeText}</td>
    `;
    row.addEventListener("click", () => showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

// ü™ü Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lap
function showDetails(runner) {
  modal.style.display = "flex";
  modalTitle.textContent = `${runner.name} (${runner.type})`;
  let totalDur = formatDuration(runner.totalTime || 0);
  modalSummary.innerHTML = `
    <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${runner.status} |
    <b>‡∏£‡∏≠‡∏ö:</b> ${runner.completedLaps} |
    <b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</b> ${runner.distance} ‡∏Å‡∏°.<br>
    <b>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°:</b> ${totalDur}
  `;

  if (!runner.record || runner.record.length === 0) {
    modalContent.innerHTML = `<tr><td colspan="4" class="text-center py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏ß‡∏¥‡πà‡∏á</td></tr>`;
    avgTime.textContent = "";
    return;
  }

  // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô Lap 0
  const laps = runner.record.filter(rec => rec.lap > 0).sort((a,b) => a.lap - b.lap);
  if (laps.length === 0) {
    modalContent.innerHTML = `<tr><td colspan="4" class="text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</td></tr>`;
    avgTime.textContent = "";
    return;
  }

  let totalLapTime = 0;
  let countLap = 0;

  modalContent.innerHTML = laps.map(rec => {
    const start = rec.start_time ? new Date(rec.start_time).toLocaleTimeString("th-TH") : "-";
    const finish = rec.finish_time ? new Date(rec.finish_time).toLocaleTimeString("th-TH") : "-";
    let dur = "-";
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      totalLapTime += diff;
      countLap++;
      dur = formatDuration(diff);
    }
    return `
      <tr>
        <td>${rec.lap}</td>
        <td>${start}</td>
        <td>${finish}</td>
        <td>${dur}</td>
      </tr>
    `;
  }).join("");

  // üßÆ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
  if (countLap > 0) {
    const avg = totalLapTime / countLap;
    avgTime.textContent = `‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatDuration(avg)} (‡∏à‡∏≤‡∏Å ${countLap} ‡∏£‡∏≠‡∏ö)`;
  } else {
    avgTime.textContent = "";
  }
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∏‡πà‡∏ô
typeTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    typeTabs.forEach(t => t.classList.remove("active-tab"));
    tab.classList.add("active-tab");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearch = searchInput.value.trim();
    loadDashboard();
  }, 400);
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
loadDashboard();
setInterval(loadDashboard, 15000);
supabase.channel("record-changes")
  .on("postgres_changes", { event: "*", schema: "public", table: "record" }, () => loadDashboard())
  .subscribe();
</script>
</body>
</html>
