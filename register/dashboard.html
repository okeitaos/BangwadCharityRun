<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üèÉ Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
  .rank-finisher { background-color: #d1fae5; }
  .rank-running { background-color: #fef9c3; }
  .rank-dnf { background-color: #fee2e2; }
  .active-tab { background-color: #2563eb !important; color: white !important; }
  .popup-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5);
     display: none; justify-content: center; align-items: center; z-index: 50; }
  .popup { background: white; padding: 20px; border-radius: 10px;
     width: 95%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<h1 class="text-3xl font-bold text-center mb-4">üìä DASHBOARD ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

<!-- Language selector -->
<div class="flex justify-center mb-4">
  <select id="langSelect" class="border p-2 rounded">
    <option value="TH">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
    <option value="EN">üá¨üáß English</option>
  </select>
</div>

<!-- Tabs -->
<div class="flex flex-wrap justify-center space-x-2 mb-4">
  <button data-type="ALL" class="type-tab bg-gray-300 px-3 py-1 rounded active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 100.8</button>
</div>

<!-- Search -->
<div class="flex justify-center mb-6">
  <input id="searchInput" type="text"
    placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠, Tag ID ‡∏´‡∏£‡∏∑‡∏≠ BIB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
    class="border p-2 rounded w-full max-w-md">
</div>

<!-- Table -->
<div class="max-w-5xl mx-auto bg-white p-4 rounded-lg shadow">
  <table class="w-full text-sm text-left border-collapse">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 text-center">üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
        <th class="p-2 text-center">BIB</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
        <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ -->
        <th class="p-2 text-center">üéΩ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- Popup -->
<div id="popup" class="popup-bg" role="dialog">
  <div class="popup">
    <h2 id="popupTitle" class="text-lg font-semibold mb-1"></h2>
    <div id="popupBib" class="text-sm text-gray-600 mb-2"></div>
    <div id="popupSummary" class="text-sm mb-3 text-gray-700"></div>

    <table class="w-full text-xs sm:text-sm mb-3 border">
      <thead>
        <tr class="bg-gray-100 text-gray-700">
          <th class="p-2 text-center">üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 text-center">‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th class="p-2 text-center">üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</th>
          <th class="p-2 text-center">‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="popupContent"></tbody>
    </table>

    <p id="avgTime" class="text-center text-sm text-gray-600 mb-4"></p>

    <button id="closePopup" class="bg-gray-700 text-white px-3 py-2 rounded w-full">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
/* ---------------- Supabase Init ---------------- */
const supabase = window.supabase.createClient(
  "https://xjdjurdflowiwdxgkvfr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

/* ---------------- Category Laps ---------------- */
const CATEGORY_LAPS = {
  "BCR 50.4": { full: 8, half: 4 },
  "BCR 69.3": { full: 11, half: 6 },
  "BCR 100.8": { full: 16, half: 8 }
};

/* ---------------- Shirt Status Functions ---------------- */
function getShirtStatus(type, laps) {
  const c = CATEGORY_LAPS[type];
  if (!c) return "-";
  if (laps >= c.full) return "‡πÄ‡∏™‡∏∑‡πâ‡∏≠ Finisher";
  if (laps >= c.half) return "‡πÄ‡∏™‡∏∑‡πâ‡∏≠ DNF";
  return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠";
}
function getShirtStatusEN(type, laps) {
  const c = CATEGORY_LAPS[type];
  if (!c) return "-";
  if (laps >= c.full) return "Finisher Shirt";
  if (laps >= c.half) return "DNF Shirt";
  return "No Shirt";
}

/* ---------------- Elements ---------------- */
const runnerTableBody = document.getElementById("runnerTableBody");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupBib = document.getElementById("popupBib");
const popupSummary = document.getElementById("popupSummary");
const popupContent = document.getElementById("popupContent");
const avgTime = document.getElementById("avgTime");
const closePopup = document.getElementById("closePopup");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");
const langSelect = document.getElementById("langSelect");

let currentType = "ALL";
let currentSearch = "";
let currentLang = "TH";

/* ---------------- Utilities ---------------- */
function formatThaiTime(timeString) {
  if (!timeString) return "-";
  timeString = timeString.replace("Z","").replace("+00:00","").trim();
  const [date, time] = timeString.split("T");
  if (!time) return timeString;
  const [h,m,s] = time.split(":");
  return `${h}:${m}:${(s||"00").split(".")[0]}`;
}
function formatDuration(ms) {
  const sec = Math.floor(ms/1000);
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

/* ---------------- Load Dashboard ---------------- */
async function loadDashboard() {
  const {data:runners} = await supabase
    .from("runner")
    .select("id,bib,name,tag_id,type,status,record(lap,start_time,finish_time)")
    .order("name",{ascending:true});

  let filtered = runners || [];
  if (currentType !== "ALL") filtered = filtered.filter(r => r.type === currentType);
  if (currentSearch.trim()) {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r =>
      (r.name?.toLowerCase()||"").includes(q) ||
      (r.tag_id||"").includes(q) ||
      (r.bib||"").includes(q)
    );
  }

  const data = filtered.map(r=>{
    let total=0, laps=0;
    (r.record||[]).forEach(rec=>{
      if(rec.start_time && rec.finish_time){
        total += new Date(rec.finish_time)-new Date(rec.start_time);
        laps++;
      }
    });
    return {
      ...r,
      completedLaps:laps,
      distance:(laps*6.3).toFixed(2),
      shirtTH:getShirtStatus(r.type,laps),
      shirtEN:getShirtStatusEN(r.type,laps),
      totalTime:total
    };
  });

  const fin = data.filter(r=>r.status==="FINISHER").sort((a,b)=>a.totalTime-b.totalTime);
  const run = data.filter(r=>r.status==="RUNNING").sort((a,b)=>b.completedLaps-a.completedLaps);
  const dnf = data.filter(r=>r.status==="DNF").sort((a,b)=>b.completedLaps-a.completedLaps);

  renderRunners([...fin,...run,...dnf]);
}

/* ---------------- Render Table ---------------- */
function renderRunners(list) {
  runnerTableBody.innerHTML = "";
  list.forEach((r,i)=>{
    const row = document.createElement("tr");
    row.className = (r.status==="FINISHER"?"rank-finisher":
                    r.status==="DNF"?"rank-dnf":"rank-running")
                    + " border-b hover:bg-gray-50 cursor-pointer";

    row.innerHTML = `
      <td class="p-2 text-center">${i+1}</td>
      <td class="p-2 text-center font-medium">${r.bib||"-"}</td>
      <td class="p-2 text-blue-700 font-medium">${r.name}</td>
      <td class="p-2 text-center">${r.type}</td>
      <td class="p-2 text-center">${r.completedLaps}</td>
      <td class="p-2 text-center">${r.distance}</td>
      <td class="p-2 text-center">${r.totalTime?formatDuration(r.totalTime):"-"}</td>
      <td class="p-2 text-center">${currentLang==="TH"?r.shirtTH:r.shirtEN}</td>
    `;

    row.addEventListener("click",()=>showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

/* ---------------- Popup ---------------- */
function showDetails(r) {
  popup.style.display="flex";
  popupTitle.textContent=`${r.name} (${r.type})`;
  popupBib.textContent=`BIB: ${r.bib||"-"}`;

  const shirtText = currentLang==="TH" ? r.shirtTH : r.shirtEN;

  popupSummary.innerHTML = `
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${r.status}</b> |
    ‡∏£‡∏≠‡∏ö: <b>${r.completedLaps}</b> |
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${r.distance} ‡∏Å‡∏°.</b> |
    üéΩ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠: <b>${shirtText}</b>
  `;

  const laps = (r.record||[]).sort((a,b)=>a.lap-b.lap);

  popupContent.innerHTML="";
  let total=0, count=0;

  laps.forEach(rec=>{
    let lapTime="-";
    if(rec.start_time && rec.finish_time){
      lapTime = new Date(rec.finish_time)-new Date(rec.start_time);
      total += lapTime;
      count++;
      lapTime = formatDuration(lapTime);
    }

    popupContent.innerHTML += `
      <tr class="border-t">
        <td class="p-2 text-center">${rec.lap+1}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.start_time)}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.finish_time)}</td>
        <td class="p-2 text-center">${lapTime}</td>
      </tr>`;
  });

  avgTime.textContent = count?`‚è± ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatDuration(total/count)}`:"";
}

closePopup.onclick = ()=>popup.style.display="none";

/* ---------------- Tabs ---------------- */
typeTabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    typeTabs.forEach(t=>t.classList.remove("active-tab"));
    tab.classList.add("active-tab");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

/* ---------------- Search ---------------- */
let TO=null;
searchInput.addEventListener("input",()=>{
  clearTimeout(TO);
  TO=setTimeout(()=>{
    currentSearch=searchInput.value.trim();
    loadDashboard();
  },300);
});

/* ---------------- Live Update ---------------- */
loadDashboard();
supabase.channel("record-realtime")
  .on("postgres_changes",{event:"*",schema:"public",table:"record"},()=>loadDashboard())
  .subscribe();

setInterval(loadDashboard,15000);

/* ---------------- Translations ---------------- */
const translations = {
  TH:{ col_shirt:"üéΩ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠" },
  EN:{ col_shirt:"üéΩ Shirt" }
};

langSelect.addEventListener("change",()=>{
  currentLang=langSelect.value;
  loadDashboard();
});
</script>

</body>
</html>
