<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üèÉ Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .rank-finisher { background-color: #d1fae5; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  .rank-running { background-color: #fef9c3; }  /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  .rank-dnf { background-color: #fee2e2; }      /* ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  .active-tab { background-color: #2563eb !important; color: white !important; }
  .popup-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; }
  .popup { background: white; padding: 20px; border-radius: 10px; width: 95%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
  @keyframes blinkSlow {
    0%,100% { background-color: inherit; }
    50% { background-color: rgba(253,230,138,0.5); }
  }
  .blink-slow { animation: blinkSlow 2.5s infinite; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<h1 class="text-3xl font-bold text-center mb-4">üìä DASHBOARD ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

<!-- Tabs -->
<div class="flex flex-wrap justify-center space-x-2 mb-4">
  <button data-type="ALL" class="type-tab bg-gray-300 px-3 py-1 rounded active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 100.8</button>
</div>

<!-- Search -->
<div class="flex justify-center mb-6">
  <input id="searchInput" type="text" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠, Tag ID ‡∏´‡∏£‡∏∑‡∏≠ BIB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded w-full max-w-md">
</div>

<!-- Table -->
<div id="runner-list" class="max-w-5xl mx-auto bg-white p-4 rounded-lg shadow">
  <table class="w-full text-sm text-left border-collapse">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 text-center">üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
        <th class="p-2 text-center">BIB</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- Popup -->
<div id="popup" class="popup-bg" role="dialog" aria-modal="true">
  <div class="popup">
    <h2 id="popupTitle" class="text-lg font-semibold mb-1"></h2>
    <div id="popupBib" class="text-sm text-gray-600 mb-2"></div>
    <div id="popupSummary" class="text-sm mb-3 text-gray-700"></div>
    <table class="w-full text-xs sm:text-sm mb-3 border">
      <thead>
        <tr class="bg-gray-100 text-gray-700">
          <th class="p-2 text-center">üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 text-center">‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th class="p-2 text-center">üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</th>
          <th class="p-2 text-center">‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="popupContent"></tbody>
    </table>
    <p id="avgTime" class="text-center text-sm text-gray-600 mb-4"></p>
    <button id="closePopup" class="bg-gray-700 text-white px-3 py-2 rounded w-full">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const runnerTableBody = document.getElementById("runnerTableBody");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupBib = document.getElementById("popupBib");
const popupSummary = document.getElementById("popupSummary");
const popupContent = document.getElementById("popupContent");
const avgTime = document.getElementById("avgTime");
const closePopup = document.getElementById("closePopup");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");

let currentType = "ALL";
let currentSearch = "";

// ‡∏õ‡∏¥‡∏î popup
closePopup.onclick = () => {
  popup.style.display = "none";
};

// üïí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‚Äú‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏ã‡∏ô
// function formatThaiTime(localString) {
//   if (!localString) return "-";
//   const [datePart, timePart] = localString.split("T");
//   if (!timePart) return localString;
//   const [h, m, s] = timePart.replace("Z", "").split(":");
//   return `${h.padStart(2,"0")}:${m.padStart(2,"0")}:${s ? s.split(".")[0] : "00"}`;
// }
  function formatThaiTime(timeString) {
  if (!timeString) return "-";
  // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô +00:00 ‡∏´‡∏£‡∏∑‡∏≠ Z ‡∏ó‡∏¥‡πâ‡∏á
  timeString = timeString.replace("Z", "").replace("+00:00", "").trim();
  
  // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏´‡∏•‡∏±‡∏á T)
  const [datePart, timePart] = timeString.split("T");
  if (!timePart) return timeString;
  
  // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HH:mm:ss
  const [h, m, s] = timePart.split(":");
  return `${h.padStart(2, "0")}:${m.padStart(2, "0")}:${(s || "00").split(".")[0]}`;
}


// ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (ms ‚Üí HH:mm:ss)
function formatDuration(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id,bib,name,tag_id,type,status,record(lap,start_time,finish_time)")
    .order("name",{ascending:true});
  if (error) return console.error(error);

  let filtered = runners;
  if (currentType !== "ALL") filtered = filtered.filter(r => r.type === currentType);
  if (currentSearch.trim()) {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r => 
      (r.name || "").toLowerCase().includes(q) ||
      (r.tag_id || "").toLowerCase().includes(q) ||
      (r.bib || "").toLowerCase().includes(q)
    );
  }

  const data = filtered.map(r => {
    let totalTime = 0, completedLaps = 0;
    (r.record || []).forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    const distance = (completedLaps * 6.3).toFixed(2);
    return { ...r, totalTime, completedLaps, distance };
  });

  const finished = data.filter(r => r.status === "FINISHER").sort((a,b) => a.totalTime - b.totalTime);
  const running = data.filter(r => r.status === "RUNNING").sort((a,b) => b.completedLaps - a.completedLaps);
  const dnf = data.filter(r => r.status === "DNF").sort((a,b) => b.completedLaps - a.completedLaps);
  renderRunners([...finished, ...running, ...dnf]);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á
function renderRunners(list) {
  runnerTableBody.innerHTML = "";
  list.forEach((r,i) => {
    const rowClass = r.status === "FINISHER" ? "rank-finisher" : r.status === "DNF" ? "rank-dnf" : "rank-running";
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";
    const row = document.createElement("tr");
    row.className = `${rowClass} border-b hover:bg-gray-50 cursor-pointer`;
    row.innerHTML = `
      <td class="p-2 text-center">${i+1}</td>
      <td class="p-2 text-center font-medium">${r.bib || "-"}</td>
      <td class="p-2 font-medium text-blue-700 hover:underline">${r.name}</td>
      <td class="p-2 text-center">${r.type}</td>
      <td class="p-2 text-center">${r.completedLaps}</td>
      <td class="p-2 text-center">${r.distance}</td>
      <td class="p-2 text-center">${totalTimeText}</td>
    `;
    row.addEventListener("click", ()=> showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î popup
function showDetails(runner) {
  popup.style.display = "flex";
  popupTitle.textContent = `${runner.name} (${runner.type})`;
  popupBib.textContent = `BIB: ${runner.bib || "-"}`;
  const totalTime = runner.totalTime ? formatDuration(runner.totalTime) : "-";
  popupSummary.innerHTML = `
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${runner.status}</b> |
    ‡∏£‡∏≠‡∏ö: <b>${runner.completedLaps}</b> |
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${runner.distance} ‡∏Å‡∏°.</b> |
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: <b>${totalTime}</b>
  `;

  const laps = (runner.record || [])
    .filter(rec => rec.lap >= 0 && (rec.start_time || rec.finish_time))
    .sort((a,b) => a.lap - b.lap);

  popupContent.innerHTML = "";
  let totalLapTime = 0, count = 0;
  laps.forEach(rec => {
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      totalLapTime += diff; count++;
    }
    popupContent.innerHTML += `
      <tr class="border-t">
        <td class="p-2 text-center">${rec.lap + 1}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.start_time)}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.finish_time)}</td>
        <td class="p-2 text-center">${rec.start_time && rec.finish_time ? formatDuration(new Date(rec.finish_time) - new Date(rec.start_time)) : "-"}</td>
      </tr>`;
  });
  avgTime.textContent = count > 0 ? `‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatDuration(totalLapTime / count)} (‡∏à‡∏≤‡∏Å ${count} ‡∏£‡∏≠‡∏ö)` : "";
}

// Tabs
typeTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    typeTabs.forEach(t => t.classList.remove("active-tab"));
    tab.classList.add("active-tab");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

// Search
let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearch = searchInput.value.trim();
    loadDashboard();
  }, 300);
});

loadDashboard();
supabase.channel("record-changes")
  .on("postgres_changes",{event:"*",schema:"public",table:"record"},()=>loadDashboard())
  .subscribe();
setInterval(loadDashboard,15000);
</script>
</body>
</html>
