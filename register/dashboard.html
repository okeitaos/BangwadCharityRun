<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üèÉ Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  body {
    background: linear-gradient(135deg, #e0f2fe 0%, #f0fdfa 100%);
    font-family: "Prompt", sans-serif;
  }

  .dashboard-card {
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.85);
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }

  .rank-finisher { background: linear-gradient(90deg, #dcfce7, #bbf7d0); }
  .rank-running  { background: linear-gradient(90deg, #dbeafe, #bfdbfe); }
  .rank-dnf      { background: linear-gradient(90deg, #fee2e2, #fecaca); }
  tr:hover { transform: scale(1.01); transition: 0.25s; }

  .popup-bg {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: none; justify-content: center; align-items: center; z-index: 50;
  }

  .popup {
    background: rgba(255,255,255,0.97);
    backdrop-filter: blur(10px);
    padding: 1.5rem;
    border-radius: 1rem;
    width: 95%; max-width: 600px; max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    opacity: 0; transform: translateY(15px);
    transition: all 0.3s ease;
  }

  .popup.show { opacity: 1; transform: translateY(0); }

  .modal-header {
    background: linear-gradient(to right, #2563eb, #3b82f6);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }
</style>
</head>
<body class="min-h-screen p-6">

<h1 class="text-3xl font-bold text-center mb-6 text-gray-800 drop-shadow">üìä Race Dashboard</h1>

<!-- Tabs -->
<div class="flex flex-wrap justify-center gap-2 mb-6">
  <button data-type="ALL" class="type-tab bg-blue-600 text-white px-4 py-2 rounded-lg shadow active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-200 hover:bg-blue-100 px-4 py-2 rounded-lg">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-200 hover:bg-blue-100 px-4 py-2 rounded-lg">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-200 hover:bg-blue-100 px-4 py-2 rounded-lg">BCR 100.8</button>
</div>

<!-- Search -->
<div class="flex justify-center mb-8">
  <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, BIB ‡∏´‡∏£‡∏∑‡∏≠ Tag ID..."
    class="border rounded-lg p-3 w-full max-w-md shadow focus:outline-none focus:ring-2 focus:ring-blue-400">
</div>

<!-- Dashboard -->
<div id="runner-list" class="dashboard-card max-w-6xl mx-auto p-6 overflow-x-auto">
  <table class="w-full text-sm text-left border-collapse">
    <thead class="bg-blue-50 border-b border-gray-200 text-gray-700 uppercase text-xs">
      <tr>
        <th class="p-3 text-center">üèÖ</th>
        <th class="p-3 text-center">BIB</th>
        <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-3 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-3 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-3 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- Popup -->
<div id="popup" class="popup-bg">
  <div class="popup">
    <div class="modal-header">
      <h2 id="popupTitle" class="text-lg font-semibold"></h2>
      <p id="popupBib" class="text-sm text-gray-100"></p>
    </div>
    <div id="popupSummary" class="text-sm my-3 text-gray-800"></div>

    <table class="w-full text-xs sm:text-sm mb-3 border">
      <thead>
        <tr class="bg-gray-100 text-gray-700">
          <th class="p-2 text-center">üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 text-center">‚è± ‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th class="p-2 text-center">üèÅ ‡∏à‡∏ö</th>
          <th class="p-2 text-center">‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="popupContent"></tbody>
    </table>

    <p id="avgTime" class="text-center text-sm text-gray-600 mb-4"></p>
    <button id="closePopup" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full shadow">
      ‡∏õ‡∏¥‡∏î
    </button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const runnerTableBody = document.getElementById("runnerTableBody");
const popup = document.getElementById("popup");
const popupContent = document.getElementById("popupContent");
const popupTitle = document.getElementById("popupTitle");
const popupBib = document.getElementById("popupBib");
const popupSummary = document.getElementById("popupSummary");
const avgTime = document.getElementById("avgTime");
const closePopup = document.getElementById("closePopup");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");

let currentType = "ALL";
let currentSearch = "";

closePopup.onclick = () => {
  popup.classList.remove("show");
  document.body.style.overflow = "auto";
  setTimeout(() => popup.style.display = "none", 200);
};

function formatDuration(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id,bib,name,tag_id,type,status,record(lap,start_time,finish_time)")
    .order("name", { ascending: true });

  if (error) {
    console.error("Error loading data:", error);
    return;
  }

  let filtered = runners || [];
  if (currentType !== "ALL") filtered = filtered.filter(r => r.type === currentType);
  if (currentSearch.trim()) {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r =>
      (r.name || "").toLowerCase().includes(q) ||
      (r.tag_id || "").toLowerCase().includes(q) ||
      (r.bib || "").toLowerCase().includes(q)
    );
  }

  const data = filtered.map(r => {
    const laps = r.record || [];
    let totalTime = 0, completedLaps = 0;
    laps.forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    const distance = (completedLaps * 6.3).toFixed(2);
    return { ...r, totalTime, completedLaps, distance };
  });

  const finished = data.filter(r => r.status === "FINISHER").sort((a,b)=>a.totalTime-b.totalTime);
  const running  = data.filter(r => r.status === "RUNNING").sort((a,b)=>b.completedLaps-a.completedLaps);
  const dnf      = data.filter(r => r.status === "DNF").sort((a,b)=>b.completedLaps-a.completedLaps);

  renderRunners([...finished, ...running, ...dnf]);
}

function renderRunners(list) {
  runnerTableBody.innerHTML = "";
  list.forEach((r,i) => {
    const row = document.createElement("tr");
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";
    let rowClass = r.status === "FINISHER" ? "rank-finisher" : r.status === "DNF" ? "rank-dnf" : "rank-running";
    row.className = `${rowClass} border-b cursor-pointer`;
    row.innerHTML = `
      <td class="p-3 text-center font-semibold">${i+1}</td>
      <td class="p-3 text-center font-bold text-gray-700">${r.bib || "-"}</td>
      <td class="p-3 font-medium text-blue-700 hover:underline">${r.name}</td>
      <td class="p-3 text-center">${r.type}</td>
      <td class="p-3 text-center">${r.completedLaps}</td>
      <td class="p-3 text-center">${r.distance}</td>
      <td class="p-3 text-center">${totalTimeText}</td>
    `;
    row.addEventListener("click", () => showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

function showDetails(runner) {
  popup.style.display = "flex";
  document.body.style.overflow = "hidden";
  setTimeout(() => popup.classList.add("show"), 30);

  popupTitle.textContent = `${runner.name} (${runner.type})`;
  popupBib.textContent = `BIB: ${runner.bib || "-"}`;
  const totalTime = runner.totalTime ? formatDuration(runner.totalTime) : "-";
  popupSummary.innerHTML = `
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${runner.status}</b> |
    ‡∏£‡∏≠‡∏ö: <b>${runner.completedLaps}</b> |
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${runner.distance} ‡∏Å‡∏°.</b> |
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: <b>${totalTime}</b>
  `;

  const laps = (runner.record || [])
    .filter(rec => rec.lap >= 0 && (rec.start_time || rec.finish_time))
    .sort((a,b) => a.lap - b.lap);

  popupContent.innerHTML = "";
  if (laps.length === 0) {
    popupContent.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á</td></tr>`;
    avgTime.textContent = "";
    return;
  }

  let totalLapTime = 0, count = 0;
  laps.forEach(rec => {
    let lapDiff = "-";
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      totalLapTime += diff; count++;
      lapDiff = formatDuration(diff);
    }
    popupContent.innerHTML += `
      <tr class="border-t hover:bg-blue-50 transition">
        <td class="p-2 text-center font-medium">${rec.lap + 1}</td>
        <td class="p-2 text-center">${rec.start_time ? new Date(rec.start_time).toLocaleTimeString("th-TH") : "-"}</td>
        <td class="p-2 text-center">${rec.finish_time ? new Date(rec.finish_time).toLocaleTimeString("th-TH") : "-"}</td>
        <td class="p-2 text-center">${lapDiff}</td>
      </tr>`;
  });
  avgTime.textContent = count > 0 ? `‚è± ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö: ${formatDuration(totalLapTime / count)} (‡∏à‡∏≤‡∏Å ${count} ‡∏£‡∏≠‡∏ö)` : "";
}

typeTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    typeTabs.forEach(t => t.classList.remove("bg-blue-600","text-white"));
    tab.classList.add("bg-blue-600","text-white");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearch = searchInput.value.trim();
    loadDashboard();
  }, 300);
});

loadDashboard();
supabase.channel("record-changes")
  .on("postgres_changes", { event: "*", schema: "public", table: "record" }, () => loadDashboard())
  .subscribe();
setInterval(loadDashboard, 15000);
</script>
</body>
</html>
