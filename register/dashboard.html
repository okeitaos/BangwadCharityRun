<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üèÉ Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .rank-finisher { background-color: #d1fae5; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
  .rank-running { background-color: #fef9c3; }  /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  .rank-dnf { background-color: #fee2e2; }      /* ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  .active-tab { background-color: #2563eb !important; color: white !important; }
  .popup-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; }
  .popup { background: white; padding: 20px; border-radius: 10px; width: 95%; max-width: 550px; max-height: 85vh; overflow-y: auto; }
  @keyframes blinkSlow {
    0%,100% { background-color: inherit; }
    50% { background-color: rgba(253,230,138,0.5); }
  }
  .blink-slow { animation: blinkSlow 2.5s infinite; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<h1 class="text-3xl font-bold text-center mb-4">üìä DASHBOARD ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
<div class="flex justify-center mb-4">
  <select id="langSelect" class="border p-2 rounded">
    <option value="TH">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
    <option value="EN">üá¨üáß English</option>
  </select>
</div>

<!-- Tabs -->
<div class="flex flex-wrap justify-center space-x-2 mb-4">
  <button data-type="ALL" class="type-tab bg-gray-300 px-3 py-1 rounded active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 100.8</button>
</div>

<!-- Search -->
<div class="flex justify-center mb-6">
  <input id="searchInput" type="text" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠, Tag ID ‡∏´‡∏£‡∏∑‡∏≠ BIB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded w-full max-w-md">
</div>

<!-- Table -->
<div id="runner-list" class="max-w-5xl mx-auto bg-white p-4 rounded-lg shadow">
  <table class="w-full text-sm text-left border-collapse">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 text-center">üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
        <th class="p-2 text-center">BIB</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- Popup -->
<div id="popup" class="popup-bg" role="dialog" aria-modal="true">
  <div class="popup">
    <h2 id="popupTitle" class="text-lg font-semibold mb-1"></h2>
    <div id="popupBib" class="text-sm text-gray-600 mb-2"></div>
    <div id="popupSummary" class="text-sm mb-3 text-gray-700"></div>
    <table class="w-full text-xs sm:text-sm mb-3 border">
      <thead>
        <tr class="bg-gray-100 text-gray-700">
          <th class="p-2 text-center">üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 text-center">‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th class="p-2 text-center">üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</th>
          <th class="p-2 text-center">‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="popupContent"></tbody>
    </table>
    <p id="avgTime" class="text-center text-sm text-gray-600 mb-4"></p>
    <button id="closePopup" class="bg-gray-700 text-white px-3 py-2 rounded w-full">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>
<script>
/* ------------------ Supabase Init (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ------------------ */
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------ Constants: ‡∏£‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô ------------------ */
const CATEGORY_LAPS = {
  "BCR 50.4": { full: 8, half: 4 },
  "BCR 69.3": { full: 11, half: 6 },
  "BCR 100.8": { full: 16, half: 8 }
};

/* ------------------ ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ------------------ */
function getShirtStatus(type, laps) {
  const c = CATEGORY_LAPS[type];
  if (!c) return "-";
  if (laps >= c.full) return "‡πÄ‡∏™‡∏∑‡πâ‡∏≠ Finisher";
  if (laps >= c.half) return "‡πÄ‡∏™‡∏∑‡πâ‡∏≠ DNF";
  return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠";
}
function getShirtStatusEN(type, laps) {
  const c = CATEGORY_LAPS[type];
  if (!c) return "-";
  if (laps >= c.full) return "Finisher Shirt";
  if (laps >= c.half) return "DNF Shirt";
  return "No Shirt";
}

/* ------------------ DOM References (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ------------------ */
const runnerTableBody = document.getElementById("runnerTableBody");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupBib = document.getElementById("popupBib");
const popupSummary = document.getElementById("popupSummary");
const popupContent = document.getElementById("popupContent");
const avgTime = document.getElementById("avgTime");
const closePopup = document.getElementById("closePopup");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");
const langSelect = document.getElementById("langSelect");

let currentType = "ALL";
let currentSearch = "";
let currentLang = "TH";

/* ------------------ Utility functions (‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° + ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ behavior) ------------------ */

// ‡∏õ‡∏¥‡∏î popup
closePopup.onclick = () => {
  popup.style.display = "none";
};

// ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö behavior ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
function formatThaiTime(timeString) {
  if (!timeString) return "-";
  timeString = timeString.replace("Z", "").replace("+00:00", "").trim();
  const [datePart, timePart] = timeString.split("T");
  if (!timePart) return timeString;
  const [h, m, s] = timePart.split(":");
  return `${h.padStart(2, "0")}:${m.padStart(2, "0")}:${(s || "00").split(".")[0]}`;
}

// ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (ms ‚Üí HH:mm:ss)
function formatDuration(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

/* ------------------ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° shirt fields ‡πÅ‡∏ï‡πà‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ) ------------------ */
async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å field ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏ß‡∏° record relation
    .select("id,bib,name,tag_id,type,status,record(lap,start_time,finish_time)")
    .order("name",{ascending:true});

  if (error) {
    console.error(error);
    return;
  }

  let filtered = runners || [];
  if (currentType !== "ALL") filtered = filtered.filter(r => r.type === currentType);
  if (currentSearch.trim()) {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r => 
      (r.name || "").toLowerCase().includes(q) ||
      (r.tag_id || "").toLowerCase().includes(q) ||
      (r.bib || "").toLowerCase().includes(q)
    );
  }

  const data = filtered.map(r => {
    let totalTime = 0, completedLaps = 0;
    (r.record || []).forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    const distance = (completedLaps * 6.3).toFixed(2);

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ logic ‡∏≠‡∏∑‡πà‡∏ô)
    const shirtTH = getShirtStatus(r.type, completedLaps);
    const shirtEN = getShirtStatusEN(r.type, completedLaps);

    return { ...r, totalTime, completedLaps, distance, shirtTH, shirtEN };
  });

  // ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°
  const finished = data.filter(r => r.status === "FINISHER").sort((a,b) => a.totalTime - b.totalTime);
  const running = data.filter(r => r.status === "RUNNING").sort((a,b) => b.completedLaps - a.completedLaps);
  const dnf = data.filter(r => r.status === "DNF").sort((a,b) => b.completedLaps - a.completedLaps);

  renderRunners([...finished, ...running, ...dnf]);
}

/* ------------------ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á (render) ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ row ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ------------------ */
function renderRunners(list) {
  runnerTableBody.innerHTML = "";
  list.forEach((r,i) => {
    const rowClass = r.status === "FINISHER" ? "rank-finisher" : r.status === "DNF" ? "rank-dnf" : "rank-running";
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";
    const row = document.createElement("tr");
    row.className = `${rowClass} border-b hover:bg-gray-50 cursor-pointer`;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á innerHTML ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
    row.innerHTML = `
      <td class="p-2 text-center">${i+1}</td>
      <td class="p-2 text-center font-medium">${r.bib || "-"}</td>
      <td class="p-2 font-medium text-blue-700 hover:underline">${r.name}</td>
      <td class="p-2 text-center">${r.type}</td>
      <td class="p-2 text-center">${r.completedLaps}</td>
      <td class="p-2 text-center">${r.distance}</td>
      <td class="p-2 text-center">${totalTimeText}</td>
      <td class="p-2 text-center">${currentLang === "TH" ? (r.shirtTH || "-") : (r.shirtEN || "-")}</td>
    `;

    row.addEventListener("click", ()=> showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

/* ------------------ ‡πÅ‡∏™‡∏î‡∏á popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ------------------ */
function showDetails(runner) {
  popup.style.display = "flex";
  popupTitle.textContent = `${runner.name} (${runner.type})`;
  popupBib.textContent = `BIB: ${runner.bib || "-"}`;
  const totalTime = runner.totalTime ? formatDuration(runner.totalTime) : "-";

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á summary ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏î‡πâ‡∏ß‡∏¢
  const shirtTxt = currentLang === "TH" ? (runner.shirtTH || "-") : (runner.shirtEN || "-");

  popupSummary.innerHTML = `
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${runner.status}</b> |
    ‡∏£‡∏≠‡∏ö: <b>${runner.completedLaps}</b> |
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${runner.distance} ‡∏Å‡∏°.</b> |
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: <b>${totalTime}</b> |
    üéΩ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠: <b>${shirtTxt}</b>
  `;

  const laps = (runner.record || [])
    .filter(rec => rec.lap >= 0 && (rec.start_time || rec.finish_time))
    .sort((a,b) => a.lap - b.lap);

  popupContent.innerHTML = "";
  let totalLapTime = 0, count = 0;
  laps.forEach(rec => {
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      totalLapTime += diff; count++;
    }
    popupContent.innerHTML += `
      <tr class="border-t">
        <td class="p-2 text-center">${rec.lap + 1}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.start_time)}</td>
        <td class="p-2 text-center">${formatThaiTime(rec.finish_time)}</td>
        <td class="p-2 text-center">${rec.start_time && rec.finish_time ? formatDuration(new Date(rec.finish_time) - new Date(rec.start_time)) : "-"}</td>
      </tr>`;
  });
  avgTime.textContent = count > 0 ? `‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatDuration(totalLapTime / count)} (‡∏à‡∏≤‡∏Å ${count} ‡∏£‡∏≠‡∏ö)` : "";
}

/* ------------------ Tabs & Search behavior (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ------------------ */
typeTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    typeTabs.forEach(t => t.classList.remove("active-tab"));
    tab.classList.add("active-tab");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearch = searchInput.value.trim();
    loadDashboard();
  }, 300);
});

/* ------------------ Real-time + polling (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ------------------ */
loadDashboard();
supabase.channel("record-changes")
  .on("postgres_changes",{event:"*",schema:"public",table:"record"},()=>loadDashboard())
  .subscribe();
setInterval(loadDashboard,15000);

/* ------------------ Translations (‡∏Ç‡∏¢‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠) ------------------ */
const translations = {
  TH: {
    title: "üìä DASHBOARD ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô",
    all: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    t50: "BCR 50.4",
    t69: "BCR 69.3",
    t100: "BCR 100.8",
    search: "üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠, Tag ID ‡∏´‡∏£‡∏∑‡∏≠ BIB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
    
    col_rank: "üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö",
    col_bib: "BIB",
    col_name: "‡∏ä‡∏∑‡πà‡∏≠",
    col_type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    col_lap: "‡∏£‡∏≠‡∏ö",
    col_dist: "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)",
    col_total: "‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°",
    col_shirt: "üéΩ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠",

    status_FINISHER: "FINISHER",
    status_RUNNING: "RUNNING",
    status_DNF: "DNF",

    popup_close: "‡∏õ‡∏¥‡∏î",
    popup_summary: (status,laps,dist,time) =>
      `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${status}</b> | ‡∏£‡∏≠‡∏ö: <b>${laps}</b> | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${dist} ‡∏Å‡∏°.</b> | ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: <b>${time}</b>`,

    popup_lap: "üèÅ ‡∏£‡∏≠‡∏ö",
    popup_start: "‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°",
    popup_finish: "üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö",
    popup_laptime: "‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö"
  },

  EN: {
    title: "üìä Race Dashboard Summary",
    all: "All",
    t50: "BCR 50.4",
    t69: "BCR 69.3",
    t100: "BCR 100.8",
    search: "üîç Search name, Tag ID or BIB...",

    col_rank: "üèÖ Rank",
    col_bib: "BIB",
    col_name: "Name",
    col_type: "Category",
    col_lap: "Laps",
    col_dist: "Distance (km)",
    col_total: "Total Time",
    col_shirt: "üéΩ Shirt",

    status_FINISHER: "FINISHER",
    status_RUNNING: "RUNNING",
    status_DNF: "DNF",

    popup_close: "Close",
    popup_summary: (status,laps,dist,time) =>
      `Status: <b>${status}</b> | Laps: <b>${laps}</b> | Distance: <b>${dist} km</b> | Total: <b>${time}</b>`,

    popup_lap: "üèÅ Lap",
    popup_start: "‚è± Start",
    popup_finish: "üèÅ Finish",
    popup_laptime: "‚è≥ Lap Time"
  }
};

function translateStatus(status) {
  // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (FINISHER/RUNNING/DNF) ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° translations
  return translations[currentLang][`status_${status}`] || status;
}

/* ------------------ Apply translations to DOM (‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠) ------------------ */
function applyTranslation(lang) {
  currentLang = lang;
  const t = translations[lang];

  // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß
  document.querySelector("h1").textContent = t.title;

  // Tabs
  const tabs = document.querySelectorAll(".type-tab");
  if (tabs.length >= 4) {
    tabs[0].textContent = t.all;
    tabs[1].textContent = t.t50;
    tabs[2].textContent = t.t69;
    tabs[3].textContent = t.t100;
  }

  // ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const searchInputEl = document.getElementById("searchInput");
  if (searchInputEl) searchInputEl.placeholder = t.search;

  // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 7 ‡∏´‡∏±‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏™‡∏∑‡πâ‡∏≠")
  const theadRow = document.querySelector("thead tr");
  if (theadRow) {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 7 ‡∏´‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏ó‡∏µ‡πà 8 (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    const ths = theadRow.querySelectorAll("th");
    if (ths.length >= 7 && ths.length < 8) {
      const th = document.createElement("th");
      th.className = "p-2 text-center";
      th.textContent = t.col_shirt;
      theadRow.appendChild(th);
    } else if (ths.length >= 8) {
      theadRow.querySelectorAll("th")[7].textContent = t.col_shirt;
    }
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà DOM ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏±‡∏ß)
    const thAll = theadRow.querySelectorAll("th");
    if (thAll.length >= 7) {
      thAll[0].textContent = t.col_rank;
      thAll[1].textContent = t.col_bib;
      thAll[2].textContent = t.col_name;
      thAll[3].textContent = t.col_type;
      thAll[4].textContent = t.col_lap;
      thAll[5].textContent = t.col_dist;
      thAll[6].textContent = t.col_total;
    }
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î popup
  const closePopupBtn = document.getElementById("closePopup");
  if (closePopupBtn) closePopupBtn.textContent = t.popup_close;
}

/* -------- Hook ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á popup ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏£‡∏≤‡∏ó‡∏≥ override ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) -------- */
const _showDetails = showDetails;
showDetails = function (runner) {
  _showDetails(runner); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏° shirt)
  // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ showDetails ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á popupSummary ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß
  // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡πÉ‡∏ô popup header ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
};

/* -------- Hook renderRunners ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° -------- */
const _renderRunners = renderRunners;
renderRunners = function (list) {
  // ‡πÅ‡∏õ‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ render ‡πÄ‡∏î‡∏¥‡∏°
  const mapped = list.map(r => ({
    ...r,
    // ‡πÅ‡∏õ‡∏•‡∏á status label (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•)
    status: translateStatus(r.status)
  }));

  _renderRunners(mapped);
};

/* -------- ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô TH ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° select change -------- */
applyTranslation("TH");
if (langSelect) {
  langSelect.addEventListener("change", function () {
    applyTranslation(this.value);
    // ‡∏£‡∏µ-render ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
    loadDashboard();
  });
}

/* ------------------ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á event realtime (‡πÄ‡∏î‡∏¥‡∏°) ------------------ */
/* (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô: loadDashboard, supabase channel ‡πÅ‡∏•‡∏∞ setInterval) */

</script>

</body>
</html>
