<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üèÉ‚Äç‚ôÇÔ∏è Race Analytics Dashboard (Realtime + Chart)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .rank-finisher { background-color: #d1fae5; }
  .rank-running { background-color: #fef9c3; }
  .rank-dnf { background-color: #fee2e2; }
  .active-tab { background-color: #2563eb !important; color: white !important; }
  .popup-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 50; }
  .popup { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; }
</style>
</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold text-center mb-4">üìä DASHBOARD ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>

<!-- üîò ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
<div class="flex flex-wrap justify-center space-x-2 mb-4">
  <button data-type="ALL" class="type-tab bg-gray-300 px-3 py-1 rounded active-tab">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button data-type="BCR 50.4" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 50.4</button>
  <button data-type="BCR 69.3" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 69.3</button>
  <button data-type="BCR 100.8" class="type-tab bg-gray-300 px-3 py-1 rounded">BCR 100.8</button>
</div>

<!-- üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
<div class="flex justify-center mb-6">
  <input id="searchInput" type="text" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ Tag ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded w-full max-w-md">
</div>

<!-- üìä ‡∏Å‡∏£‡∏≤‡∏ü TOP10 -->
<div class="max-w-4xl mx-auto bg-white p-4 rounded-lg shadow mb-6">
  <h2 class="text-xl font-semibold mb-2 text-center">üèÜ TOP 10 ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h2>
  <canvas id="lapChart" height="100"></canvas>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
<div id="runner-list" class="max-w-5xl mx-auto bg-white p-4 rounded-lg shadow">
  <table class="w-full text-sm text-left border-collapse">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 text-center">üèÖ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th class="p-2 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
        <th class="p-2 text-center">‡∏£‡∏≠‡∏ö</th>
        <th class="p-2 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)</th>
        <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="runnerTableBody"></tbody>
  </table>
</div>

<!-- Popup ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lap -->
<div id="popup" class="popup-bg">
  <div class="popup">
    <h2 id="popupTitle" class="text-lg font-semibold mb-2"></h2>
    <div id="popupContent" class="text-sm mb-4"></div>
    <button id="closePopup" class="bg-gray-700 text-white px-3 py-1 rounded w-full">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üëà ‡πÉ‡∏™‡πà anon key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const runnerTableBody = document.getElementById("runnerTableBody");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupContent = document.getElementById("popupContent");
const closePopup = document.getElementById("closePopup");
const typeTabs = document.querySelectorAll(".type-tab");
const searchInput = document.getElementById("searchInput");
const ctx = document.getElementById("lapChart").getContext("2d");

let currentType = "ALL";
let currentSearch = "";
let chartInstance = null;

closePopup.onclick = () => popup.style.display = "none";

function formatDuration(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id, name, tag_id, type, status, record(lap, start_time, finish_time)")
    .order("name", { ascending: true });
  if (error) return console.error(error);

  let filtered = runners;
  if (currentType !== "ALL") {
    filtered = filtered.filter(r => (r.type || "").replace(/\s+/g,"").toUpperCase().includes(currentType.replace(" ","").toUpperCase()));
  }
  if (currentSearch.trim() !== "") {
    const q = currentSearch.toLowerCase();
    filtered = filtered.filter(r =>
      (r.name || "").toLowerCase().includes(q) ||
      (r.tag_id || "").toLowerCase().includes(q)
    );
  }

  const data = filtered.map(r => {
    let totalTime = 0, completedLaps = 0;
    (r.record || []).forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    const distance = (completedLaps * 6.3).toFixed(2);
    return { ...r, totalTime, completedLaps, distance };
  });

  const finished = data.filter(r => r.status === "FINISHER").sort((a,b) => a.totalTime - b.totalTime);
  const running = data.filter(r => r.status === "RUNNING").sort((a,b) => b.completedLaps - a.completedLaps);
  const dnf = data.filter(r => r.status === "DNF").sort((a,b) => b.completedLaps - a.completedLaps);
  const all = [...finished, ...running, ...dnf];

  updateTable(all);
  updateChart(finished.slice(0, 10));
}

function updateTable(runners) {
  runnerTableBody.innerHTML = "";
  runners.forEach((r, i) => {
    const rowClass = r.status === "FINISHER" ? "rank-finisher"
                   : r.status === "DNF" ? "rank-dnf" : "rank-running";
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";

    const row = document.createElement("tr");
    row.className = `${rowClass} border-b hover:bg-gray-100 cursor-pointer`;
    row.innerHTML = `
      <td class="p-2 text-center">${i + 1}</td>
      <td class="p-2 font-medium text-blue-700 hover:underline">${r.name}</td>
      <td class="p-2 text-center">${r.type}</td>
      <td class="p-2 text-center">${r.completedLaps}</td>
      <td class="p-2 text-center">${r.distance}</td>
      <td class="p-2 text-center">${totalTimeText}</td>
    `;
    row.addEventListener("click", () => showDetails(r));
    runnerTableBody.appendChild(row);
  });
}

// üßÆ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü TOP10
function updateChart(top10) {
  const labels = top10.map(r => r.name);
  const times = top10.map(r => Math.floor(r.totalTime / 1000 / 60)); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ

  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)",
        data: times,
        backgroundColor: "rgba(37,99,235,0.6)",
        borderColor: "#2563eb",
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "‡∏ô‡∏≤‡∏ó‡∏µ" } },
        x: { title: { display: true, text: "‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á Top 10" } }
      }
    }
  });
}

function showDetails(runner) {
  popup.style.display = "flex";
  popupTitle.textContent = `${runner.name} (${runner.type})`;
  let content = "";

  if (!runner.record || runner.record.length === 0) {
    popupContent.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏ß‡∏¥‡πà‡∏á</p>";
    return;
  }

  const laps = runner.record.sort((a,b) => a.lap - b.lap);
  laps.forEach(rec => {
    const start = rec.start_time ? new Date(rec.start_time).toLocaleString("th-TH") : "-";
    const finish = rec.finish_time ? new Date(rec.finish_time).toLocaleString("th-TH") : "-";
    let dur = "-";
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      dur = formatDuration(diff);
    }
    content += `
      <div class="border-b py-1">
        <b>Lap ${rec.lap}</b><br>
        üïí Start: ${start}<br>
        üèÅ Finish: ${finish}<br>
        ‚è± Duration: ${dur}
      </div>
    `;
  });
  popupContent.innerHTML = content;
}

// üîò ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∏‡πà‡∏ô
typeTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    typeTabs.forEach(t => t.classList.remove("active-tab"));
    tab.classList.add("active-tab");
    currentType = tab.dataset.type;
    loadDashboard();
  });
});

// üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentSearch = searchInput.value.trim();
    loadDashboard();
  }, 400);
});

// üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
loadDashboard();
setInterval(loadDashboard, 15000);
supabase.channel("record-changes")
  .on("postgres_changes", { event: "*", schema: "public", table: "record" }, () => loadDashboard())
  .subscribe();
</script>
</body>
</html>
