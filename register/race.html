<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ğŸƒ Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 p-6">
<h1 class="text-2xl font-bold mb-4 text-center">ğŸƒ Race Dashboard</h1>

<!-- à¸ªà¹à¸à¸™à¹à¸—à¹‡à¸ -->
<div class="max-w-3xl mx-auto bg-white p-4 rounded-lg shadow mb-4">
  <input id="tagInput" type="text" placeholder="à¸ªà¹à¸à¸™ Tag ID"
    class="w-full border rounded px-3 py-2 focus:outline-none" autofocus>
  <p id="status" class="text-sm text-gray-600 mt-2"></p>
</div>

<!-- Dashboard -->
<div class="max-w-3xl mx-auto bg-white p-4 rounded-lg shadow">
  <h2 class="text-lg font-semibold mb-4">ğŸ“Š Dashboard - Ranking</h2>
  <div id="runner-list" class="space-y-2"></div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // ğŸ‘ˆ à¹ƒà¸ªà¹ˆ anon key à¸‚à¸­à¸‡à¸„à¸¸à¸“
const FUNCTION_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co/functions/v1/rfid-reader";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const tagInput = document.getElementById("tagInput");
const statusEl = document.getElementById("status");
const runnerList = document.getElementById("runner-list");

let scanTimeout = null;
const SCAN_DELAY = 200;

// âœ… à¸à¸•à¸´à¸à¸²à¹à¸•à¹ˆà¸¥à¸°à¸£à¸¸à¹ˆà¸™
function getRaceRules(type) {
  const normalized = (type || "").replace(/\s+/g, "").toUpperCase();
  if (normalized.includes("BCR50.4")) return { finisher: 8, dnf: 4 };
  if (normalized.includes("BCR69.3")) return { finisher: 11, dnf: 6 };
  if (normalized.includes("BCR100.8")) return { finisher: 16, dnf: 8 };
  return { finisher: 4, dnf: 2 };
}

// à¹à¸›à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹€à¸›à¹‡à¸™ HH:MM:SS
function formatDuration(ms) {
  let totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  totalSeconds %= 3600;
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

// ğŸ·ï¸ Scan à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
tagInput.addEventListener("input", () => {
  if (scanTimeout) clearTimeout(scanTimeout);
  scanTimeout = setTimeout(async () => {
    const tagId = tagInput.value.trim();
    if (!tagId) return;
    try {
      const resp = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({ tag_id: tagId })
      });
      const result = await resp.json();
      if (result.error) statusEl.textContent = "âŒ " + result.error;
      else if (result.message) statusEl.textContent = "ğŸ " + result.message;
      else statusEl.textContent = `âœ… ${result.runner} à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸­à¸šà¸—à¸µà¹ˆ ${result.lap} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`;
      tagInput.value = "";
      loadDashboard();
    } catch (err) {
      statusEl.textContent = "âŒ Error: " + err.message;
    }
  }, SCAN_DELAY);
});

// ğŸ§­ à¹‚à¸«à¸¥à¸” Dashboard
async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select(`id, name, type, status, record(lap, start_time, finish_time)`)
    .order("id", { ascending: true });
  if (error) return console.error(error);

  runnerList.innerHTML = "";

  runners.forEach(r => {
    const rules = getRaceRules(r.type);
    const finisherRequired = rules.finisher;
    const dnfStart = rules.dnf;

    // âœ… à¸™à¸±à¸šà¸—à¸¸à¸à¸£à¸­à¸šà¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¹à¸¥à¹‰à¸§ (start_time)
    let totalTime = 0;
    let completedLaps = 0;
    r.record.forEach(rec => {
      if (rec.start_time) completedLaps++; // à¸™à¸±à¸šà¸£à¸§à¸¡à¸£à¸­à¸šà¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¹à¸¥à¹‰à¸§
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
      }
    });

    const distance = (completedLaps * 6.3).toFixed(2);
    const totalTimeText = totalTime ? formatDuration(totalTime) : "-";

    // âœ… à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™
    let status = "RUNNING";
    if (completedLaps >= finisherRequired) status = "FINISHER";
    else if (completedLaps >= dnfStart) status = "DNF";

    // ğŸ à¹à¸ªà¸”à¸‡à¸œà¸¥à¹ƒà¸™ Dashboard
    runnerList.innerHTML += `
      <div class="border-b py-2 flex justify-between items-start">
        <div>
          <b>${r.name}</b> (${r.type})<br>
          à¸ªà¸–à¸²à¸™à¸°: ${status}<br>
          ğŸ à¸£à¸­à¸šà¸—à¸µà¹ˆ: ${completedLaps} / ${finisherRequired}<br>
          à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡: ${distance} à¸à¸¡.
        </div>
        <div class="text-right text-sm text-gray-700">
          ${status === "FINISHER" ? "ğŸ–ï¸ à¸„à¸£à¸šà¸£à¸°à¸¢à¸°à¹à¸¥à¹‰à¸§" : ""}
          ${status === "DNF" && completedLaps < finisherRequired ? "âš ï¸ à¸–à¸¶à¸‡à¸£à¸°à¸¢à¸° DNF à¹à¸¥à¹‰à¸§" : ""}
          <br>à¸£à¸§à¸¡à¹€à¸§à¸¥à¸²: ${totalTimeText}
        </div>
      </div>`;
  });
}

// ğŸ”„ à¹‚à¸«à¸¥à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸ 10 à¸§à¸´
loadDashboard();
setInterval(loadDashboard, 10000);
</script>
</body>
</html>
