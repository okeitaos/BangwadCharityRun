<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üèÉ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≠‡∏ö ‚Äî Race Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .blink-slow { animation: blinkSlow 2.5s infinite; }
  @keyframes blinkSlow {
    0%,100% { background-color: inherit; }
    50% { background-color: rgba(253,230,138,0.45); }
  }
  .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 50; }
  .modal { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
</style>
</head>
<body class="bg-gray-100 min-h-screen text-sm leading-relaxed">

<div class="max-w-4xl mx-auto p-4">
  <header class="mb-4 text-center">
    <h1 class="text-2xl sm:text-3xl font-bold">üèÉ Race Dashboard</h1>
    <p class="text-xs text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ / ‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°</p>
  </header>

  <!-- Input + Tabs -->
  <section class="bg-white rounded-lg shadow p-4 mb-4">
    <label class="block text-xs text-gray-600 mb-1">‡∏™‡πÅ‡∏Å‡∏ô Tag ID</label>
    <div class="flex gap-2 mb-2">
      <input id="tagInput" type="text" inputmode="numeric" autocomplete="off"
        placeholder="‡∏™‡πÅ‡∏Å‡∏ô Tag ID ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." 
        class="flex-grow border rounded-md px-3 py-2 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400" autofocus>
      <button id="scanBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md">‡∏™‡πÅ‡∏Å‡∏ô</button>
    </div>
    <p id="status" class="text-sm text-gray-700 mb-2"></p>

    <div class="flex gap-2 justify-center">
      <button data-type="TOP100MEN" class="type-btn bg-blue-500 text-white px-3 py-2 rounded-md flex-1">MEN</button>
      <button data-type="TOP100WOMEN" class="type-btn bg-pink-500 text-white px-3 py-2 rounded-md flex-1">WOMEN</button>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="mb-4">
    <h2 class="text-lg font-semibold mb-2">üìä ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á</h2>
    <div id="runner-list" class="space-y-3"></div>
  </section>
</div>

<!-- Modal -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <h2 id="modalTitle" class="text-lg font-bold text-gray-800"></h2>
    <p id="modalSummary" class="text-sm text-gray-700 mb-3"></p>
    <table class="w-full text-xs sm:text-sm mb-3">
      <thead>
        <tr class="bg-gray-100 text-gray-700">
          <th class="p-2 text-center">üèÅ ‡∏£‡∏≠‡∏ö</th>
          <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</th>
          <th class="p-2 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
        </tr>
      </thead>
      <tbody id="modalContent"></tbody>
    </table>
    <p id="avgTime" class="text-center text-sm text-gray-600 mb-4"></p>
    <button id="closeModal" class="bg-gray-700 text-white w-full py-2 rounded">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics"; // üîß ‡πÉ‡∏™‡πà anon key
const FUNCTION_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co/functions/v1/rfid-reader";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const tagInput = document.getElementById("tagInput");
const scanBtn = document.getElementById("scanBtn");
const statusEl = document.getElementById("status");
const runnerList = document.getElementById("runner-list");
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalSummary = document.getElementById("modalSummary");
const modalContent = document.getElementById("modalContent");
const avgTime = document.getElementById("avgTime");
const closeModal = document.getElementById("closeModal");

let currentType = "TOP100MEN";

document.querySelectorAll(".type-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    currentType = btn.dataset.type;
    document.querySelectorAll(".type-btn").forEach(b => b.classList.remove("ring-4","ring-blue-300"));
    btn.classList.add("ring-4","ring-blue-300");
    loadDashboard();
  });
});

scanBtn.onclick = () => handleScan(tagInput.value.trim());
tagInput.addEventListener("keydown", e => { if (e.key === "Enter") handleScan(tagInput.value.trim()); });

async function handleScan(tagId) {
  if (!tagId) return;
  try {
    statusEl.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
    scanBtn.disabled = tagInput.disabled = true;
    const resp = await fetch(FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_KEY}` },
      body: JSON.stringify({ tag_id: tagId })
    });
    const result = await resp.json();
    if (result.error) statusEl.innerHTML = `‚ùå ${result.error}`;
    else if (result.message) statusEl.innerHTML = `üèÅ ${result.message}`;
    else statusEl.innerHTML = `‚úÖ ${result.runner} ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${result.lap}`;
    tagInput.value = "";
    loadDashboard();
  } catch (err) {
    statusEl.textContent = "‚ùå Error: " + err.message;
  } finally {
    scanBtn.disabled = tagInput.disabled = false;
    tagInput.focus();
  }
}

function formatDuration(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;
}

async function loadDashboard() {
  const { data: runners, error } = await supabase
    .from("runner")
    .select("id,name,tag_id,type,status,record(lap,start_time,finish_time)")
    .eq("type", currentType);

  if (error) return console.error(error);

  const ranking = runners.map(r => {
    let totalTime = 0, completedLaps = 0;
    (r.record || []).forEach(rec => {
      if (rec.start_time && rec.finish_time) {
        totalTime += new Date(rec.finish_time) - new Date(rec.start_time);
        completedLaps++;
      }
    });
    return { ...r, totalTime, completedLaps };
  });

  const finished = ranking.filter(r => r.completedLaps >= 4).sort((a,b)=>a.totalTime-b.totalTime);
  const unfinished = ranking.filter(r => r.completedLaps < 4).sort((a,b)=>b.completedLaps-a.completedLaps);
  const finalList = [...finished, ...unfinished];
  renderRunners(finalList);
}

function renderRunners(list) {
  runnerList.innerHTML = "";
  list.forEach((r, i) => {
    const distance = (r.completedLaps * 6.3).toFixed(2);
    const totalTimeText = r.totalTime ? formatDuration(r.totalTime) : "-";
    const card = document.createElement("div");
    card.className = `bg-white rounded-lg shadow p-3 ${r.status==="FINISHER"?"border-l-4 border-green-500":r.status==="DNF"?"border-l-4 border-red-500":""} ${r.completedLaps>=4?"blink-slow":""}`;
    card.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold text-blue-700">${i+1}. ${r.name}</div>
          <div class="text-xs text-gray-500">Tag: ${r.tag_id||"-"} ‚Ä¢ ${r.type}</div>
        </div>
        <div class="text-right text-sm">
          <div>${totalTimeText}</div>
          <div class="text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 text-xs mt-2">
        <span class="px-2 py-1 bg-gray-50 rounded">‡∏£‡∏≠‡∏ö ${r.completedLaps}/4</span>
        <span class="px-2 py-1 bg-gray-50 rounded">${distance} ‡∏Å‡∏°.</span>
        <span class="px-2 py-1 rounded ${r.status==='FINISHER'?'bg-green-100 text-green-800':r.status==='DNF'?'bg-red-100 text-red-800':'bg-yellow-50 text-yellow-800'}">${r.status}</span>
      </div>
      <button class="mt-3 w-full bg-gray-100 text-gray-700 py-2 rounded detail-btn">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
    `;
    card.querySelector(".detail-btn").onclick = () => showModal(r);
    runnerList.appendChild(card);
  });
}

// Modal
closeModal.onclick = () => modal.style.display = "none";

function showModal(runner) {
  modal.style.display = "flex";
  modalTitle.textContent = `${runner.name} (${runner.type})`;
  const totalDur = formatDuration(runner.totalTime || 0);
  const distance = (runner.completedLaps * 6.3).toFixed(2);
  modalSummary.innerHTML = `
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${runner.status}</b> |
    ‡∏£‡∏≠‡∏ö: <b>${runner.completedLaps}</b> |
    ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <b>${distance} ‡∏Å‡∏°.</b> |
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: <b>${totalDur}</b>
  `;
  const laps = (runner.record||[]).filter(rec => rec.lap > 0).sort((a,b)=>a.lap-b.lap);
  modalContent.innerHTML = "";
  let totalLapTime = 0, count = 0;
  laps.forEach(rec => {
    if (rec.start_time && rec.finish_time) {
      const diff = new Date(rec.finish_time) - new Date(rec.start_time);
      totalLapTime += diff; count++;
    }
    modalContent.innerHTML += `
      <tr>
        <td class="p-2 text-center">${rec.lap}</td>
        <td class="p-2 text-center">${rec.start_time ? new Date(rec.start_time).toLocaleTimeString("th-TH") : "-"}</td>
        <td class="p-2 text-center">${rec.finish_time ? new Date(rec.finish_time).toLocaleTimeString("th-TH") : "-"}</td>
        <td class="p-2 text-center">${rec.start_time && rec.finish_time ? formatDuration(new Date(rec.finish_time)-new Date(rec.start_time)) : "-"}</td>
      </tr>
    `;
  });
  if (count > 0) {
    avgTime.textContent = `‚è± ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatDuration(totalLapTime / count)} (‡∏à‡∏≤‡∏Å ${count} ‡∏£‡∏≠‡∏ö)`;
  } else {
    avgTime.textContent = "";
  }
}

loadDashboard();
supabase.channel("record-changes")
  .on("postgres_changes",{event:"*",schema:"public",table:"record"},()=>loadDashboard())
  .subscribe();
setInterval(loadDashboard,12000);
</script>
</body>
</html>
