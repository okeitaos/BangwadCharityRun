<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Block / Unblock Photographer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-6">
<h1 class="text-3xl font-bold text-yellow-400 mb-6">üì∏ Admin ‚Äî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û (Block / Unblock)</h1>
<div id="photographerList" class="grid gap-4"></div>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function loadPhotographers() {
  const { data, error } = await sb
    .from("photographer_registration")
    .select("user_id, prefix, first_name, last_name, is_blocked, picture_url")
    .order("first_name", { ascending: true });

  if (error) {
    console.error(error);
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  const container = document.getElementById("photographerList");
  container.innerHTML = "";

  data.forEach(p => {
    const card = document.createElement("div");
    card.className = "flex items-center bg-slate-800 p-4 rounded-xl shadow-lg";

    card.innerHTML = `
      <img src=\"${p.picture_url || 'https://via.placeholder.com/80'}\" class=\"w-16 h-16 rounded-full border-2 border-yellow-400\"> 
      <div class="ml-4 flex-1">
        <div class="text-lg font-semibold">${p.prefix}${p.first_name} ${p.last_name}</div>
        <div class="text-sm text-slate-300">UserID: ${p.user_id}</div>
        <div class="mt-1 ${p.is_blocked ? 'text-red-400' : 'text-green-400'}">${p.is_blocked ? 'üî¥ Blocked' : 'üü¢ Active'}</div>
      </div>
      <button onclick="toggleBlock('${p.user_id}', ${p.is_blocked})" class="px-4 py-2 rounded-lg font-bold text-white ${p.is_blocked ? 'bg-green-600' : 'bg-red-600'}">${p.is_blocked ? 'Unblock' : 'Block'}</button>
      <button onclick=\"deletePhotographer('${p.user_id}')\" class=\"ml-2 px-4 py-2 rounded-lg font-bold text-white bg-red-700\">‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button onclick=\"hardDeletePhotographer('${p.user_id}')\" class=\"ml-2 px-4 py-2 rounded-lg font-bold text-white bg-red-900\">‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</button>('${p.user_id}')\" class=\"ml-2 px-4 py-2 rounded-lg font-bold text-white bg-red-700\">‡∏•‡∏ö</button>
    `;

    container.appendChild(card);
  });
}

async function toggleBlock(userId, currentStatus) {
  const newStatus = !currentStatus;
  const { error } = await sb
    .from("photographer_registration")
    .update({ is_blocked: newStatus })
    .eq("user_id", userId);

  if (error) {
    console.error(error);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ");
    return;
  }

  loadPhotographers();
}

async function hardDeletePhotographer(userId) {
  if (!confirm(`‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û UserID: ${userId} ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  const { error } = await sb
    .from("photographer_registration")
    .delete()
    .eq("user_id", userId);

  if (error) {
    console.error(error);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ");
    return;
  }

  alert("‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Hard Delete)");
  loadPhotographers();
}

async function deletePhotographer(userId) {
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û UserID: ${userId} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  // 1) Soft Delete: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ deleted_at
  const { error: softErr } = await sb
    .from("photographer_registration")
    .update({ is_deleted: true, deleted_at: new Date().toISOString() })
    .eq("user_id", userId);

  if (softErr) {
    console.error(softErr);
    alert("Soft delete ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    return;
  }

  // 2) ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô file_hashes
  await sb.from("file_hashes").delete().eq("user_id", userId);

  // 3) ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô faces
  await sb.from("faces").delete().like("image_url", `${userId}/%`);

  // 4) ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Supabase Storage
  const { data: files } = await sb.storage.from("gallery").list(`${userId}/`, { limit: 10000 });
  if (files && files.length > 0) {
    const removePaths = files.map(f => `${userId}/${f.name}`);
    await sb.storage.from("gallery").remove(removePaths);
  }

  alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Soft Delete)");
  loadPhotographers();
}
}

loadPhotographers();
</script>
</body>
</html>
