<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Manage Photographers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-6">
<h1 class="text-3xl font-bold text-yellow-400 mb-8 text-center">üì∏ Admin ‚Äî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>
<div id="photographerList" class="grid gap-6 max-w-4xl mx-auto"></div>
<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function loadPhotographers() {
  const { data, error } = await sb
    .from("photographer_registration")
    .select("user_id, prefix, first_name, last_name, is_blocked, picture_url")
    .order("first_name", { ascending: true });

  if (error) {
    console.error(error);
    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  const container = document.getElementById("photographerList");
  container.innerHTML = "";

  data.forEach(p => {
    const card = document.createElement("div");
    card.className = "flex items-center bg-slate-800 p-5 rounded-2xl shadow-lg border border-slate-700 hover:shadow-2xl transition";

    card.innerHTML = `
      <img src="${p.picture_url || 'https://via.placeholder.com/80'}"
           class="w-20 h-20 rounded-full border-4 border-yellow-400 shadow-md object-cover">

      <div class="ml-5 flex-1">
        <div class="text-xl font-semibold">${p.prefix}${p.first_name} ${p.last_name}</div>
        <div class="text-sm text-slate-300">UserID: ${p.user_id}</div>
        <div class="mt-1 ${p.is_blocked ? 'text-red-400' : 'text-green-400'} text-lg font-bold">
          ${p.is_blocked ? 'üî¥ Blocked' : 'üü¢ Active'}
        </div>
      </div>

      <div class="flex flex-col gap-2 text-right">
        <button onclick="toggleBlock('${p.user_id}', ${p.is_blocked})"
          class="px-4 py-2 rounded-lg font-bold text-white ${p.is_blocked ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}">
          ${p.is_blocked ? 'Unblock' : 'Block'}
        </button>

        <button onclick="deletePhotographer('${p.user_id}')"
          class="px-4 py-2 rounded-lg font-bold text-white bg-red-700 hover:bg-red-600">
          ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>

        <button onclick="hardDeletePhotographer('${p.user_id}')"
          class="px-4 py-2 rounded-lg font-bold text-white bg-red-900 hover:bg-red-800">
          ‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û
        </button>
      </div>
    `;

    container.appendChild(card);
  });
}

async function toggleBlock(userId, currentStatus) {
  const newStatus = !currentStatus;
  const { error } = await sb
    .from("photographer_registration")
    .update({ is_blocked: newStatus })
    .eq("user_id", userId);

  if (error) {
    console.error(error);
    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  loadPhotographers();
}

async function deletePhotographer(userId) {
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á User: ${userId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  await sb.from("file_hashes").delete().eq("user_id", userId);
  await sb.from("faces").delete().like("image_url", `${userId}/%`);

  const { data: files } = await sb.storage.from("gallery").list(`${userId}/`, { limit: 10000 });
  if (files && files.length > 0) {
    const removePaths = files.map(f => `${userId}/${f.name}`);
    await sb.storage.from("gallery").remove(removePaths);
  }

  alert("‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}

async function hardDeletePhotographer(userId) {
  if (!confirm(`‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û *‡∏ñ‡∏≤‡∏ß‡∏£* ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\nUserID: ${userId}`)) return;

  const { error } = await sb
    .from("photographer_registration")
    .delete()
    .eq("user_id", userId);

  if (error) {
    console.error(error);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ");
    return;
  }

  alert("‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Hard Delete)");
  loadPhotographers();
}

loadPhotographers();
</script>
</body>
</html>
