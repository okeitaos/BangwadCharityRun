<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û | Bangwad Charity Run</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #facc15;
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.4);
      margin-bottom: 20px;
    }

    #profileSection {
      text-align: center;
      margin-bottom: 10px;
    }

    form {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      display: none; /* ‚ùó ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô */
      flex-direction: column;
      align-items: center;
      gap: 15px;
      animation: fadeIn 0.6s ease;
    }

    select, input, button {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-size: 1rem;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    button {
      background: linear-gradient(90deg, #06C755, #00B900);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }

    button.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .loader {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }

    #status {
      margin-top: 15px;
      color: #facc15;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    #status.show {
      opacity: 1;
    }

    img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid #facc15;
      margin-bottom: 10px;
    }

    .readonly-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      margin-top: 15px;
      max-width: 400px;
      text-align: left;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      animation: fadeIn 0.6s ease;
    }

    .readonly-info p {
      margin: 5px 0;
      font-size: 1rem;
    }

    .status {
      color: #facc15;
      font-weight: bold;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>

  <div id="profileSection"></div>

  <form id="registerForm">
    <select id="prefix" required>
      <option value="">-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ --</option>
      <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
      <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select>

    <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required />
    <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required />
    <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required readonly />

    <button type="submit" id="submitBtn">üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  </form>

  <div id="registeredInfo" class="readonly-info" style="display:none;"></div>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <script>
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const LIFF_ID = "2001781240-2Px6N01b";

  let userId = "", displayName = "", pictureUrl = "", email = "";

  async function main() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) return liff.login();

    const statusBox = document.getElementById("status");
    statusBox.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE...";
    statusBox.classList.add("show");

    let profile, decoded;

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤ ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    try {
      profile = await liff.getProfile();
      decoded = liff.getDecodedIDToken();
    } catch (err) {
      statusBox.innerText = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤";
      return;
    }

    userId = profile?.userId || "";
    displayName = profile?.displayName || "";
    pictureUrl = profile?.pictureUrl || "";
    email = decoded?.email || "";

    // ‚ùó ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    if (!userId || !displayName || !pictureUrl) {
      statusBox.innerText = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤";
      return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
    document.getElementById("profileSection").innerHTML = `
      <img src="${pictureUrl}" alt="Profile">
      <p><b>${displayName}</b></p>
    `;

    document.getElementById("email").value = email;

    // üîì ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    document.getElementById("registerForm").style.display = "flex";

    const { data } = await sb
      .from("photographer_registration")
      .select("*")
      .eq("user_id", userId)
      .maybeSingle();

    if (data) {
      showRegisteredInfo(data);
    } else {
      statusBox.innerText = "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
    }
  }

  function showRegisteredInfo(data) {
    document.getElementById("registerForm").style.display = "none";
    document.getElementById("registeredInfo").style.display = "block";

    document.getElementById("registeredInfo").innerHTML = `
      <p><b>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</b> ${data.prefix}</p>
      <p><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${data.first_name}</p>
      <p><b>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</b> ${data.last_name}</p>
      <p class="status"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${data.status}</p>
    `;

    const statusBox = document.getElementById("status");
    statusBox.innerText = "‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
  }

  async function notifyTelegram(data) {
    try {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/notify_telegram`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
        },
        body: JSON.stringify(data),
      });
      console.log(await res.json());
    } catch (err) {
      console.error("‚ùå Error notifying Telegram:", err);
    }
  }

  document.getElementById("registerForm").onsubmit = async (e) => {
    e.preventDefault();

    const prefix = document.getElementById("prefix").value;
    const first_name = document.getElementById("firstName").value.trim();
    const last_name = document.getElementById("lastName").value.trim();
    const statusBox = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");

    submitBtn.classList.add("loading");
    submitBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... <span class="loader"></span>';
    statusBox.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...";
    statusBox.classList.add("show");

    const insertData = {
      user_id: userId,
      display_name: displayName,
      picture_url: pictureUrl,
      email,
      prefix,
      first_name,
      last_name,
      status: "pending",
    };

    const { error } = await sb
      .from("photographer_registration")
      .insert(insertData);

    if (error) {
      statusBox.innerText = "‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)";
      submitBtn.classList.remove("loading");
      submitBtn.innerText = "üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
      return;
    }

    await notifyTelegram(insertData);

    statusBox.innerText = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•...";
    setTimeout(() => {
      showRegisteredInfo(insertData);
      submitBtn.classList.remove("loading");
      submitBtn.innerText = "üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
    }, 1000);
  };

  main();
  </script>
</body>
</html>
