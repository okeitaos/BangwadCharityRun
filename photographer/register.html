<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û | BCR GALLERY</title>

<!-- LINE LIFF & Supabase -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Prompt", sans-serif;
    background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
    color: #fff;
    text-align: center;
    padding: 30px;
    min-height: 100vh;
  }

  h1 {
    color: #facc15;
    text-shadow: 0 0 10px rgba(250,204,21,0.5);
    margin-bottom: 10px;
  }

  #profile img {
    width: 90px; height: 90px; border-radius: 50%;
    border: 3px solid #facc15; margin-bottom: 10px;
  }

  input, select {
    width: 90%; max-width: 400px;
    padding: 12px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: #fff; margin: 8px auto;
    font-size: 1rem; display: block; text-align: center;
  }

  input::placeholder { color: #ccc; }

  button {
    background: linear-gradient(90deg, #06C755, #00B900);
    border: none; color: #fff; font-weight: bold;
    padding: 12px 25px; border-radius: 25px;
    margin-top: 15px; cursor: pointer; transition: 0.3s;
  }

  button:hover { transform: scale(1.05); opacity: 0.9; }
  #status { margin-top: 15px; font-weight: 600; color: #facc15; }
  .disabled { opacity: 0.4; pointer-events: none; }
</style>
</head>
<body>
  <h1>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>
  <div id="profile"></div>

  <form id="registerForm">
    <select id="prefix" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
      <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
      <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
    </select>

    <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
    <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
    <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)" required>

    <button type="submit" id="submitBtn">üì© ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  </form>

  <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const LIFF_ID = "2001781240-2Px6N01b";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = "", displayName = "", pictureUrl = "", email = "";

async function main() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) return liff.login();

    const profile = await liff.getProfile();
    userId = profile.userId;
    displayName = profile.displayName;
    pictureUrl = profile.pictureUrl;
    email = (await liff.getDecodedIDToken())?.email || "";

    document.getElementById("profile").innerHTML = `
      <img src="${pictureUrl}" alt="Profile Picture">
      <p><b>${displayName}</b></p>
    `;
    document.getElementById("email").value = email || "";

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥
    const { data: exist } = await sb.from("photographer_registration")
      .select("status").eq("user_id", userId).maybeSingle();

    if (exist?.status === "approved") {
      document.getElementById("status").innerText = "‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß";
      document.getElementById("submitBtn").classList.add("disabled");
      return;
    } else if (exist?.status === "pending") {
      document.getElementById("status").innerText = "‚åõ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö";
      document.getElementById("submitBtn").classList.add("disabled");
      return;
    }

    document.getElementById("status").innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE";
  }
}

main();

// üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô + ‡πÅ‡∏à‡πâ‡∏á Edge Function
document.getElementById("registerForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const prefix = document.getElementById("prefix").value;
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const emailInput = document.getElementById("email").value.trim();

  document.getElementById("status").innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

  const { error } = await sb.from("photographer_registration").upsert({
    user_id: userId,
    display_name: displayName,
    picture_url: pictureUrl,
    email: emailInput,
    prefix,
    first_name: firstName,
    last_name: lastName,
    status: "pending"
  });

  if (error) {
    document.getElementById("status").innerText = "‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(error);
    return;
  }

  // üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Edge Function ‡πÅ‡∏à‡πâ‡∏á Telegram
  const text = `
üÜï *‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà*
üë§ ${prefix}${firstName} ${lastName}
üìß ${emailInput}
üì± ${displayName}
ü™™ ${userId}
‚è∞ ${new Date().toLocaleString("th-TH")}
`;

  try {
    await fetch(`${SUPABASE_URL}/functions/v1/notify_telegram`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "apikey": SUPABASE_KEY
      },
      body: JSON.stringify({ text })
    });
  } catch (err) {
    console.warn("‚ö†Ô∏è ‡∏™‡πà‡∏á Telegram ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
  }

  document.getElementById("status").innerText = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
  document.getElementById("submitBtn").classList.add("disabled");
});
</script>
</body>
</html>
