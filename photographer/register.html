<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û | Bangwad Charity Run</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      color: #facc15;
      text-shadow: 0 0 10px rgba(250,204,21,0.4);
    }

    form {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 25px;
      max-width: 400px;
      margin: 20px auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    input, select, button {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 1rem;
    }

    input, select {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    button {
      background: linear-gradient(90deg, #06C755, #00B900);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover { opacity: 0.9; }

    #status {
      margin-top: 15px;
      color: #facc15;
      font-weight: bold;
    }

    img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid #facc15;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>

  <div id="profileSection"></div>

  <form id="registerForm">
    <select id="prefix" required>
      <option value="">-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ --</option>
      <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
      <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select>

    <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required />
    <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required />
    <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required />

    <button type="submit">üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  </form>

  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <script>
  const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const LIFF_ID = "2001781240-k2PJ3Ap2";

  let userId = "", displayName = "", pictureUrl = "";

  async function main() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) return liff.login();

    const profile = await liff.getProfile();
    userId = profile.userId;
    displayName = profile.displayName;
    pictureUrl = profile.pictureUrl;

    document.getElementById("profileSection").innerHTML = `
      <img src="${pictureUrl}" alt="Profile">
      <p><b>${displayName}</b></p>
    `;

    document.getElementById("status").innerText = "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
  }

  main();

  // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
  async function notifyTelegram(data) {
    try {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/notify_telegram`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      console.log("üì® Telegram notify:", result);
    } catch (err) {
      console.error("‚ùå Error notifying Telegram:", err);
    }
  }

  // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  document.getElementById("registerForm").onsubmit = async (e) => {
    e.preventDefault();

    const prefix = document.getElementById("prefix").value;
    const first_name = document.getElementById("firstName").value.trim();
    const last_name = document.getElementById("lastName").value.trim();
    const email = document.getElementById("email").value.trim();

    const statusBox = document.getElementById("status");
    statusBox.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...";

    const insertData = {
      user_id: userId,
      display_name: displayName,
      picture_url: pictureUrl,
      email,
      prefix,
      first_name,
      last_name,
      status: "pending"
    };

    const { error } = await sb
      .from("photographer_registration")
      .insert(insertData);

    if (error) {
      console.error("‚ùå Insert Error:", error);
      statusBox.innerText = "‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)";
      return;
    }

    // ‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
    await notifyTelegram(insertData);

    statusBox.innerText = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏≤‡∏á Telegram ‡πÅ‡∏•‡πâ‡∏ß";
    document.getElementById("registerForm").reset();
  };
  </script>
</body>
</html>
