<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: "Prompt", sans-serif; background: #0f172a; color: #fff; text-align: center; padding: 20px; }
  input, select { padding: 10px; border-radius: 8px; border: none; margin: 8px; width: 80%; max-width: 400px; }
  button { padding: 10px 20px; border-radius: 25px; border: none; color: #fff; background: #06C755; cursor: pointer; margin-top: 10px; }
  button:hover { background: #00B900; }
</style>
</head>
<body>
<h1>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>
<form id="registerForm">
  <div id="profileInfo"></div>
  <select id="prefix" required>
    <option value="">-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ --</option>
    <option>‡∏ô‡∏≤‡∏¢</option>
    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    <option>‡∏ô‡∏≤‡∏á</option>
  </select><br>
  <input type="text" id="first_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required><br>
  <input type="text" id="last_name" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required><br>
  <button type="submit">üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
</form>
<p id="status"></p>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const LIFF_ID = "2001781240-2Px6N01b";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = "", displayName = "", pictureUrl = "", email = "";

async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) return liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  displayName = profile.displayName;
  pictureUrl = profile.pictureUrl || "";
  email = (await liff.getDecodedIDToken()).email || "";

  document.getElementById("profileInfo").innerHTML = `
    <img src="${pictureUrl}" width="80" style="border-radius:50%;border:2px solid #facc15;"><br>
    <b>${displayName}</b><br>
    <small>${email}</small><br><br>
  `;
}
init();

document.getElementById("registerForm").onsubmit = async (e) => {
  e.preventDefault();
  const prefix = prefix.value;
  const first_name = first_name.value.trim();
  const last_name = last_name.value.trim();
  const statusText = document.getElementById("status");
  statusText.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const { error } = await sb.from("photographer_registration").insert([{
    user_id: userId,
    display_name: displayName,
    picture_url: pictureUrl,
    email,
    prefix,
    first_name,
    last_name,
    status: "pending"
  }]);

  if (error && error.code === "23505") {
    statusText.innerText = "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
    return;
  }

  // üîî ‡πÅ‡∏à‡πâ‡∏á Telegram
  await fetch(`${SUPABASE_URL}/functions/v1/notify_telegram`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId, display_name, picture_url: pictureUrl, email, prefix, first_name, last_name })
  });

  statusText.innerText = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
};
</script>
</body>
</html>
