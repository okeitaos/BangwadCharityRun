<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û | BCR RUN</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff;
      text-align: center;
      padding: 25px;
    }
    h1 {
      color: #facc15;
      text-shadow: 0 0 10px rgba(250,204,21,0.5);
    }
    form {
      background: rgba(255,255,255,0.08);
      padding: 20px;
      border-radius: 15px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    input, select {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(255,255,255,0.08);
      color: #fff;
    }
    button {
      background: linear-gradient(90deg, #06C755, #00B900);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { opacity: 0.9; }
    #status { margin-top: 15px; font-weight: bold; color: #facc15; }
    img { width: 100px; border-radius: 50%; margin-top: 10px; border: 3px solid #facc15; }
  </style>
</head>
<body>
  <h1>üì∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</h1>
  <div id="profile"></div>

  <form id="registerForm">
    <select id="prefix" required>
      <option value="">-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ --</option>
      <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
      <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select>
    <input type="text" id="first_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
    <input type="text" id="last_name" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
    <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LINE)" readonly>
    <button type="submit">üì§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    <p id="status"></p>
  </form>

<script>
const SUPABASE_URL = "https://xjdjurdflowiwdxgkvfr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqZGp1cmRmbG93aXdkeGdrdmZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDk5OTEsImV4cCI6MjA2OTg4NTk5MX0.QtWt1IrY1UYKmj0spL3T8CkaQh9wq2P-_4b6eWB3ics";
const LIFF_ID = "2001781240-2Px6N01b";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = "", displayName = "", pictureUrl = "", email = "";

window.onload = async () => {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) return liff.login();

  const profile = await liff.getProfile();
  userId = profile.userId;
  displayName = profile.displayName;
  pictureUrl = profile.pictureUrl || "";
  email = liff.getDecodedIDToken()?.email || "";

  document.getElementById("profile").innerHTML = `
    <img src="${pictureUrl}" alt="profile">
    <p><b>${displayName}</b></p>
  `;
  document.getElementById("email").value = email || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å LINE";

  checkExistingRegistration();
};

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
async function checkExistingRegistration() {
  const { data } = await sb.from("photographer_registration").select("*").eq("user_id", userId).maybeSingle();
  if (data) {
    document.getElementById("registerForm").innerHTML = `
      <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span style="color:${data.status === 'approved' ? '#22c55e' : '#facc15'}">${data.status}</span></h3>
      <p>${data.prefix || ''} ${data.first_name || ''} ${data.last_name || ''}</p>
      <p>üìß ${data.email || '-'}</p>
    `;
  }
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
document.getElementById("registerForm").onsubmit = async (e) => {
  e.preventDefault();

  const prefixVal = document.getElementById("prefix").value;
  const first_nameVal = document.getElementById("first_name").value.trim();
  const last_nameVal = document.getElementById("last_name").value.trim();
  const statusText = document.getElementById("status");

  statusText.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const { error } = await sb.from("photographer_registration").insert([{
    user_id: userId,
    display_name: displayName,
    picture_url: pictureUrl,
    email,
    prefix: prefixVal,
    first_name: first_nameVal,
    last_name: last_nameVal,
    status: "pending"
  }]);

  if (error && error.code === "23505") {
    statusText.innerText = "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
    return;
  }

  // üîî ‡πÅ‡∏à‡πâ‡∏á Telegram ‡∏ú‡πà‡∏≤‡∏ô Edge Function
  await fetch(`${SUPABASE_URL}/functions/v1/notify_telegram`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: userId,
      display_name: displayName,
      picture_url: pictureUrl,
      email,
      prefix: prefixVal,
      first_name: first_nameVal,
      last_name: last_nameVal
    })
  });

  statusText.innerText = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
  setTimeout(() => location.reload(), 2000);
};
</script>
</body>
</html>
